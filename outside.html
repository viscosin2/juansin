<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
<title>Juansin - visor con lupa (solo D-pad)</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height:100%; margin:0; background:#111; display:flex; justify-content:center; align-items:center; }
  .gameboy { width:100%; max-width:500px; height:100%; background:#000; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.6); }
  .screen-container { flex:1; display:flex; justify-content:center; align-items:center; background:#0B0A21; border-radius:12px; padding:10px; }
  .screen { aspect-ratio:1/1; width:100%; background:#0B0A21; display:flex; justify-content:center; align-items:center; border-radius:8px; overflow:hidden; position:relative; box-shadow:inset 0 0 20px rgba(0,0,0,.6); }
  canvas { width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges; background:black; }

  .controls { height:40%; background:#0B0A21; display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:14px; box-sizing:border-box; }
  .dpad { display:grid; grid-template-columns:repeat(3,64px); grid-template-rows:repeat(3,64px); justify-content:center; margin-left:12px; align-content:center; }
  .img-btn{ border:none; outline:none; padding:0; background:transparent; cursor:pointer; width:64px; height:64px; filter:drop-shadow(0 3px 4px rgba(0,0,0,.85)); -webkit-tap-highlight-color:transparent; }
  .img-btn.arrow::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering:pixelated; transform:rotate(var(--rot,0deg)) scale(1.28); }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width:120px; height:120px; margin-top:45px; justify-self:center; opacity:.35; pointer-events:none; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering:pixelated; }
  .img-btn:active{ transform:scale(.95); filter:brightness(.9); }

  .boot-mask{ position:absolute; inset:0; background:#000; z-index:1000; opacity:1; transition:opacity .25s ease; }
  .boot-mask.hidden{ opacity:0; pointer-events:none; }
</style>
</head>
<body>
<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>
    </div>
  </div>

  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act"></button>
  </div>
</div>

<script>
const BACKGROUND_SRC = "assets/locations/outside.png";
const roomOriginal   = { w:512, h:350 };
const ZOOM           = 2.0;
const PLAYER_SPEED   = 220;
const PLAYER_SIZE    = 16;

const canvas = document.getElementById('game');
const ctx    = canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled = false;

const keys = { up:false, down:false, left:false, right:false };
function bindHold(btn, on, off){
  const start=e=>{e.preventDefault();on();btn.classList.add('pressed');};
  const end  =e=>{e.preventDefault();off();btn.classList.remove('pressed');};
  btn.addEventListener('touchstart',start,{passive:false});
  btn.addEventListener('touchend',end,{passive:false});
  btn.addEventListener('touchcancel',end,{passive:false});
  btn.addEventListener('mousedown',start);
  window.addEventListener('mouseup',end);
}
bindHold(document.getElementById('btn-up'),   ()=>keys.up=true,   ()=>keys.up=false);
bindHold(document.getElementById('btn-down'), ()=>keys.down=true, ()=>keys.down=false);
bindHold(document.getElementById('btn-left'), ()=>keys.left=true, ()=>keys.left=false);
bindHold(document.getElementById('btn-right'),()=>keys.right=true,()=>keys.right=false);

const world={img:null,w:0,h:0};
const player={x:0,y:0};

const bgImg=new Image();
bgImg.onload=()=>{
  world.img=bgImg; world.w=bgImg.naturalWidth; world.h=bgImg.naturalHeight;
  player.x=world.w/2; player.y=world.h/2;
  document.getElementById('bootMask').classList.add('hidden');
  resizeCanvas(); requestAnimationFrame(loop);
};
bgImg.src=BACKGROUND_SRC;

let vp={dx:0,dy:0,dw:0,dh:0,k:1};
function resizeCanvas(){
  const screen=document.querySelector('.screen');
  canvas.width=screen.clientWidth; canvas.height=screen.clientHeight;
  const k=Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
  vp.dw=Math.round(roomOriginal.w*k);
  vp.dh=Math.round(roomOriginal.h*k);
  vp.dx=Math.round((canvas.width-vp.dw)/2);
  vp.dy=Math.round((canvas.height-vp.dh)/2);
  vp.k=k;
}
window.addEventListener('resize',resizeCanvas);

let last=0;
function loop(t){
  if(!last) last=t; const dt=Math.min(1/30,(t-last)/1000); last=t;
  update(dt); draw(); requestAnimationFrame(loop);
}
function update(dt){
  let vx=(keys.left?-1:0)+(keys.right?1:0);
  let vy=(keys.up?-1:0)+(keys.down?1:0);
  if(vx&&vy){const inv=1/Math.sqrt(2);vx*=inv;vy*=inv;}
  player.x+=vx*PLAYER_SPEED*dt; player.y+=vy*PLAYER_SPEED*dt;
  const halfW=roomOriginal.w/ZOOM/2, halfH=roomOriginal.h/ZOOM/2;
  player.x=Math.max(halfW,Math.min(world.w-halfW,player.x));
  player.y=Math.max(halfH,Math.min(world.h-halfH,player.y));
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!world.img) return;
  let sx=player.x-roomOriginal.w/ZOOM/2;
  let sy=player.y-roomOriginal.h/ZOOM/2;
  const sw=roomOriginal.w/ZOOM, sh=roomOriginal.h/ZOOM;
  sx=Math.max(0,Math.min(world.w-sw,sx));
  sy=Math.max(0,Math.min(world.h-sh,sy));
  ctx.drawImage(world.img,sx,sy,sw,sh,vp.dx,vp.dy,vp.dw,vp.dh);
  const px=vp.dx+Math.round((player.x-sx)*ZOOM*vp.k);
  const py=vp.dy+Math.round((player.y-sy)*ZOOM*vp.k);
  const r=Math.max(2,Math.round((PLAYER_SIZE/2)*vp.k));
  ctx.fillStyle='#ffd400'; ctx.strokeStyle='#222'; ctx.lineWidth=Math.max(1,Math.round(2*vp.k));
  ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle='rgba(0,0,0,.28)'; ctx.beginPath();
  ctx.ellipse(px,py+r/2,Math.round(r*0.8),Math.round(r*0.3),0,0,Math.PI*2);
  ctx.fill();
}
</script>
</body>
</html>