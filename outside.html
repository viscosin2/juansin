<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin 30th birthday - outside (cinemática + combate)</title>

<!-- Pixel fonts -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height: 100%; margin: 0; background: #111; display: flex; justify-content: center; align-items: center; }
  .gameboy { width: 100%; max-width: 500px; height: 100%; background: #000; display: flex; flex-direction: column;
    padding: 12px; box-sizing: border-box; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
  .screen-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #0B0A21; border-radius: 12px; padding: 10px; }
  .screen { aspect-ratio: 1/1; width: 100%; background: #0B0A21; display: flex; justify-content: center; align-items: center;
    border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.6); }
  canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; background: black; }

  .controls { height: 40%; background: #0B0A21; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; box-sizing: border-box; }
  .dpad { display: grid; grid-template-columns: repeat(3, 64px); grid-template-rows: repeat(3, 64px); gap: 0; justify-content: center; margin-left: 12px; align-content: center; overflow: visible; }
  .img-btn, .img-act { border: none; outline: none; padding: 0; background: transparent; cursor: pointer; transition: transform 0.06s ease, filter 0.06s ease; -webkit-tap-highlight-color: transparent; }
  .img-btn { width: 64px; height: 64px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.85)); }
  .img-btn.arrow::before { content: ""; display: block; width: 100%; height: 100%; background: url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering: pixelated; transform: rotate(var(--rot, 0deg)) scale(1.28); transform-origin: center center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width: 120px; height: 120px; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.85)); margin-top: 45px; justify-self: center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering: pixelated; transform: scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform: scale(0.95); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)) brightness(0.9); }

  .toast{ position:absolute; top:19px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space: nowrap; pointer-events:none; z-index:5; }
  .toast.show{ opacity:1; }

  /* ===== Estilo de diálogo (igual al que pasaste) ===== */
  .dialog {
    position: absolute;
    left: 50%;
    bottom: 10px;
    transform: translateX(-50%) scaleX(0);
    transform-origin: center bottom;
    width: calc(100% - 24px);
    max-width: 460px;
    min-height: 20px;
    box-sizing: border-box;
    padding: 12px 16px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-radius: 10px;
    image-rendering: pixelated;
    z-index: 6;
    transition: transform .22s ease;
  }
  .dialog.show { transform: translateX(-50%) scaleX(1); }
  .dialog {
    background: rgba(12,12,24,0.9);
    border: none;
    border-top: 2px solid #3cf;
    display: flex;
    align-items: flex-start;
    flex-direction: column;
    padding: 10px;
    text-align: left;
  }
  .dialog-name{
    font-family: 'Press Start 2P', system-ui;
    font-size: 10px;
    color:#8df;
    margin-bottom: 4px;
    text-shadow: 0 1px 0 #000;
  }
  .dialog-text{
    font-family: 'VT323', monospace;
    font-size: 18px;
    letter-spacing: 1px;
    line-height: 1.15;
    color: #E6F6FF;
    min-height: 2.2em;
  }
  .dialog-hint{
    margin-left:auto; border:none !important; color:#B8D7FF;
    font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    opacity:0; transition:opacity .18s ease;
  }
  .dialog.ready .dialog-hint{ opacity:.9; }

  /* ===== Cinemática: overlay con blur/dim (también muestra carga) ===== */
  .cine{
    position:absolute; inset:0; z-index:20; display:none;
    --blur: 0px; --dim: 0;
    backdrop-filter: blur(var(--blur));
    background: rgba(0,0,0,var(--dim));
    transition: backdrop-filter .22s ease, background .22s ease;
  }
  .cine.show{ display:block; }

  .cine-portraits{ position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:space-between; pointer-events:none; }
  .portrait{ width:50%; max-width:500px; position:relative; display:flex; justify-content:center; align-items:flex-end; padding:0 8px 0; }
  .portrait img{
    height:auto; width:auto; max-width:none; image-rendering:pixelated;
    opacity:0; transform: translateX(var(--tx,0)); transition: transform .26s ease, opacity .26s ease;
    margin-bottom: -60px;
    filter: drop-shadow(0 0 18px rgba(0,0,0,.9));
  }
  .portrait.left  img{ --tx:-12%; margin-left: 40px;}
  .portrait.right img{ --tx: 12%; margin-right: 40px;}
  .portrait.show img{ opacity:1; transform:translateX(0); }

  /* Panel de opciones arriba-dcha del diálogo, sin título */
  .choice-panel{
    position:absolute; background: rgba(12,12,24,0.95);
    border:1px solid #3cf; border-radius:8px; z-index:26; display:none;
    min-width:110px; padding:6px; box-shadow:0 6px 14px rgba(0,0,0,.45);
  }
  .choice-panel.show{ display:block; }
  .choices{ display:flex; flex-direction:column; gap:6px; }
  .choice{
    font-family:'VT323', monospace; font-size:16px; color:#E6F6FF;
    padding:4px 8px; text-align:left; border:1px solid transparent; background:transparent; border-radius:4px;
  }
  .choice.selected{ border-color:#8df; background: rgba(60,120,255,.18); }

  .scene-fade{ position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:999; transition:opacity .45s ease; }
  .scene-fade.show{ opacity:1; }

  .boot-mask{ position:absolute; inset:0; background:#000; z-index:1000; opacity:1; transition: opacity .25s ease;}
  .boot-mask.hidden{ opacity:0; pointer-events:none; }

  /* ===== HUD Combate retro ===== */
  .hud{
    position:absolute; top:6px; left:0; right:0; z-index:27; pointer-events:none; display:none;
  }
  .hud.show{ display:block; }
  .hpwrap{
    position:absolute; top:0; width:45%; height:14px;
    border-top:2px solid #444; border-bottom:2px solid #222; border-left:2px solid #222; border-right:2px solid #444;
    background: #111; box-shadow: inset 0 0 0 2px #000;
  }
  .hpwrap.left{ left:8px; }
  .hpwrap.right{ right:8px; }
  .hplabel{
    position:absolute; top:-10px; font-family:'Press Start 2P', system-ui; font-size:8px; letter-spacing:0.5px; color:#9cf;
    text-shadow:0 1px 0 #000;
  }
  .hpwrap.left .hplabel{ left:0; }
  .hpwrap.right .hplabel{ right:0; }
  .hpbar{
    height:100%; width:100%; transform-origin:left center; image-rendering:pixelated;
    background: repeating-linear-gradient(90deg, rgba(255,255,255,.08) 0 4px, transparent 4px 8px);
    position:relative;
  }
  .hpbar::after{
    content:""; position:absolute; inset:1px; background:currentColor; opacity:.8;
  }
  .hpbar.red{ color:#b33; }
  .hpbar.blue{ color:#2c6; } /* azul verdoso retro */
  .hptext{
    position:absolute; top:16px; font-family:'VT323', monospace; font-size:16px; color:#E6F6FF;
  }
  .hpwrap.left .hptext{ left:0; }
  .hpwrap.right .hptext{ right:0; }

  /* Pequeñas animaciones retro */
  @keyframes shake {
    0%,100% { transform: translate(0,0); }
    25% { transform: translate(-3px,1px); }
    50% { transform: translate(3px,-2px); }
    75% { transform: translate(-2px,2px); }
  }
  .shaking { animation: shake 0.18s steps(2,end) 2; }

  @keyframes lungeLeft { from{ transform:translateX(0) } to{ transform:translateX(-18px) } }
  @keyframes lungeRight{ from{ transform:translateX(0) } to{ transform:translateX(18px) } }
  .lunge-left{ animation: lungeLeft .12s steps(2,end); }
  .lunge-right{ animation: lungeRight .12s steps(2,end); }

  @keyframes fallDown { to{ transform: translateY(40px) rotate(2deg); opacity:.0 } }
  .fall { animation: fallDown .45s ease forwards; }
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>

      <div id="toast" class="toast"></div>
      <div id="sceneFade" class="scene-fade"></div>

      <!-- Diálogo in-world (estilo exacto) -->
      <div id="dialog" class="dialog" aria-live="polite">
        <div id="dialogName" class="dialog-name"></div>
        <div id="dialogText" class="dialog-text"></div>
        <div id="dialogHint" class="dialog-hint">→</div>
      </div>

      <!-- CINEMÁTICA -->
      <div id="cine" class="cine">
        <div class="cine-portraits">
          <div id="pOld"   class="portrait left"><img id="imgOld"   alt="Viejo"></div>
          <div id="pJuan"  class="portrait right"><img id="imgJuan"  alt="Juan"></div>
          <div id="pEnemy" class="portrait left"><img id="imgEnemy" alt="Enemigo"></div>
        </div>

        <div id="cineDialog" class="dialog" style="z-index:25; bottom:12px;">
          <div id="cineName" class="dialog-name"></div>
          <div id="cineText" class="dialog-text"></div>
          <div id="cineHint" class="dialog-hint">→</div>
        </div>

        <!-- HUD combate -->
        <div id="hud" class="hud">
          <div id="hpEnemyWrap" class="hpwrap left" aria-label="HP Enemigo">
            <div class="hplabel">ENEMIGO</div>
            <div id="hpEnemyBar" class="hpbar red"></div>
            <div id="hpEnemyTxt" class="hptext"></div>
          </div>
          <div id="hpJuanWrap" class="hpwrap right" aria-label="HP Juan">
            <div class="hplabel">JUAN</div>
            <div id="hpJuanBar" class="hpbar blue"></div>
            <div id="hpJuanTxt" class="hptext"></div>
          </div>
        </div>

        <!-- Opciones (sin título) -->
        <div id="choicePanel" class="choice-panel">
          <div id="choices" class="choices"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles táctiles -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== CONFIG BÁSICA ===== */
const BACKGROUND = "assets/locations/outside.PNG";

/* Sprites player */
const SPRITES_JUAN = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: { down:["assets/juan_character/idle_down_shoes.png"], up:["assets/juan_character/idle_up_shoes.png"], left:["assets/juan_character/idle_left_shoes.png"], right:["assets/juan_character/idle_right_shoes.png"] },
  walk: { down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"], up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"], left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"], right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"] }
};
/* NPCs */
const NPC_GANDALF_IMG = "assets/characters/gandalf.PNG";
const ENEMY_IMG       = "assets/characters/enemy1.PNG";

/* Retratos grandes conversación */
const PORTRAIT_OLD   = "assets/characters/gandalf_big.PNG";
const PORTRAIT_JUAN  = "assets/characters/juansin_big.PNG";
/* Retratos de combate */
const PORTRAIT_JUAN_FIGHT  = "assets/characters/juansin_big_fight.PNG";   // como pediste
const PORTRAIT_ENEMY_FIGHT = "assets/characters/enemy1_big.PNG";           // su pareja

/* Audio */
const bgMusic = new Audio("assets/sounds/ambient1.mp3"); bgMusic.loop = true; bgMusic.volume = 0.35;

/* Canvas */
const roomOriginal = { w: 512, h: 350 };
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

let bgRect={dx:0,dy:0,dw:0,dh:0}, scaleFactor=1;
let bgImg=null, sprites=null, npcGandalfImg=null, enemyImg=null;

const player={ x:0, y:0, speed:230, dir:'down', moving:false, frame:0, frameTime:0 };

/* NPC positions */
const gandalf={ x:0, y:0 };
const enemy1 ={ x:0, y:0, alive:true };

/* ===== INPUT mover (teclas y dpad). Acción SOLO botón/touch ===== */
const keys={ up:false,down:false,left:false,right:false };
const mapKey={ ArrowUp:'up', KeyW:'up', ArrowDown:'down', KeyS:'down', ArrowLeft:'left', KeyA:'left', ArrowRight:'right', KeyD:'right' };
window.addEventListener('keydown', e=>{ const d=mapKey[e.code]; if(d){ keys[d]=true; e.preventDefault(); }});
window.addEventListener('keyup',   e=>{ const d=mapKey[e.code]; if(d){ keys[d]=false; e.preventDefault(); }});

function bindHold(btn,on,off){
  const start=e=>{ e.preventDefault(); on(); };
  const end  =e=>{ e.preventDefault(); off(); };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  window.addEventListener('mouseup', end);
}
bindHold(document.getElementById('btn-up'),    ()=>keys.up=true,    ()=>keys.up=false);
bindHold(document.getElementById('btn-down'),  ()=>keys.down=true,  ()=>keys.down=false);
bindHold(document.getElementById('btn-left'),  ()=>keys.left=true,  ()=>keys.left=false);
bindHold(document.getElementById('btn-right'), ()=>keys.right=true, ()=>keys.right=false);

/* Acción: SOLO botón/touch */
const btnAct=document.getElementById('btn-act');
btnAct.addEventListener('click', e=>{ e.preventDefault(); onAction(); });
btnAct.addEventListener('touchstart', e=>{ e.preventDefault(); onAction(); }, {passive:false});

/* D-pad controla las opciones (no teclado) */
const dpadUp=document.getElementById('btn-up');
const dpadDown=document.getElementById('btn-down');
['click','touchstart'].forEach(evt=>{
  dpadUp.addEventListener(evt, e=>{ if(state.mode==='cine' && state.inChoices){ e.preventDefault(); moveChoice('up'); } }, {passive:false});
  dpadDown.addEventListener(evt, e=>{ if(state.mode==='cine' && state.inChoices){ e.preventDefault(); moveChoice('down'); } }, {passive:false});
});

/* ===== UTIL ===== */
const loadImage = (src)=>new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; });
async function preloadSprites(map){
  const out={ idle:{}, walk:{}, size:map.size, scale:map.scale };
  for(const s of ['idle','walk']) for(const d of Object.keys(map[s])) out[s][d]=await Promise.all(map[s][d].map(loadImage));
  return out;
}

/* ===== DIBUJO ===== */
function resizeCanvas(){
  const screen=document.querySelector('.screen');
  canvas.width=screen.clientWidth; canvas.height=screen.clientHeight;

  if(bgImg){
    scaleFactor = Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
    bgRect.dw = roomOriginal.w*scaleFactor; bgRect.dh = roomOriginal.h*scaleFactor;
    bgRect.dx = (canvas.width - bgRect.dw)/2; bgRect.dy = (canvas.height - bgRect.dh)/2;

    player.x = bgRect.dx + bgRect.dw*0.5;
    player.y = bgRect.dy + bgRect.dh*0.80;

    /* colocación NPCs */
    gandalf.x = bgRect.dx + bgRect.dw*0.52;
    gandalf.y = bgRect.dy + bgRect.dh*0.35;

    enemy1.x  = bgRect.dx + bgRect.dw*0.30;  /* otro rincón del mapa */
    enemy1.y  = bgRect.dy + bgRect.dh*0.58;
  }
  if(cineVisible) sizePortraitsToBackground();
  if(choicePanel.classList.contains('show')) positionChoices();
}
window.addEventListener('resize', resizeCanvas);

function update(dt){
  if(state.mode!=='play') return;
  const vx=(keys.left?-1:0)+(keys.right?1:0);
  const vy=(keys.up?-1:0)+(keys.down?1:0);
  player.moving=(vx!==0||vy!==0);

  if(player.moving){
    player.dir = Math.abs(vx) > Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len = Math.hypot(vx,vy)||1;
    player.x += (vx/len)*player.speed*dt;
    player.y += (vy/len)*player.speed*dt;

    const halfW=Math.round(sprites.size.w*sprites.scale)/2;
    const halfH=Math.round(sprites.size.h*sprites.scale)/2;
    const minX=bgRect.dx+halfW, maxX=bgRect.dx+bgRect.dw-halfW;
    const minY=bgRect.dy+halfH, maxY=bgRect.dy+bgRect.dh-halfH;
    player.x=Math.max(minX,Math.min(maxX,player.x));
    player.y=Math.max(minY,Math.min(maxY,player.y));

    player.frameTime+=dt;
    if(player.frameTime>=0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else player.frame=0;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!bgImg) return;

  ctx.drawImage(bgImg, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);

  const things=[];

  /* NPCs con sombras */
  if(enemy1.alive){
    things.push({ y:enemy1.y, draw:()=>{
      const w=36,h=40,s=0.9; const dw=Math.round(w*s), dh=Math.round(h*s);
      ctx.fillStyle='rgba(0,0,0,0.28)'; ctx.beginPath();
      ctx.ellipse(Math.round(enemy1.x), Math.round(enemy1.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
      ctx.drawImage(enemyImg, Math.round(enemy1.x-dw/2), Math.round(enemy1.y-dh/2), dw, dh);
    }});
  }

  things.push({ y:gandalf.y, draw:()=>{
    const w=36,h=40,s=0.9; const dw=Math.round(w*s), dh=Math.round(h*s);
    ctx.fillStyle='rgba(0,0,0,0.28)'; ctx.beginPath();
    ctx.ellipse(Math.round(gandalf.x), Math.round(gandalf.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(npcGandalfImg, Math.round(gandalf.x-dw/2), Math.round(gandalf.y-dh/2), dw, dh);
  }});

  things.push({ y:player.y, draw:()=>{
    const sw=sprites.size.w, sh=sprites.size.h;
    const dw=Math.round(sw*sprites.scale), dh=Math.round(sh*sprites.scale);
    const img = player.moving ? sprites.walk[player.dir][player.frame] : sprites.idle[player.dir][0];
    ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath();
    ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(img, 0,0,sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2), dw, dh);
  }});

  things.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());
}

/* ===== PROX & ACCIÓN ===== */
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function isNear(obj, rad=28){ return dist(player,obj)<rad; }

function onAction(){
  if(state.mode==='play'){
    if(isNear(gandalf)){
      if(!state.metGandalf){ startIntroDialogue(); }
      else { startNPCRepeatDialogue(); }
      return;
    }
    if(enemy1.alive && isNear(enemy1)){
      if(!state.metEnemy1){ startEnemyIntro(); }       // “Ajá!”
      else if(!state.enemyDefeated){ startEnemyCine(); } // reintentar pelea
      else{ startEnemyAfterDefeat(); }                 // frase corta
      return;
    }
    return;
  }
  if(state.mode==='dialog'){ advanceDialog(); return; }
  if(state.mode==='cine'){
    const node = NODES[currentId];
    if(isTyping){ completeTypingNow(); return; }
    if(node && node.choices && state.pendingChoices && !state.inChoices){
      if(state.cineTypingComplete){ openChoicesNow(node.choices); }
      return;
    }
    if(state.inChoices){ confirmChoice(); return; }
    advanceCine();
  }
}

/* ===== DIÁLOGO in-world ===== */
const dialogEl = document.getElementById('dialog');
const dialogName = document.getElementById('dialogName');
const dialogText = document.getElementById('dialogText');
const dialogHint = document.getElementById('dialogHint');

let typingTimer=null, typingSpeed=22, isTyping=false;

function playBip(){
  try{
    if(!window.__ctx) window.__ctx=new (window.AudioContext||window.webkitAudioContext)();
    const ctxA=window.__ctx; const osc=ctxA.createOscillator(); const gain=ctxA.createGain();
    osc.type='square'; osc.frequency.value=760+Math.random()*120;
    const now=ctxA.currentTime, dur=.075, v0=.05;
    gain.gain.setValueAtTime(0,now); gain.gain.linearRampToValueAtTime(v0,now+.01); gain.gain.exponentialRampToValueAtTime(.0005,now+dur);
    osc.connect(gain).connect(ctxA.destination); osc.start(now); osc.stop(now+dur);
  }catch(e){}
}
function bipForChar(ch,i){ const ok=/[A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9]/.test(ch); if(ok||(ch===' '&&i%6===0)) playBip(); }

function typeInto(el,text,done){
  clearInterval(typingTimer); el.textContent=''; isTyping=true; let i=0;
  typingTimer=setInterval(()=>{
    if(i<text.length){ const ch=text[i++]; el.textContent+=ch; bipForChar(ch,i); }
    else{ clearInterval(typingTimer); isTyping=false; el.parentElement.classList.add('ready'); if(done)done(); }
  }, typingSpeed);
}
function completeTypingNow(){
  clearInterval(typingTimer); isTyping=false;
  if(state.mode==='dialog'){
    const full = state.quickDialog ? (state.enemyQuick? 'Sigue tu camino, ya no molesto.' : 'Ya sabes lo que tienes que hacer.')
                                  : (state.enemyIntro? '¡Ajá!' : 'Hola, chico...');
    dialogText.textContent = full;
    dialogEl.classList.add('ready'); dialogHint.style.opacity=1;
  } else if(state.mode==='cine'){
    const node=NODES[currentId];
    cineText.textContent = node.talk;
    cineDialogEl.classList.add('ready'); cineHint.style.opacity=1;
    state.cineTypingComplete = true;
  }
}

/* Primer contacto (Gandalf) */
function startIntroDialogue(){
  state.mode='dialog';
  state.quickDialog=false;
  state.enemyIntro=false; state.enemyQuick=false;
  dialogEl.classList.add('show'); dialogEl.classList.remove('ready');
  dialogName.textContent='???';
  dialogHint.style.opacity=0;
  typeInto(dialogText, 'Hola, chico...', ()=>{ dialogHint.style.opacity=1; });
}
/* Repetición Gandalf (sin cine) */
function startNPCRepeatDialogue(){
  state.mode='dialog';
  state.quickDialog=true;
  state.enemyQuick=false;
  dialogEl.classList.add('show'); dialogEl.classList.remove('ready');
  dialogName.textContent='Gandalf';
  dialogHint.style.opacity=0;
  typeInto(dialogText, 'Ya sabes lo que tienes que hacer.', ()=>{ dialogHint.style.opacity=1; });
}

/* Intro enemigo: Ajá! */
function startEnemyIntro(){
  state.mode='dialog';
  state.quickDialog=false; state.enemyIntro=true; state.enemyQuick=false;
  dialogEl.classList.add('show'); dialogEl.classList.remove('ready');
  dialogName.textContent='???';
  dialogHint.style.opacity=0;
  typeInto(dialogText, '¡Ajá!', ()=>{ dialogHint.style.opacity=1; });
}

function startEnemyAfterDefeat(){
  state.mode='dialog';
  state.quickDialog=true; state.enemyQuick=true;
  dialogEl.classList.add('show'); dialogEl.classList.remove('ready');
  dialogName.textContent='Enemigo';
  dialogHint.style.opacity=0;
  typeInto(dialogText, 'Sigue tu camino, ya no molesto.', ()=>{ dialogHint.style.opacity=1; });
}

function advanceDialog(){
  if(isTyping){ completeTypingNow(); return; }
  if(state.enemyIntro){
    dialogEl.classList.remove('show','ready');
    state.metEnemy1=true;
    startEnemyCine();
    return;
  }
  if(state.quickDialog){
    dialogEl.classList.remove('show','ready');
    state.quickDialog=false;
    state.mode='play';
    return;
  }
  // “Hola chico...” del viejo -> cine
  dialogEl.classList.remove('show','ready');
  startCinematic(); // Gandalf
}

/* ===== CINEMÁTICA ===== */
const cineEl=document.getElementById('cine');
const cineDialogEl=document.getElementById('cineDialog');
const cineName=document.getElementById('cineName');
const cineText=document.getElementById('cineText');
const cineHint=document.getElementById('cineHint');
const pOld=document.getElementById('pOld'), imgOld=document.getElementById('imgOld');
const pJuan=document.getElementById('pJuan'), imgJuan=document.getElementById('imgJuan');
const pEnemy=document.getElementById('pEnemy'), imgEnemy=document.getElementById('imgEnemy');
const choicePanel=document.getElementById('choicePanel');
const choicesEl=document.getElementById('choices');

const hudEl=document.getElementById('hud');
const hpEnemyBar=document.getElementById('hpEnemyBar');
const hpJuanBar =document.getElementById('hpJuanBar');
const hpEnemyTxt=document.getElementById('hpEnemyTxt');
const hpJuanTxt =document.getElementById('hpJuanTxt');

const NODES={
  /* GANDALF */
  start1:{ who:'???',     show:'old',  talk:'Qué bueno que te he encontrado.', next:'start2' },
  start2:{ who:'Juan',    show:'juan', talk:'¿Quién eres??',                   next:'start3' },
  start3:{ who:'Gandalf', show:'old',  talk:'Puedes llamarme Gandalf.',        next:'choice1', rename:true },
  choice1:{ who:'Gandalf', show:'old', talk:'¿Quieres que te guíe o prefieres explorar?',
            choices:[ {label:'Guíame', next:'guide1'}, {label:'Prefiero explorar', next:'explore1'} ] },
  guide1:{ who:'Gandalf', show:'old', talk:'Entonces sígueme, pero pisa donde yo pise.', next:null },
  explore1:{ who:'Gandalf', show:'old', talk:'Como quieras. El norte guarda respuestas.', next:null }
};
let currentId=null, cineVisible=false;

/* ======== GANDALF CINEMÁTICA ======== */
async function startCinematic(){
  await showCineOverlay();
  await loadConversationPortraits();

  // Mostrar diálogo + retrato sincronizados
  state.mode='cine';
  currentId='start1';
  state.inChoices=false; state.pendingChoices=false; state.cineTypingComplete=false;
  choicePanel.classList.remove('show');

  pOld.classList.add('show'); pJuan.classList.remove('show'); pEnemy.classList.remove('show');
  cineDialogEl.classList.add('show');
  showCineNode(NODES[currentId]);
}

async function showCineOverlay(){
  cineEl.style.setProperty('--blur','2px');
  cineEl.style.setProperty('--dim','0.18');
  cineEl.classList.add('show');
  cineVisible=true;
  requestAnimationFrame(()=>{
    cineEl.style.setProperty('--blur','4px');
    cineEl.style.setProperty('--dim','0.25');
  });
}
async function loadConversationPortraits(){
  const [oldBig, juanBig] = await Promise.all([ loadImage(PORTRAIT_OLD), loadImage(PORTRAIT_JUAN) ]);
  imgOld.src=oldBig.src; imgJuan.src=juanBig.src;
  sizePortraitsToBackground();
}

/* retratos = 150% del alto del fondo para efecto dramático */
function sizePortraitsToBackground(){
  const h = Math.round(bgRect.dh * 1.5);
  [imgOld, imgJuan, imgEnemy].forEach(i=>{ if(i) i.style.height = h+'px'; });
}

function showCineNode(node){
  // retrato
  pOld.classList.remove('show'); pJuan.classList.remove('show'); pEnemy.classList.remove('show');
  if(node.show==='old') pOld.classList.add('show');
  else if(node.show==='juan') pJuan.classList.add('show');
  else if(node.show==='enemy') pEnemy.classList.add('show');

  // texto
  cineName.textContent=node.who;
  cineHint.style.opacity=0;
  state.cineTypingComplete=false;
  cineText.textContent='';
  typeInto(cineText, node.talk, ()=>{
    cineHint.style.opacity=1;
    state.cineTypingComplete=true;
  });

  if(node.choices){
    state.pendingChoices=true; state.inChoices=false; choicePanel.classList.remove('show');
  } else { state.pendingChoices=false; state.inChoices=false; choicePanel.classList.remove('show'); }
}

function advanceCine(){
  const node=NODES[currentId];
  if(isTyping){ completeTypingNow(); return; }
  if(node.choices) return;
  if(node.next){ currentId=node.next; showCineNode(NODES[currentId]); }
  else{ endCinematic(true); }
}

function endCinematic(markMet=false){
  if(markMet) state.metGandalf = true;
  cineVisible=false;
  cineEl.classList.remove('show');
  cineDialogEl.classList.remove('show');
  choicePanel.classList.remove('show');
  hudEl.classList.remove('show');
  cineEl.style.setProperty('--blur','0px');
  cineEl.style.setProperty('--dim','0');
  state.mode='play';
}

/* Panel de opciones: encima-dcha del cuadro de diálogo */
function positionChoices(){
  const screen=document.querySelector('.screen').getBoundingClientRect();
  const dlg=cineDialogEl.getBoundingClientRect();
  const panel=choicePanel;

  panel.style.visibility='hidden';
  panel.classList.add('show');
  const pr=panel.getBoundingClientRect();
  const gap=6;

  const top=(dlg.top - screen.top) - pr.height - gap;
  const left=(dlg.right - screen.left) - pr.width;

  panel.style.top=Math.max(0, top)+'px';
  panel.style.left=Math.max(0, left)+'px';
  panel.style.right='';
  panel.style.bottom='';
  panel.style.visibility='';
}

/* ===== CHOICES ===== */
let choiceIndex=0, currentChoices=null;
function buildChoices(list){
  currentChoices=list; choiceIndex=0;
  choicesEl.innerHTML='';
  list.forEach((c,i)=>{
    const div=document.createElement('div');
    div.className='choice'+(i===0?' selected':'');
    div.textContent=c.label;
    choicesEl.appendChild(div);
  });
}
function refreshChoiceSel(){ [...choicesEl.children].forEach((el,i)=>el.classList.toggle('selected', i===choiceIndex)); }
function moveChoice(dir){
  if(!state.inChoices||!currentChoices) return;
  const n=currentChoices.length;
  if(dir==='up') choiceIndex=(choiceIndex-1+n)%n;
  if(dir==='down') choiceIndex=(choiceIndex+1)%n;
  refreshChoiceSel();
}
function confirmChoice(){
  if(!state.inChoices||!currentChoices) return;
  const nextId=currentChoices[choiceIndex].next;
  state.inChoices=false;
  choicePanel.classList.remove('show');
  currentId=nextId;
  showCineNode(FIGHT_NODES[currentId] || NODES[currentId]);
}
function openChoicesNow(list){
  if(!state.cineTypingComplete) return;
  buildChoices(list);
  state.pendingChoices=false;
  state.inChoices=true;
  positionChoices();
}

/* ====== COMBATE ENEMIGO ====== */
const FIGHT_NODES={
  pre1:{ who:'Enemigo', show:'enemy', talk:'Voy a acabar contigo, mocoso.', next:'pre2' },
  pre2:{ who:'Juan',    show:'juan',  talk:'¡Prueba, si te atreves!',       next:'startFight' }
};

let hpEnemy=100, hpJuan=100, fightStep=0;

async function startEnemyCine(){
  await showCineOverlay();
  // Cargar retratos de combate
  const [juanB, enemyB] = await Promise.all([ loadImage(PORTRAIT_JUAN_FIGHT), loadImage(PORTRAIT_ENEMY_FIGHT) ]);
  imgJuan.src=juanB.src; imgEnemy.src=enemyB.src;
  sizePortraitsToBackground();

  state.mode='cine';
  state.inChoices=false; state.pendingChoices=false; state.cineTypingComplete=false;
  choicePanel.classList.remove('show');

  pEnemy.classList.add('show'); pJuan.classList.remove('show'); pOld.classList.remove('show');
  cineDialogEl.classList.add('show');

  // reset HUD
  hpEnemy=100; hpJuan=100; fightStep=0; updateHud(); hudEl.classList.remove('show');

  // Arranque conversacional previo
  currentId='pre1';
  showCineNode(FIGHT_NODES[currentId]);
}

function updateHud(){
  hpEnemy = Math.max(0, Math.min(100, hpEnemy));
  hpJuan  = Math.max(0, Math.min(100, hpJuan));
  hpEnemyBar.style.transform = `scaleX(${hpEnemy/100})`;
  hpJuanBar .style.transform = `scaleX(${hpJuan/100})`;
  hpEnemyTxt.textContent = `${hpEnemy}|100`;
  hpJuanTxt .textContent = `${hpJuan}|100`;
}

function doShake(el){ el.classList.remove('shaking'); void el.offsetWidth; el.classList.add('shaking'); }
function doLunge(el, dir){ el.classList.remove('lunge-left','lunge-right'); void el.offsetWidth; el.classList.add(dir==='left'?'lunge-left':'lunge-right'); }
function doFall(el){ el.classList.add('fall'); }

function proceedFightFrom(nodeKey){
  if(nodeKey==='startFight'){
    hudEl.classList.add('show');
    enemyTurn1();
    return;
  }
}

/* Secuencia pedida:
   1) Turno enemigo: ataque leve -> Juan tiembla
   2) Turno Juan: desplegable (2 ataques) -> enemigo a mitad de vida
   3) Turno enemigo: otro ataque
   4) Turno Juan: desplegable final -> derrota enemigo con caída “¡Me las pagarás!” */
function enemyTurn1(){
  pEnemy.classList.add('show'); pJuan.classList.remove('show');
  cineName.textContent='Enemigo';
  state.cineTypingComplete=false; cineHint.style.opacity=1; // permitimos avanzar con Acción al final del texto
  typeInto(cineText, 'El enemigo te lanza una piedra.', ()=>{
    // animación
    doLunge(imgEnemy,'right');
    setTimeout(()=>{
      doShake(imgJuan);
      hpJuan-=20; updateHud();
      state.cineTypingComplete=true;
    }, 140);
  });
  // al pulsar Acción, abrimos el turno de Juan
  state.pendingChoices=true;
  currentChoices=[
    {label:'Puñetazo', next:'juanAttack1'},
    {label:'Patada giratoria', next:'juanAttack1'}
  ];
  // pero el panel solo sale cuando el texto está completo o completes con toque
}
function enemyTurn2(){
  pEnemy.classList.add('show'); pJuan.classList.remove('show');
  cineName.textContent='Enemigo';
  state.cineTypingComplete=false; cineHint.style.opacity=1;
  typeInto(cineText, 'El enemigo te arroja polvo a los ojos.', ()=>{
    doLunge(imgEnemy,'right');
    setTimeout(()=>{
      doShake(imgJuan);
      hpJuan-=15; updateHud();
      state.cineTypingComplete=true;
      // preparar último turno de Juan
      state.pendingChoices=true;
      currentChoices=[
        {label:'Golpe final', next:'juanFinish'},
        {label:'Uppercut',    next:'juanFinish'}
      ];
    }, 140);
  });
}

/* Tabla de nodos solo para callbacks seleccionados en combate */
const FIGHT_ACTIONS={
  juanAttack1: ()=>{
    pJuan.classList.add('show'); pEnemy.classList.remove('show');
    cineName.textContent='Juan';
    typeInto(cineText, '¡Juan ataca!', ()=>{
      doLunge(imgJuan,'left');
      setTimeout(()=>{
        doShake(imgEnemy);
        hpEnemy=50; updateHud();
        // tras el ataque, turno enemigo 2
        setTimeout(()=>enemyTurn2(), 220);
      }, 140);
    });
  },
  juanFinish: ()=>{
    pJuan.classList.add('show'); pEnemy.classList.remove('show');
    cineName.textContent='Juan';
    typeInto(cineText, '¡Ataque definitivo!', ()=>{
      doLunge(imgJuan,'left');
      setTimeout(()=>{
        doShake(imgEnemy);
        hpEnemy=0; updateHud();
        setTimeout(()=>{
          pEnemy.classList.add('show'); // lo mostramos para ver la caída
          doFall(imgEnemy);
          setTimeout(()=>{
            cineName.textContent='Enemigo';
            typeInto(cineText, '¡Me las pagarás...!', ()=>{
              // fin de combate
              state.enemyDefeated=true;
              enemy1.alive=false; // lo quitamos del mapa
              setTimeout(()=> endCinematic(false), 260);
            });
          }, 280);
        }, 140);
      }, 140);
    });
  }
};

/* Hookear avance dentro de la cinemática del combate */
const _origShowCineNode = showCineNode;
showCineNode = function(node){
  // Si el node pertenece al bloque de combate (FIGHT_NODES)
  if(FIGHT_NODES[node]){
    _origShowCineNode(FIGHT_NODES[node]);
    if(node==='startFight' || FIGHT_NODES[node].next==='startFight'){
      proceedFightFrom('startFight');
    }
    return;
  }
  // Si es un objeto ya (no clave)
  if(node && node.talk){
    // Detectar transición a 'startFight'
    if(node.next==='startFight'){
      _origShowCineNode(node);
      // cuando el jugador pulse Acción tras este texto, arrancamos combate
      const waitStart = ()=>{
        // protegido por onAction/advance: aquí nos limitamos a cambiar el currentId y lanzar
      };
      return;
    }
    _origShowCineNode(node);
    return;
  }
  _origShowCineNode(node);
};

/* Interceptar advance durante la fase de combate de prefacio */
const _origAdvanceCine = advanceCine;
advanceCine = function(){
  // Si estamos en los prefacios del combate
  if(currentId && FIGHT_NODES[currentId]){
    if(isTyping){ completeTypingNow(); return; }
    const node=FIGHT_NODES[currentId];
    if(node.next==='startFight'){
      currentId='startFight';
      // lanzar turno enemigo 1
      enemyTurn1();
      return;
    }
    if(node.next){
      currentId=node.next;
      showCineNode(FIGHT_NODES[currentId]);
      return;
    }
    return;
  }
  // Si hay elecciones en combate (estado pendingChoices) y se pulsa Acción con el texto completo:
  if(state.mode==='cine' && state.pendingChoices && state.cineTypingComplete && !state.inChoices){
    openChoicesNow(currentChoices||[]);
    return;
  }
  _origAdvanceCine();
};

/* ===== STATE & LOOP ===== */
const state={
  mode:'play',
  inChoices:false, pendingChoices:false, cineTypingComplete:false,
  metGandalf:false, quickDialog:false,
  metEnemy1:false, enemyDefeated:false, enemyIntro:false, enemyQuick:false
};

function loop(now){
  if(!loop.last) loop.last=now;
  const dt=Math.min(1/30,(now-loop.last)/1000);
  loop.last=now;
  update(dt); draw();
  requestAnimationFrame(loop);
}

/* ===== INIT ===== */
async function init(){
  const [bg, spr, gandalfPng, enemyPng] = await Promise.all([
    loadImage(BACKGROUND),
    preloadSprites(SPRITES_JUAN),
    loadImage(NPC_GANDALF_IMG),
    loadImage(ENEMY_IMG)
  ]);
  bgImg=bg; sprites=spr; npcGandalfImg=gandalfPng; enemyImg=enemyPng;

  const screen=document.querySelector('.screen');
  canvas.width=screen.clientWidth; canvas.height=screen.clientHeight;
  resizeCanvas();

  try{ bgMusic.play().catch(()=>{});}catch(e){}
  document.getElementById('bootMask').classList.add('hidden');
  requestAnimationFrame(loop);
}
init();

/* Acceso rápido a acciones de combate desde confirmar elección */
const _origConfirmChoice = confirmChoice;
confirmChoice = function(){
  if(!state.inChoices||!currentChoices) return;
  const key = currentChoices[choiceIndex].next;
  state.inChoices=false;
  choicePanel.classList.remove('show');
  // Si es una acción de combate conocida:
  if(FIGHT_ACTIONS[key]){
    FIGHT_ACTIONS[key]();
    return;
  }
  // Si es un nodo normal o de prefacio combate:
  if(FIGHT_NODES[key]){
    currentId=key;
    showCineNode(FIGHT_NODES[currentId]);
    return;
  }
  _origConfirmChoice();
};

</script>
</body>
</html>