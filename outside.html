<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin 30th birthday - room (cinemática)</title>

<!-- Fuentes pixel -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height: 100%; margin: 0; background: #111; display: flex; justify-content: center; align-items: center; }
  .gameboy { width: 100%; max-width: 500px; height: 100%; background: #000; display: flex; flex-direction: column;
    padding: 12px; box-sizing: border-box; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
  .screen-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #0B0A21; border-radius: 12px; padding: 10px; }
  .screen { aspect-ratio: 1/1; width: 100%; background: #0B0A21; display: flex; justify-content: center; align-items: center;
    border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.6); }
  canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; background: black; }

  .controls { height: 40%; background: #0B0A21; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; box-sizing: border-box; }
  .dpad { display: grid; grid-template-columns: repeat(3, 64px); grid-template-rows: repeat(3, 64px); gap: 0; justify-content: center; margin-left: 12px; align-content: center; overflow: visible; }
  .img-btn, .img-act { border: none; outline: none; padding: 0; background: transparent; cursor: pointer; transition: transform 0.06s ease, filter 0.06s ease; -webkit-tap-highlight-color: transparent; }
  .img-btn { width: 64px; height: 64px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.85)); }
  .img-btn.arrow::before { content: ""; display: block; width: 100%; height: 100%; background: url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering: pixelated; transform: rotate(var(--rot, 0deg)) scale(1.28); transform-origin: center center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width: 120px; height: 120px; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.85)); margin-top: 45px; justify-self: center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering: pixelated; transform: scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform: scale(0.95); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)) brightness(0.9); }

  .toast{ position:absolute; top:19px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; font:600 12px/1 system-ui;
    padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space: nowrap; pointer-events:none; z-index:5; }
  .toast.show{ opacity:1; }

  /* ===== Cuadro de diálogo estilo pixel ===== */
  .dialog {
    position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%) scaleX(0);
    transform-origin: center bottom; width: calc(100% - 24px); max-width: 460px; min-height: 60px;
    box-sizing: border-box; padding: 10px 12px 14px; display: flex; flex-direction: column; align-items: flex-start; gap: 6px;
    border-radius: 10px; image-rendering: pixelated; z-index: 12; transition: transform .22s ease;
    background: rgba(12,12,24,0.9); border: none; border-top: 2px solid #3cf; text-align: left;
  }
  .dialog.show { transform: translateX(-50%) scaleX(1); }
  .dialog-name{ font-family: 'Press Start 2P', system-ui; font-size: 10px; color:#8df; text-shadow: 0 1px 0 #000; }
  .dialog-text{ font-family:'VT323', monospace; font-size: 18px; letter-spacing:1px; line-height:1.15; color:#E6F6FF; min-height:2.2em; }
  .dialog-hint{ margin-left:auto; color:#B8D7FF; font:600 12px/1 system-ui; opacity:0; transition:opacity .18s ease; }
  .dialog.ready .dialog-hint{ opacity:.9; }

  /* ===== Cinemática: blur + retratos grandes ===== */
  .cine {
    position:absolute; inset:0; z-index: 20; display:none;
    background: rgba(0,0,0,0.2); backdrop-filter: blur(6px);
  }
  .cine.show { display:block; animation: fadeIn .18s ease both; }
  @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

  .cine-portraits { position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:space-between; pointer-events:none; }
  .portrait {
    width: 50%; max-width: 500px; position: relative; display:flex; justify-content:center; align-items:flex-end; padding: 8px 8px 0; /* 0 abajo para pegar pies */
  }
  .portrait img {
    /* retratos: 90% de alto del área de juego */
    height: 90%;
    width: auto;
    max-width: none;
    image-rendering: pixelated; opacity: 0; transform: translateX(var(--tx,0));
    transition: transform .26s ease, opacity .26s ease; filter: drop-shadow(0 0 18px rgba(0,0,0,.9));
  }
  .portrait.left  img{ --tx:-12%; }
  .portrait.right img{ --tx: 12%; }
  .portrait.show img{ opacity:1; transform: translateX(0); }

  /* ===== Panel de opciones: SIN título, arriba del diálogo y pegado a su borde derecho ===== */
  .choice-panel{
    position:absolute;
    /* sin posición fija: se coloca vía JS en la esquina sup-der del diálogo */
    background: rgba(12,12,24,0.95);
    border:1px solid #3cf; border-radius: 8px; z-index: 26; display:none;
    min-width: 160px; padding: 6px; box-shadow: 0 6px 14px rgba(0,0,0,.45);
  }
  .choice-panel.show{ display:block; }
  .choices{ display:flex; flex-direction:column; gap:6px; }
  .choice{
    font-family:'VT323', monospace; font-size:18px; color:#E6F6FF; padding: 4px 8px; text-align:left;
    border:1px solid transparent; background:transparent;
  }
  .choice.selected{ border-color:#8df; background: rgba(60, 120, 255, 0.18); border-radius: 4px; }

  .scene-fade{ position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:999; transition: opacity .45s ease; }
  .scene-fade.show{ opacity:1; }

  .boot-mask{ position:absolute; inset:0; background:#000; z-index:1000; opacity:1; transition: opacity .25s ease;}
  .boot-mask.hidden{ opacity:0; pointer-events:none; }
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>

      <div id="toast" class="toast"></div>
      <div id="sceneFade" class="scene-fade"></div>

      <!-- Diálogo in-world -->
      <div id="dialog" class="dialog" aria-live="polite">
        <div id="dialogName" class="dialog-name"></div>
        <div id="dialogText" class="dialog-text"></div>
        <div id="dialogHint" class="dialog-hint">→</div>
      </div>

      <!-- Capa de CINEMÁTICA -->
      <div id="cine" class="cine">
        <div class="cine-portraits">
          <div id="pOld"  class="portrait left"><img id="imgOld"  alt="Viejo"></div>
          <div id="pJuan" class="portrait right"><img id="imgJuan" alt="Juan"></div>
        </div>
        <!-- Diálogo sobre la capa cine -->
        <div id="cineDialog" class="dialog" style="z-index:25; bottom: 12px;">
          <div id="cineName" class="dialog-name"></div>
          <div id="cineText" class="dialog-text"></div>
          <div id="cineHint" class="dialog-hint">→</div>
        </div>

        <!-- Opciones (encima del diálogo, pegadas a la derecha) -->
        <div id="choicePanel" class="choice-panel">
          <div id="choices" class="choices"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles táctiles -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== CONFIG BÁSICA ===== */
const DEBUG = false;

/* ===== MAPA/ESCENA ===== */
const BACKGROUND = "assets/locations/outside.PNG";

/* ===== SPRITES ===== */
const SPRITES_JUAN = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: { down:["assets/juan_character/idle_down_shoes.png"], up:["assets/juan_character/idle_up_shoes.png"], left:["assets/juan_character/idle_left_shoes.png"], right:["assets/juan_character/idle_right_shoes.png"] },
  walk: { down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"], up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"], left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"], right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"] }
};
/* NPC frontal único */
const NPC_IMG = "assets/characters/gandalf.PNG";

/* ===== RETRATOS GRANDES ===== */
const PORTRAIT_OLD  = "assets/characters/gandalf_big.PNG";
const PORTRAIT_JUAN = "assets/characters/juansin_big.PNG";

/* ===== AUDIO ===== */
const bgMusic = new Audio("assets/sounds/ambient1.mp3"); bgMusic.loop = true; bgMusic.volume = 0.35;

/* ===== CANVAS ===== */
const roomOriginal = { w: 512, h: 350 };
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

let bgRect = { dx:0, dy:0, dw:0, dh:0 }, scaleFactor=1;
let bgImg=null, npcImg=null, sprites=null;

const player = { x:0, y:0, speed:230, dir:'down', moving:false, frame:0, frameTime:0 };
const npc    = { x:0, y:0 };

/* ===== INPUT mover (teclas y dpad). Acción SOLO botón/touch ===== */
const keys = { up:false, down:false, left:false, right:false };
const mapKey = { ArrowUp:'up', KeyW:'up', ArrowDown:'down', KeyS:'down', ArrowLeft:'left', KeyA:'left', ArrowRight:'right', KeyD:'right' };
window.addEventListener('keydown', e => { const d=mapKey[e.code]; if(d){ keys[d]=true; e.preventDefault(); }});
window.addEventListener('keyup',   e => { const d=mapKey[e.code]; if(d){ keys[d]=false; e.preventDefault(); }});
function bindHold(btn, on, off){
  const start = e => { e.preventDefault(); on(); };
  const end   = e => { e.preventDefault(); off(); };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  window.addEventListener('mouseup', end);
}
bindHold(document.getElementById('btn-up'),    ()=>keys.up=true,    ()=>keys.up=false);
bindHold(document.getElementById('btn-down'),  ()=>keys.down=true,  ()=>keys.down=false);
bindHold(document.getElementById('btn-left'),  ()=>keys.left=true,  ()=>keys.left=false);
bindHold(document.getElementById('btn-right'), ()=>keys.right=true, ()=>keys.right=false);

/* Acción: SOLO botón/touch */
const btnAct = document.getElementById('btn-act');
btnAct.addEventListener('click', e=>{ e.preventDefault(); onAction(); });
btnAct.addEventListener('touchstart', e=>{ e.preventDefault(); onAction(); }, {passive:false});

/* === D-PAD controla el menú de opciones cuando está abierto (sin teclado) === */
document.getElementById('btn-up').addEventListener('click', e=>{
  if (state.mode==='cine' && state.inChoices){ e.preventDefault(); moveChoice('up'); }
});
document.getElementById('btn-down').addEventListener('click', e=>{
  if (state.mode==='cine' && state.inChoices){ e.preventDefault(); moveChoice('down'); }
});

/* ===== UTIL ===== */
const loadImage = (src) => new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.src=src; });
async function preloadSprites(map){
  const out={ idle:{}, walk:{}, size:map.size, scale:map.scale };
  for(const s of ['idle','walk']) for(const d of Object.keys(map[s])) out[s][d]=await Promise.all(map[s][d].map(loadImage));
  return out;
}

/* ===== DIBUJO ===== */
function resizeCanvas(){
  const screen = document.querySelector('.screen');
  canvas.width = screen.clientWidth; canvas.height = screen.clientHeight;

  if (bgImg){
    scaleFactor = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
    bgRect.dw = roomOriginal.w * scaleFactor; bgRect.dh = roomOriginal.h * scaleFactor;
    bgRect.dx = (canvas.width - bgRect.dw)/2; bgRect.dy = (canvas.height - bgRect.dh)/2;

    player.x = bgRect.dx + bgRect.dw*0.5;
    player.y = bgRect.dy + bgRect.dh*0.80;

    npc.x = bgRect.dx + bgRect.dw*0.52;
    npc.y = bgRect.dy + bgRect.dh*0.35;
  }

  // re-posicionar el panel si está visible
  if (choicePanel.classList.contains('show')) positionChoices();
}
window.addEventListener('resize', resizeCanvas);

function update(dt){
  if (state.mode!=='play') return;

  const vx=(keys.left?-1:0)+(keys.right?1:0);
  const vy=(keys.up?-1:0)+(keys.down?1:0);
  player.moving = (vx!==0 || vy!==0);

  if (player.moving){
    player.dir = Math.abs(vx) > Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len = Math.hypot(vx,vy)||1;
    player.x += (vx/len)*player.speed*dt;
    player.y += (vy/len)*player.speed*dt;

    const halfW = Math.round(sprites.size.w*sprites.scale)/2;
    const halfH = Math.round(sprites.size.h*sprites.scale)/2;
    const minX=bgRect.dx+halfW, maxX=bgRect.dx+bgRect.dw-halfW;
    const minY=bgRect.dy+halfH, maxY=bgRect.dy+bgRect.dh-halfH;
    player.x=Math.max(minX,Math.min(maxX,player.x));
    player.y=Math.max(minY,Math.min(maxY,player.y));

    player.frameTime+=dt;
    if(player.frameTime>=0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else player.frame=0;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!bgImg) return;

  ctx.drawImage(bgImg, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);

  const things = [];
  things.push({ y:npc.y, draw: ()=>{
    const w=36, h=40, s=0.9;
    const dw=Math.round(w*s), dh=Math.round(h*s);
    ctx.fillStyle='rgba(0,0,0,0.28)'; ctx.beginPath();
    ctx.ellipse(Math.round(npc.x), Math.round(npc.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(npcImg, Math.round(npc.x-dw/2), Math.round(npc.y-dh/2), dw, dh);
  }});
  things.push({ y:player.y, draw: ()=>{
    const sw=sprites.size.w, sh=sprites.size.h;
    const dw=Math.round(sw*sprites.scale), dh=Math.round(sh*sprites.scale);
    const img = player.moving ? sprites.walk[player.dir][player.frame] : sprites.idle[player.dir][0];
    ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath();
    ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(img, 0,0,sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2), dw, dh);
  }});
  things.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());
}

/* ===== NEAR / ACTION ===== */
function playerRect(){
  const sw=sprites.size.w, sh=sprites.size.h, sc=sprites.scale;
  const dw=Math.round(sw*sc), dh=Math.round(sh*sc);
  return { x: player.x-dw/2, y: player.y-dh/2, w:dw, h:dh };
}
function isNearNPC(){
  const dx=player.x-npc.x, dy=player.y-npc.y; return Math.hypot(dx,dy) < 28;
}
function onAction(){
  if (state.mode==='play'){
    if (isNearNPC()){ startIntroDialogue(); }
    return;
  }
  if (state.mode==='dialog') advanceDialog();
  if (state.mode==='cine'){
    if (state.inChoices){
      confirmChoice();
    } else {
      advanceCine();
    }
  }
}

/* ===== DIALOGO EN ESCENA (previo) ===== */
const dialogEl   = document.getElementById('dialog');
const dialogName = document.getElementById('dialogName');
const dialogText = document.getElementById('dialogText');
const dialogHint = document.getElementById('dialogHint');

let typingTimer=null, typingSpeed=22, isTyping=false;

/* Beep retro */
function playBip(){
  try{
    if(!window.__ctx) window.__ctx=new (window.AudioContext||window.webkitAudioContext)();
    const ctx=window.__ctx; const osc=ctx.createOscillator(); const gain=ctx.createGain();
    osc.type='square'; osc.frequency.value=760+Math.random()*120;
    const now=ctx.currentTime, dur=.075, v0=.05;
    gain.gain.setValueAtTime(0,now); gain.gain.linearRampToValueAtTime(v0,now+.01); gain.gain.exponentialRampToValueAtTime(.0005,now+dur);
    osc.connect(gain).connect(ctx.destination); osc.start(now); osc.stop(now+dur);
  }catch(e){}
}
function bipForChar(ch,i){ const ok=/[A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9]/.test(ch); if(ok || (ch===' ' && i%6===0)) playBip(); }

function typeInto(el, text, done){
  clearInterval(typingTimer); el.textContent=''; isTyping=true; let i=0;
  typingTimer=setInterval(()=>{
    if(i<text.length){ const ch=text[i++]; el.textContent+=ch; bipForChar(ch,i); }
    else{ clearInterval(typingTimer); isTyping=false; el.parentElement.classList.add('ready'); if(done)done(); }
  }, typingSpeed);
}

/* Intro: sin cinemática, nombre "???", texto "Hola, chico..." */
function startIntroDialogue(){
  state.mode='dialog';
  dialogEl.classList.add('show'); dialogEl.classList.remove('ready');
  dialogName.textContent='???';
  dialogHint.style.opacity=0;
  typeInto(dialogText, 'Hola, chico...', ()=>{ dialogHint.style.opacity=1; });
}
function advanceDialog(){
  if (isTyping){ clearInterval(typingTimer); isTyping=false; dialogText.textContent='Hola, chico...'; dialogEl.classList.add('ready'); dialogHint.style.opacity=1; return; }
  dialogEl.classList.remove('show','ready');
  startCinematic();
}

/* ===== CINEMÁTICA (Árbol) ===== */
const cineEl       = document.getElementById('cine');
const cineDialogEl = document.getElementById('cineDialog');
const cineName = document.getElementById('cineName');
const cineText = document.getElementById('cineText');
const cineHint = document.getElementById('cineHint');
const pOld = document.getElementById('pOld'), imgOld = document.getElementById('imgOld');
const pJuan= document.getElementById('pJuan'), imgJuan= document.getElementById('imgJuan');
const choicePanel = document.getElementById('choicePanel');
const choicesEl   = document.getElementById('choices');

/* --- grafo de nodos por id --- */
const NODES = {
  start1: { who:'???',     show:'old',  talk:'Qué bueno que te he encontrado.', next:'start2' },
  start2: { who:'Juan',    show:'juan', talk:'¿Quién eres??',                   next:'start3' },
  start3: { who:'Gandalf', show:'old',  talk:'Puedes llamarme Gandalf.',        next:'choice1', rename:true },

  choice1:{ who:'Gandalf', show:'old',  talk:'¿Quieres que te guíe o prefieres explorar?',
            choices:[
              { label:'Guíame',           next:'guide1' },
              { label:'Prefiero explorar',next:'explore1' }
            ] },

  guide1:   { who:'Gandalf', show:'old', talk:'Entonces sígueme, pero pisa donde yo pise.', next:null },
  explore1: { who:'Gandalf', show:'old', talk:'Como quieras. El norte guarda respuestas.',   next:null }
};

let currentId = null;
let currentOldName='???';

function startCinematic(){
  state.mode='cine';
  currentId = 'start1';
  state.inChoices=false; choicePanel.classList.remove('show');
  imgOld.src = PORTRAIT_OLD; imgJuan.src = PORTRAIT_JUAN;
  cineEl.classList.add('show');
  cineDialogEl.classList.add('show');
  showCineNode(NODES[currentId]);
}

function showCineNode(node){
  /* retratos */
  pOld.classList.remove('show'); pJuan.classList.remove('show');
  if (node.show==='old')  pOld.classList.add('show'); else if (node.show==='juan') pJuan.classList.add('show');

  if (node.rename) currentOldName = 'Gandalf';
  cineName.textContent = node.who;
  cineHint.style.opacity=0;
  cineText.textContent='';
  typeInto(cineText, node.talk, ()=>{ cineHint.style.opacity=1; });

  /* opciones */
  if (node.choices){
    buildChoices(node.choices);
    state.inChoices=true;
    // posicionalas justo encima y a la derecha del diálogo
    setTimeout(positionChoices, 0); // esperar layout
  } else {
    state.inChoices=false;
    choicePanel.classList.remove('show');
  }
}

/* coloca el choicePanel pegado arriba-derecha del diálogo de cine */
function positionChoices(){
  const screen = document.querySelector('.screen').getBoundingClientRect();
  const dlg = cineDialogEl.getBoundingClientRect();
  const panel = choicePanel;

  // asegurar que está visible para leer su tamaño
  panel.style.visibility = 'hidden';
  panel.classList.add('show');

  const panelRect = panel.getBoundingClientRect();
  const gap = 6;

  // top = parte superior del diálogo menos la altura del panel - gap
  const top = (dlg.top - screen.top) - panelRect.height - gap;
  // left = borde derecho del diálogo menos ancho del panel
  const left = (dlg.right - screen.left) - panelRect.width;

  panel.style.top = Math.max(0, top) + 'px';
  panel.style.left = Math.max(0, left) + 'px';
  panel.style.right = '';
  panel.style.bottom = '';

  panel.style.visibility = '';
}

/* avanzar nodos */
function advanceCine(){
  const node = NODES[currentId];
  if (isTyping){ clearInterval(typingTimer); isTyping=false; cineText.textContent=node.talk; cineHint.style.opacity=1; return; }
  if (node.choices){ return; }              // espera a confirmación
  if (node.next){ currentId = node.next; showCineNode(NODES[currentId]); }
  else { endCinematic(); }
}
function endCinematic(){
  cineEl.classList.remove('show');
  cineDialogEl.classList.remove('show');
  choicePanel.classList.remove('show');
  state.mode='play';
}

/* ===== CHOICES ===== */
let choiceIndex=0, currentChoices=null;
function buildChoices(list){
  currentChoices = list; choiceIndex=0;
  choicesEl.innerHTML='';
  list.forEach((c,i)=>{
    const div=document.createElement('div');
    div.className='choice'+(i===0?' selected':'');
    div.textContent=c.label;
    choicesEl.appendChild(div);
  });
  choicePanel.classList.add('show');
}
function refreshChoiceSel(){
  [...choicesEl.children].forEach((el,i)=> el.classList.toggle('selected', i===choiceIndex));
}
function moveChoice(dir){
  if (!state.inChoices || !currentChoices) return;
  const n=currentChoices.length;
  if (dir==='up')   choiceIndex=(choiceIndex-1+n)%n;
  if (dir==='down') choiceIndex=(choiceIndex+1)%n;
  refreshChoiceSel();
}
function confirmChoice(){
  if (!state.inChoices || !currentChoices) return;
  const nextId = currentChoices[choiceIndex].next;
  state.inChoices=false;
  choicePanel.classList.remove('show');
  currentId = nextId;
  showCineNode(NODES[currentId]);
}

/* ===== STATE ===== */
const state = { mode:'play', inChoices:false };

/* ===== LOOP ===== */
function loop(now){
  if(!loop.last) loop.last=now;
  const dt = Math.min(1/30,(now-loop.last)/1000);
  loop.last=now;
  update(dt); draw();
  requestAnimationFrame(loop);
}

/* ===== INIT ===== */
async function init(){
  const [bg, spr, npcPng] = await Promise.all([
    loadImage(BACKGROUND),
    preloadSprites(SPRITES_JUAN),
    loadImage(NPC_IMG)
  ]);
  bgImg=bg; sprites=spr; npcImg=npcPng;

  resizeCanvas();
  try{ bgMusic.play().catch(()=>{}); }catch(e){}
  document.getElementById('bootMask').classList.add('hidden');
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>