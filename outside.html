<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
<title>Juansin - visor con lupa (vallas + cámara limitada + DEBUG)</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start 2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height:100%; margin:0; background:#111; display:flex; justify-content:center; align-items:center; }
  .gameboy { width:100%; max-width:500px; height:100%; background:#000; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.6); }
  .screen-container { flex:1; display:flex; justify-content:center; align-items:center; background:#0B0A21; border-radius:12px; padding:10px; }
  .screen { aspect-ratio:1/1; width:100%; background:#0B0A21; display:flex; justify-content:center; align-items:center; border-radius:8px; overflow:hidden; position:relative; box-shadow:inset 0 0 20px rgba(0,0,0,.6); }
  canvas { width:100%; height:100%; image-rendering:pixelated; background:black; }

  .controls { height:40%; background:#0B0A21; display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:14px; box-sizing:border-box; }
  .dpad { display:grid; grid-template-columns:repeat(3,64px); grid-template-rows:repeat(3,64px); gap:0; justify-content:center; margin-left:12px; align-content:center; }
  .img-btn,.img-act{ border:none; outline:none; padding:0; background:transparent; cursor:pointer; transition:transform .06s ease, filter .06s ease; -webkit-tap-highlight-color:transparent; }
  .img-btn{ width:64px; height:64px; filter:drop-shadow(0 3px 4px rgba(0,0,0,.85)); }
  .img-btn.arrow::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering:pixelated; transform:rotate(var(--rot,0deg)) scale(1.28); transform-origin:center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width:120px; height:120px; filter:drop-shadow(0 5px 6px rgba(0,0,0,.85)); margin-top:45px; justify-self:center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering:pixelated; transform:scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active{ transform:scale(.95); filter:drop-shadow(0 2px 3px rgba(0,0,0,.7)) brightness(.9); }
</style>
</head>
<body>
<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <canvas id="game"></canvas>
    </div>
  </div>

  <!-- tus controles -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción (toggle DEBUG)"></button>
  </div>
</div>

<script>
/* ===== ASSETS ===== */
const BACKGROUND_SRC="assets/locations/outside.png";
const SPRITES_JUAN={ size:{w:36,h:40}, scale:0.9,
  idle:{ down:["assets/juan_character/idle_down_shoes.png"], up:["assets/juan_character/idle_up_shoes.png"], left:["assets/juan_character/idle_left_shoes.png"], right:["assets/juan_character/idle_right_shoes.png"] },
  walk:{ down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"], up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"], left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"], right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"] }
};

/* ===== VIEWPORT/CÁMARA ===== */
const roomOriginal={w:512,h:350};
const ZOOM=2.0;
const PLAYER_SPEED=220;
const STEP_FRAME=0.14;

/* ===== VALLAS (en coords de la imagen) =====
   type: 'vertical'   -> línea en x, activa entre y1..y2
         'horizontal' -> línea en y, activa entre x1..x2
*/
const FENCES = [
  // EJEMPLOS (cámbialos por los tuyos):
  { type:'vertical',   x: 1200, y1: 200, y2: 900 },
  { type:'horizontal', y: 700,  x1: 300, x2: 1100 }
];

/* ===== DEBUG ===== */
const DEBUG = {
  show: true,    // arranca con debug visible
  grid: true,    // muestra rejilla en el mundo
  gridStep: 200, // cada 200px
  font: "12px 'VT323', monospace"
};

/* ===== CANVAS ===== */
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d',{alpha:false}); ctx.imageSmoothingEnabled=false;

/* ===== INPUT: solo D-pad ===== */
const keys={up:false,down:false,left:false,right:false};
function bindHold(btn,on,off){ const start=e=>{e.preventDefault();on();btn.classList.add('pressed');}; const end=e=>{e.preventDefault();off();btn.classList.remove('pressed');}; btn.addEventListener('touchstart',start,{passive:false}); btn.addEventListener('touchend',end,{passive:false}); btn.addEventListener('touchcancel',end,{passive:false}); btn.addEventListener('mousedown',start); window.addEventListener('mouseup',end); }
bindHold(document.getElementById('btn-up'),   ()=>keys.up=true,   ()=>keys.up=false);
bindHold(document.getElementById('btn-down'), ()=>keys.down=true, ()=>keys.down=false);
bindHold(document.getElementById('btn-left'), ()=>keys.left=true, ()=>keys.left=false);
bindHold(document.getElementById('btn-right'),()=>keys.right=true,()=>keys.right=false);

// Acción: toggle DEBUG
const btnAct=document.getElementById('btn-act');
['click','touchstart'].forEach(evt=>{
  btnAct.addEventListener(evt, e=>{ e.preventDefault(); DEBUG.show=!DEBUG.show; });
});

/* ===== LOAD ===== */
const loadImage=src=>new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; });
async function preloadSprites(map){ const out={idle:{},walk:{},size:map.size,scale:map.scale}; for(const s of ['idle','walk']) for(const d of Object.keys(map[s])) out[s][d]=await Promise.all(map[s][d].map(loadImage)); return out; }

let sprites=null; const world={img:null,w:0,h:0};
const player={x:0,y:0,dir:'down',moving:false,frame:0,t:0};

(async function init(){
  const [bg,spr]=await Promise.all([loadImage(BACKGROUND_SRC),preloadSprites(SPRITES_JUAN)]);
  world.img=bg; world.w=bg.naturalWidth; world.h=bg.naturalHeight; sprites=spr;

  // arranque: abajo-izquierda (ajústalo si quieres)
  const viewW=roomOriginal.w/ZOOM, viewH=roomOriginal.h/ZOOM;
  player.x = Math.max(viewW*0.5, 8);
  player.y = Math.min(world.h - 8, world.h - viewH*0.5);
  player.dir='up';

  resizeCanvas();
  requestAnimationFrame(loop);
})();

/* ===== LETTERBOX ===== */
let vp={dx:0,dy:0,dw:0,dh:0,k:1};
function resizeCanvas(){
  const screen=document.querySelector('.screen');
  canvas.width=screen.clientWidth; canvas.height=screen.clientHeight;
  const k=Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
  vp.dw=Math.round(roomOriginal.w*k);
  vp.dh=Math.round(roomOriginal.h*k);
  vp.dx=Math.round((canvas.width-vp.dw)/2);
  vp.dy=Math.round((canvas.height-vp.dh)/2);
  vp.k=k;
}
window.addEventListener('resize',resizeCanvas);

/* ===== LOOP ===== */
let last=0;
function loop(now){ if(!last) last=now; const dt=Math.min(1/30,(now-last)/1000); last=now; update(dt); draw(); requestAnimationFrame(loop); }

/* ===== MOVIMIENTO + COLISIÓN VALLAS ===== */
function update(dt){
  let vx=(keys.left?-1:0)+(keys.right?1:0);
  let vy=(keys.up?-1:0)+(keys.down?1:0);
  player.moving=!!(vx||vy);
  if(vx&&vy){ const inv=1/Math.sqrt(2); vx*=inv; vy*=inv; }

  const nextX = player.x + vx*PLAYER_SPEED*dt;
  const nextY = player.y + vy*PLAYER_SPEED*dt;

  const halfW=(SPRITES_JUAN.size.w*SPRITES_JUAN.scale)/2;
  const halfH=(SPRITES_JUAN.size.h*SPRITES_JUAN.scale)/2;

  // Resolver por ejes para "deslizarse" por paredes
  let nx = nextX, ny = player.y;
  for(const f of FENCES){
    if(f.type==='vertical'){
      const withinY = (ny >= f.y1 - halfH) && (ny <= f.y2 + halfH);
      if(!withinY) continue;
      if(player.x < f.x - halfW && nx >= f.x - halfW){ nx = f.x - halfW; }
      if(player.x > f.x + halfW && nx <= f.x + halfW){ nx = f.x + halfW; }
    }
  }
  player.x = clamp(nx, halfW, world.w - halfW);

  ny = nextY;
  for(const f of FENCES){
    if(f.type==='horizontal'){
      const withinX = (player.x >= f.x1 - halfW) && (player.x <= f.x2 + halfW);
      if(!withinX) continue;
      if(player.y < f.y - halfH && ny >= f.y - halfH){ ny = f.y - halfH; }
      if(player.y > f.y + halfH && ny <= f.y + halfH){ ny = f.y + halfH; }
    }
  }
  player.y = clamp(ny, halfH, world.h - halfH);

  if(player.moving){
    player.dir = Math.abs(vx)>Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    player.t+=dt; if(player.t>=STEP_FRAME){ player.t=0; player.frame=(player.frame+1)%2; }
  } else { player.frame=0; player.t=0; }
}

/* ===== DIBUJO + CÁMARA CLAMPEADA A VALLAS ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!world.img||!sprites) return;

  const viewW=roomOriginal.w/ZOOM, viewH=roomOriginal.h/ZOOM;

  // Cámara ideal centrada
  let camX = clamp(player.x - viewW/2, 0, Math.max(0, world.w - viewW));
  let camY = clamp(player.y - viewH/2, 0, Math.max(0, world.h - viewH));

  // Clamp adicional a vallas (como bordes)
  for(const f of FENCES){
    if(f.type==='vertical' && overlapsY(camY,viewH,f.y1,f.y2)){
      if(player.x <= f.x) camX = Math.min(camX, f.x - viewW);
      if(player.x >= f.x) camX = Math.max(camX, f.x);
    }else
    if(f.type==='horizontal' && overlapsX(camX,viewW,f.x1,f.x2)){
      if(player.y <= f.y) camY = Math.min(camY, f.y - viewH);
      if(player.y >= f.y) camY = Math.max(camY, f.y);
    }
  }

  // Fondo
  ctx.drawImage(world.img, camX, camY, viewW, viewH, vp.dx, vp.dy, vp.dw, vp.dh);

  // ===== DEBUG OVERLAY =====
  if(DEBUG.show){
    // Marco del visor
    ctx.save();
    ctx.strokeStyle='rgba(0,255,255,.8)'; ctx.lineWidth=2;
    ctx.strokeRect(vp.dx-1, vp.dy-1, vp.dw+2, vp.dh+2);
    ctx.restore();

    // Transformación mundo->pantalla (dentro del visor)
    ctx.save();
    ctx.translate(vp.dx, vp.dy);
    ctx.scale(vp.k*ZOOM, vp.k*ZOOM);
    ctx.translate(-camX, -camY);

    // Rejilla
    if(DEBUG.grid){
      const step = DEBUG.gridStep;
      ctx.strokeStyle='rgba(255,255,255,.18)';
      ctx.lineWidth = 1/(vp.k*ZOOM);
      let startX = Math.floor(camX/step)*step;
      let endX = camX + viewW;
      for(let x=startX; x<=endX; x+=step){
        ctx.beginPath(); ctx.moveTo(x, camY); ctx.lineTo(x, camY+viewH); ctx.stroke();
      }
      let startY = Math.floor(camY/step)*step;
      let endY = camY + viewH;
      for(let y=startY; y<=endY; y+=step){
        ctx.beginPath(); ctx.moveTo(camX, y); ctx.lineTo(camX+viewW, y); ctx.stroke();
      }
    }

    // Vallas
    ctx.strokeStyle='#ff5252';
    ctx.lineWidth = Math.max(1/(vp.k*ZOOM), 0.5);
    for(const f of FENCES){
      ctx.beginPath();
      if(f.type==='vertical'){
        ctx.moveTo(f.x, f.y1); ctx.lineTo(f.x, f.y2);
      }else{
        ctx.moveTo(f.x1, f.y); ctx.lineTo(f.x2, f.y);
      }
      ctx.stroke();
    }

    // Caja de colisión de Juan
    const halfW=(SPRITES_JUAN.size.w*SPRITES_JUAN.scale)/2;
    const halfH=(SPRITES_JUAN.size.h*SPRITES_JUAN.scale)/2;
    ctx.strokeStyle='#7CFC00'; // verde
    ctx.lineWidth = Math.max(1/(vp.k*ZOOM), 0.75);
    ctx.strokeRect(player.x-halfW, player.y-halfH, halfW*2, halfH*2);

    // Cruz en el centro del player
    ctx.beginPath();
    ctx.moveTo(player.x-6, player.y); ctx.lineTo(player.x+6, player.y);
    ctx.moveTo(player.x, player.y-6); ctx.lineTo(player.x, player.y+6);
    ctx.stroke();

    ctx.restore();

    // HUD de coordenadas
    ctx.save();
    ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(vp.dx+6, vp.dy+6, 210, 64);
    ctx.font=DEBUG.font; ctx.fillStyle='#E6F6FF';
    const txt=[
      `DEBUG: ${DEBUG.show?'ON':'OFF'}  (Acción para toggle)`,
      `cam: ${camX|0}, ${camY|0}  view: ${viewW|0}x${viewH|0}`,
      `player: ${player.x|0}, ${player.y|0}`
    ];
    let y=vp.dy+22;
    for(const line of txt){ ctx.fillText(line, vp.dx+12, y); y+=16; }
    ctx.restore();
  }

  // ===== JUANSIN =====
  const swp=sprites.size.w, shp=sprites.size.h, s=sprites.scale;
  const dw=Math.round(swp*s), dh=Math.round(shp*s); // tamaño EXACTO como tu script
  const px = vp.dx + Math.round((player.x - camX) * ZOOM * vp.k);
  const py = vp.dy + Math.round((player.y - camY) * ZOOM * vp.k);

  // sombra
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.beginPath();
  ctx.ellipse(px, py + dh/2 - 4, Math.round(dw/2.5), Math.round(dh/6), 0, 0, Math.PI*2);
  ctx.fill();

  const img = player.moving ? sprites.walk[player.dir][player.frame] : sprites.idle[player.dir][0];
  ctx.drawImage(img, 0,0, swp,shp, Math.round(px-dw/2), Math.round(py-dh/2), dw,dh);
}

/* ===== UTILS ===== */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function overlapsY(camY, viewH, y1, y2){ const a1=camY, a2=camY+viewH; return !(a2<y1 || a1>y2); }
function overlapsX(camX, viewW, x1, x2){ const a1=camX, a2=camX+viewW; return !(a2<x1 || a1>x2); }
</script>
</body>
</html>