<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Outside + NPC & Diálogo</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height: 100%; margin: 0; background: #111; display: flex; justify-content: center; align-items: center; }
  .gameboy { width: 100%; max-width: 500px; height: 100%; background: #000; display: flex; flex-direction: column;
    padding: 12px; box-sizing: border-box; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
  .screen-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #0B0A21; border-radius: 12px; padding: 10px; }
  .screen { aspect-ratio: 1/1; width: 100%; background: #0B0A21; display: flex; justify-content: center; align-items: center;
    border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.6); }
  canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; background: black; }

  .controls { height: 40%; background: #0B0A21; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; box-sizing: border-box; }
  .dpad { display: grid; grid-template-columns: repeat(3, 64px); grid-template-rows: repeat(3, 64px); gap: 0; justify-content: center; margin-left: 12px; align-content: center; overflow: visible; }
  .img-btn, .img-act { border: none; outline: none; padding: 0; background: transparent; cursor: pointer; transition: transform 0.06s ease, filter 0.06s ease; -webkit-tap-highlight-color: transparent; }
  .img-btn { width: 64px; height: 64px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.85)); }
  .img-btn.arrow::before { content: ""; display: block; width: 100%; height: 100%; background: url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering: pixelated; transform: rotate(var(--rot, 0deg)) scale(1.28); transform-origin: center center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width: 120px; height: 120px; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.85)); margin-top: 45px; justify-self: center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering: pixelated; transform: scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform: scale(0.95); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)) brightness(0.9); }

  .toast{ position:absolute; top:19px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff;
    font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space: nowrap; pointer-events:none; z-index:5; }
  .toast.show{ opacity:1; }

  .hud{
    position:absolute; left:8px; top:8px; color:#9ee7e7; font: 12px/1 monospace;
    text-shadow: 0 1px 0 #000; opacity:.75; user-select:none; z-index:6;
  }

  .boot-mask{ position:absolute; inset:0; background:#000; z-index:10; opacity:1; transition: opacity .25s ease; }
  .boot-mask.hidden{ opacity:0; pointer-events:none; }

  /* ====== OVERLAY DE CINEMÁTICA / DIÁLOGO ====== */
  .dialogue-overlay{
    position:absolute; inset:0; background: rgba(0,0,0,0.92);
    display:none; z-index:20; overflow:hidden;
  }
  .dialogue-overlay.show{ display:block; animation: fadeIn .18s ease both; }
  @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

  .portrait{
    position:absolute; bottom:0; width:100%; height:100%; pointer-events:none;
    display:flex; align-items:flex-end; justify-content:center;
  }
  .portrait img{
    width: 92%;
    max-width: 480px;
    image-rendering: pixelated;
    transform: translateX(var(--tx,0)) scale(1);
    opacity: 0;
    transition: transform .22s ease, opacity .22s ease;
    filter: drop-shadow(0 0 18px rgba(0,0,0,0.8));
  }
  .portrait.show img{ opacity:1; transform: translateX(0) }

  .portrait.left img{ --tx:-12%; }   /* entra desde la izquierda */
  .portrait.right img{ --tx:12%; }   /* entra desde la derecha */

  .dialogue-box{
    position:absolute; left:0; right:0; bottom:0;
    background: rgba(12,12,24,0.9); border-top: 2px solid #3cf; color:#E6F6FF;
    font-family: 'VT323', monospace; letter-spacing: .5px;
    padding: 12px 14px 16px; z-index:22;
  }
  .dialogue-name{
    font-family: 'Press Start 2P', system-ui; font-size: 10px; color:#8df; margin-bottom:6px;
    text-shadow: 0 1px 0 #000;
  }
  .dialogue-text{ font-size: 18px; line-height: 1.1; min-height: 2.2em; }
  .dialogue-hint{ font-size: 12px; opacity:.7; margin-top:6px }
  .choices{
    display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;
  }
  .choice{
    font-family: 'Press Start 2P', system-ui; font-size: 9px;
    padding:8px 10px; border:1px solid #8df; background:#0b1020; color:#e6f6ff; cursor:pointer;
    transition: transform .06s ease, filter .06s ease;
  }
  .choice:active{ transform: scale(0.96); filter: brightness(0.9); }
  .choice.selected{ outline:2px solid #fff; }

  /* “Pulsa Acción” globito */
  .bubble{
    position:absolute; transform: translate(-50%,-100%); padding:4px 6px; font: 600 12px/1 system-ui;
    color:#111; background:#fff; border-radius:6px; box-shadow:0 2px 0 rgba(0,0,0,0.6);
    pointer-events:none; z-index:7; display:none;
  }
  .bubble.show{ display:block; }
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>
      <div id="toast" class="toast"></div>
      <div id="hud" class="hud"></div>

      <!-- Globito de interacción -->
      <div id="bubble" class="bubble">Pulsa Acción</div>

      <!-- Overlay de diálogo/cinemática -->
      <div id="dlg" class="dialogue-overlay" aria-live="polite">
        <div id="portrait" class="portrait"><img id="portraitImg" alt=""></div>
        <div class="dialogue-box" id="dialogueBox">
          <div class="dialogue-name" id="dlgName"></div>
          <div class="dialogue-text" id="dlgText"></div>
          <div class="choices" id="dlgChoices" hidden></div>
          <div class="dialogue-hint" id="dlgHint">Toca la pantalla o pulsa Acción para continuar</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Controles táctiles -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ====== PROPORCIONES Y ESCALA ====== */
const roomOriginal = { w: 512, h: 350 };
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

/* ====== ASSETS ====== */
const MAP_IMG = "assets/locations/outside.PNG"; // vertical
const SPRITES_SHOES = {
  size: { w: 36, h: 40 },
  scale: 0.9,
  idle: {
    down:["assets/juan_character/idle_down_shoes.png"],
    up:["assets/juan_character/idle_up_shoes.png"],
    left:["assets/juan_character/idle_left_shoes.png"],
    right:["assets/juan_character/idle_right_shoes.png"]
  },
  walk: {
    down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"],
    up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"],
    left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"],
    right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"]
  }
};

/* ====== NPC (mismo tamaño que el jugador) ====== */
/* TODO: cambia las rutas del NPC si quieres otro sprite */
const SPRITES_NPC = {
  size: { w: 36, h: 40 },
  scale: 0.9,
  idle: {
    down:["assets/characters/gandalf.PNG"],
    up:["assets/characters/gandalf.PNG"],
    left:["assets/characters/gandalf.PNG"],
    right:["assets/characters/gandalf.PNG"]
  }
};

/* ====== RETRATOS GRANDES (cinemática) ====== */
/* TODO: cambia estas rutas a tus PNG grandes */
const PORTRAITS = {
  juan: "assets/characters/juansin_big.PNG",
  oldman: "assets/characters/gandalf_big.PNG"
};

/* ====== PLAYER ====== */
const player = {
  x: 0, y: 0,
  dir: 'up',
  speed: 230,
  moving: false,
  frame: 0, frameTime: 0
};
const meta = SPRITES_SHOES;

/* ====== NPC STATE ====== */
const npc = {
  x: 0, y: 0,
  dir: 'down',
  frame: 0,
  sprites: null
};

/* ====== INPUT ====== */
const keys = { up:false, down:false, left:false, right:false, act:false };
const mapKey = { ArrowUp:'up', KeyW:'up', ArrowDown:'down', KeyS:'down', ArrowLeft:'left', KeyA:'left', ArrowRight:'right', KeyD:'right', Space:'act', Enter:'act' };
window.addEventListener('keydown', e => { const d=mapKey[e.code]; if(d){ keys[d]=true; e.preventDefault(); handleActPress(d);} });
window.addEventListener('keyup',   e => { const d=mapKey[e.code]; if(d){ keys[d]=false; e.preventDefault(); }});
function bindHold(btn, on, off){
  const start = e => { e.preventDefault(); on(); };
  const end   = e => { e.preventDefault(); off(); };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  window.addEventListener('mouseup', end);
}
bindHold(document.getElementById('btn-up'),    ()=>keys.up=true,    ()=>keys.up=false);
bindHold(document.getElementById('btn-down'),  ()=>keys.down=true,  ()=>keys.down=false);
bindHold(document.getElementById('btn-left'),  ()=>keys.left=true,  ()=>keys.left=false);
bindHold(document.getElementById('btn-right'), ()=>keys.right=true, ()=>keys.right=false);
bindHold(document.getElementById('btn-act'),
  ()=>{ keys.act=true; handleActPress('act'); },
  ()=>{ keys.act=false; }
);

/* ====== CARGA DE IMÁGENES ====== */
const loadImage = (src) => new Promise(res=>{
  const img = new Image(); img.onload=()=>res(img); img.src = src;
});
async function preloadSprites(map){
  const out = { idle:{}, walk:{}, size: map.size, scale: map.scale };
  if(map.idle){
    for (const d of Object.keys(map.idle)){
      out.idle[d] = await Promise.all(map.idle[d].map(loadImage));
    }
  }
  if(map.walk){
    out.walk = {};
    for (const d of Object.keys(map.walk)){
      out.walk[d] = await Promise.all(map.walk[d].map(loadImage));
    }
  }
  return out;
}

/* ====== MAPA & CÁMARA ====== */
let bgRect = { dx:0, dy:0, dw:0, dh:0 }, scaleFactor = 1;
let mapImg=null, mapW=0, mapH=0;
let sprites=null;
let camY = 0, camMin=0, camMax=0;

/* ====== HELPERS ====== */
function resizeCanvas(){
  const screen = document.querySelector('.screen');
  canvas.width = screen.clientWidth;
  canvas.height = screen.clientHeight;

  scaleFactor = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
  bgRect.dw = roomOriginal.w * scaleFactor;
  bgRect.dh = roomOriginal.h * scaleFactor;
  bgRect.dx = (canvas.width - bgRect.dw) / 2;
  bgRect.dy = (canvas.height - bgRect.dh) / 2;

  if (mapImg){
    mapW = bgRect.dw;
    mapH = mapW * (mapImg.naturalHeight / mapImg.naturalWidth);

    const viewH = bgRect.dh;
    camMin = 0;
    camMax = Math.max(0, mapH - viewH);

    // Spawn jugador y NPC
    player.x = bgRect.dx + mapW/2;
    player.y = bgRect.dy + viewH*0.85;
    // Coloca el NPC en un punto del mapa (arriba-centro visible al empezar a moverte)
    npc.x = bgRect.dx + mapW/2 + 40;
    npc.y = bgRect.dy + viewH*0.35;

    camY = camMax;
  }
}

function showToast(msg, ms=1800){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(showToast._to);
  showToast._to = setTimeout(()=>t.classList.remove('show'), ms);
}

/* ====== BUBBLE “Pulsa Acción” ====== */
const bubble = document.getElementById('bubble');
function updateBubble(px, py, visible){
  if(!visible){ bubble.classList.remove('show'); return; }
  bubble.style.left = px + 'px';
  bubble.style.top = (py - 20) + 'px';
  bubble.classList.add('show');
}

/* ====== ESTADO DEL JUEGO ====== */
let mode = 'play'; // 'play' | 'dialogue'
let playerControlEnabled = true;

/* ====== DIÁLOGO ====== */
const dlgEl = document.getElementById('dlg');
const dlgName = document.getElementById('dlgName');
const dlgText = document.getElementById('dlgText');
const dlgChoices = document.getElementById('dlgChoices');
const dlgHint = document.getElementById('dlgHint');
const portraitWrap = document.getElementById('portrait');
const portraitImg = document.getElementById('portraitImg');

function setPortrait(speaker){
  const isJuan = (speaker === 'Juan');
  portraitWrap.classList.remove('left','right','show');
  // Juan entra desde la derecha; NPC (Señor) desde la izquierda
  portraitWrap.classList.add(isJuan ? 'right' : 'left');
  portraitImg.src = isJuan ? PORTRAITS.juan : PORTRAITS.oldman;
  // forzar reflow para reiniciar anim
  void portraitImg.offsetWidth;
  portraitWrap.classList.add('show');
}

function openDialogue(){
  mode = 'dialogue';
  playerControlEnabled = false;
  dlgEl.classList.add('show');
}
function closeDialogue(){
  dlgEl.classList.remove('show');
  mode = 'play';
  playerControlEnabled = true;
}

const DIALOGUE = {
  // guion con ids encadenados y una rama con opciones
  start: {
    speaker: 'Señor',
    text: 'Hola chico.',
    next: 'intro2'
  },
  intro2: {
    speaker: 'Señor',
    text: 'Te estaba esperando aquí fuera. ¿Tienes un minuto?',
    next: 'juan1'
  },
  juan1: {
    speaker: 'Juan',
    text: 'Sí, dime. (dimmi!)',
    next: 'señor_opciones'
  },
  señor_opciones: {
    speaker: 'Señor',
    text: 'Puedo ayudarte de dos maneras. ¿Qué prefieres?',
    choices: [
      { label: 'Saber un secreto', next: 'secreto' },
      { label: 'Un consejo', next: 'consejo' }
    ]
  },
  secreto: {
    speaker: 'Señor',
    text: 'El camino del norte se abre solo al caer la tarde.',
    next: 'juan2'
  },
  consejo: {
    speaker: 'Señor',
    text: 'Muévete con calma y observa el entorno. Piano piano.',
    next: 'juan2'
  },
  juan2: {
    speaker: 'Juan',
    text: 'Gracias. Me será útil.',
    next: 'fin'
  },
  fin: {
    speaker: 'Señor',
    text: 'Va bene. ¡Suerte ahí fuera!',
    end: true
  }
};

let currentNodeId = null;
let choiceIndex = 0;

function showNode(id){
  currentNodeId = id;
  const node = DIALOGUE[id];
  if(!node){ closeDialogue(); return; }

  setPortrait(node.speaker);
  dlgName.textContent = node.speaker;
  dlgText.textContent = node.text || '';
  dlgChoices.innerHTML = '';

  if(node.choices){
    dlgChoices.hidden = false;
    choiceIndex = 0;
    node.choices.forEach((c, i)=>{
      const btn = document.createElement('button');
      btn.className = 'choice' + (i===0?' selected':'');
      btn.textContent = c.label;
      btn.addEventListener('click', e=>{
        proceedTo(c.next);
      });
      dlgChoices.appendChild(btn);
    });
    dlgHint.textContent = 'Toca una opción • Usa ← → y Acción';
  } else {
    dlgChoices.hidden = true;
    dlgHint.textContent = 'Toca la pantalla o pulsa Acción para continuar';
  }
}

function proceed(){
  const node = DIALOGUE[currentNodeId];
  if(!node) return;

  if(node.choices){
    // si hay opciones, activar la seleccion actual
    const targetNext = node.choices[choiceIndex]?.next;
    if(targetNext) proceedTo(targetNext);
    return;
  }
  if(node.end){ closeDialogue(); return; }
  if(node.next){ showNode(node.next); }
  else{ closeDialogue(); }
}

function proceedTo(nextId){
  showNode(nextId);
}

function moveChoice(dir){
  const node = DIALOGUE[currentNodeId];
  if(!node || !node.choices) return;
  const total = node.choices.length;
  choiceIndex = (choiceIndex + (dir==='right'?1:-1) + total) % total;
  [...dlgChoices.children].forEach((el,i)=>{
    el.classList.toggle('selected', i===choiceIndex);
  });
}

dlgEl.addEventListener('click', ()=>{
  // Si no hay choices, avanzar con click/tap sobre overlay
  const node = DIALOGUE[currentNodeId];
  if(node && !node.choices) proceed();
});

/* ====== RUNTIME ====== */
function update(dt){
  // si estamos en diálogo, no mover al jugador
  if(mode === 'dialogue'){ return; }

  const vx = (keys.left?-1:0) + (keys.right?1:0);
  const vy = (keys.up?-1:0) + (keys.down?1:0);
  player.moving = (vx!==0 || vy!==0);

  if (player.moving && playerControlEnabled){
    player.dir = Math.abs(vx) > Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len = Math.hypot(vx,vy) || 1;
    player.x += (vx/len) * player.speed * dt;
    player.y += (vy/len) * player.speed * dt;

    const halfW = Math.round(meta.size.w * meta.scale)/2;
    const halfH = Math.round(meta.size.h * meta.scale)/2;
    const minX = bgRect.dx + halfW, maxX = bgRect.dx + bgRect.dw - halfW;
    const minY = bgRect.dy + halfH, maxY = bgRect.dy + bgRect.dh - halfH;
    player.x = Math.max(minX, Math.min(maxX, player.x));
    player.y = Math.max(minY, Math.min(maxY, player.y));

    player.frameTime += dt;
    if(player.frameTime >= 0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else {
    player.frame = 0;
  }

  // seguimiento vertical
  const yInView = (player.y - bgRect.dy);
  const topBand = bgRect.dh*0.35, bottomBand = bgRect.dh*0.65;
  if (yInView < topBand){
    camY = Math.max(camMin, camY - (topBand - yInView));
  } else if (yInView > bottomBand){
    camY = Math.min(camMax, camY + (yInView - bottomBand));
  }

  // HUD
  document.getElementById('hud').textContent =
    `camY:${camY.toFixed(1)}  px:${player.x.toFixed(1)},${player.y.toFixed(1)}`;

  // Mostrar bubble si estamos cerca del NPC
  const near = isNearNPC();
  updateBubble(npc.x, npc.y - 20, near);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Marco negro
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if (!mapImg) return;

  // recorte del mapa
  const sx = 0;
  const sy = camY * (mapImg.naturalWidth / mapW);
  const sWidth  = mapImg.naturalWidth;
  const sHeight = (bgRect.dh) * (mapImg.naturalWidth / mapW);

  ctx.save();
  ctx.beginPath(); ctx.rect(bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh); ctx.clip();
  ctx.drawImage(mapImg, sx, sy, sWidth, sHeight, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);

  // ====== NPC ======
  if(npc.sprites){
    const sw=npc.sprites.size.w, sh=npc.sprites.size.h;
    const dw=Math.round(sw*npc.sprites.scale), dh=Math.round(sh*npc.sprites.scale);
    const img = npc.sprites.idle[npc.dir][0];
    // sombra
    ctx.fillStyle='rgba(0,0,0,0.28)';
    ctx.beginPath();
    ctx.ellipse(Math.round(npc.x), Math.round(npc.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.drawImage(img, 0,0, sw,sh, Math.round(npc.x-dw/2), Math.round(npc.y-dh/2), dw, dh);
  }

  // ====== PLAYER ======
  const sw=meta.size.w, sh=meta.size.h;
  const dw=Math.round(sw*meta.scale), dh=Math.round(sh*meta.scale);
  const img = player.moving ? sprites.walk[player.dir][player.frame] : sprites.idle[player.dir][0];
  // sombra
  ctx.fillStyle='rgba(0,0,0,0.28)';
  ctx.beginPath();
  ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.drawImage(img, 0,0, sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2), dw, dh);

  ctx.restore();
}

/* ====== INTERACCIÓN CON NPC ====== */
function isNearNPC(){
  // usamos distancia circular pequeña y mismo plano “vista”
  const dx = player.x - npc.x;
  const dy = (player.y - npc.y);
  const dist = Math.hypot(dx, dy);
  const threshold = 28; // ajusta al gusto (en px de la vista)
  return dist < threshold;
}

function tryTalk(){
  if(!isNearNPC()) { showToast('Acércate un poco…'); return; }
  openDialogue();
  showNode('start');
}

/* ====== INIT ====== */
async function init(){
  const [map, sprPlayer, sprNPC] = await Promise.all([
    loadImage(MAP_IMG),
    preloadSprites(SPRITES_SHOES),
    preloadSprites(SPRITES_NPC)
  ]);
  mapImg = map; sprites = sprPlayer; npc.sprites = sprNPC;

  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  // posición inicial (se recalcula en resizeCanvas)
  const viewH = bgRect.dh || 1;
  player.x = bgRect.dx + bgRect.dw/2;
  player.y = bgRect.dy + viewH*0.85;

  mapW = bgRect.dw;
  mapH = mapW * (mapImg.naturalHeight / mapImg.naturalWidth);
  camMin = 0;
  camMax = Math.max(0, mapH - bgRect.dh);
  camY = camMax;

  document.getElementById('bootMask').classList.add('hidden');
  requestAnimationFrame(loop);

  // Acción
  document.getElementById('btn-act').addEventListener('click', e=>{
    e.preventDefault();
    if(mode==='play') tryTalk(); else proceed();
  }, {passive:false});

  document.getElementById('btn-act').addEventListener('touchstart', e=>{
    e.preventDefault();
    if(mode==='play') tryTalk(); else proceed();
  }, {passive:false});

  // teclas izq/der para navegar opciones cuando hay choices
  window.addEventListener('keydown', e=>{
    if(mode!=='dialogue') return;
    if(e.code==='ArrowLeft'){ e.preventDefault(); moveChoice('left'); }
    if(e.code==='ArrowRight'){ e.preventDefault(); moveChoice('right'); }
  });
}

function loop(now){
  if(!loop.last) loop.last=now;
  const dt = Math.min(1/30,(now-loop.last)/1000);
  loop.last=now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

function handleActPress(source){
  if(source!=='act') return;
  if(mode==='play'){ /* si estás cerca del NPC, hablar */
    // lo maneja el botón/touch también; aquí por teclado:
    if(isNearNPC()) tryTalk();
  } else {
    proceed();
  }
}

init();
</script>
</body>
</html>