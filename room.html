<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin 30th birthday - room</title>
<style>
  html, body {
    height: 100%; margin: 0; background: #111;
    display: flex; justify-content: center; align-items: center;
  }
  .gameboy {
    width: 100%; max-width: 500px; height: 100%;
    background: #000; display: flex; flex-direction: column;
    padding: 12px; box-sizing: border-box; border-radius: 20px;
    box-shadow: 0 0 40px rgba(0,0,0,0.6);
  }
  .screen-container {
    flex: 1; display: flex; justify-content: center; align-items: center;
    background: #0B0A21; border-radius: 12px; padding: 10px;
  }
  .screen {
    aspect-ratio: 1/1; width: 100%; background: #0B0A21;
    display: flex; justify-content: center; align-items: center;
    border-radius: 8px; overflow: hidden; position: relative;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
  }
  canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; background: black; }

  /* Controles */
  .controls {
    height: 40%; background: #0B0A21; display: grid; grid-template-columns: 1fr 1fr;
    gap: 14px; padding: 14px; box-sizing: border-box;
  }
  .dpad { display: grid; grid-template-columns: repeat(3, 64px); grid-template-rows: repeat(3, 64px);
    gap: 0; justify-content: center; margin-left: 12px; align-content: center; overflow: visible; }
  .img-btn, .img-act {
    border: none; outline: none; padding: 0; background: transparent; cursor: pointer;
    transition: transform 0.06s ease, filter 0.06s ease; -webkit-tap-highlight-color: transparent;
  }
  .img-btn { width: 64px; height: 64px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.85)); }
  .img-btn.arrow::before {
    content: ""; display: block; width: 100%; height: 100%;
    background: url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering: pixelated;
    transform: rotate(var(--rot, 0deg)) scale(1.28); transform-origin: center center;
  }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width: 120px; height: 120px; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.85)); margin-top: 45px; justify-self: center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering: pixelated; transform: scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform: scale(0.95); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)) brightness(0.9); }

  /* Toast */
  .toast{
    position:absolute; top:19px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.8); color:#fff; font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space: nowrap; pointer-events:none; z-index:5;
  }
  .toast.show{ opacity:1; }
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <canvas id="game"></canvas>
      <div id="toast" class="toast"></div>
    </div>
  </div>

  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up"    class="img-btn arrow btn-up"    aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left"  class="img-btn arrow btn-left"  aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down"  class="img-btn arrow btn-down"  aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== CONFIG DEBUG ===== */
const DEBUG = false;

/* ===== SPRITES ===== */
const SPRITES_NORMAL = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: { down:["assets/juan_character/idle_down.png"], up:["assets/juan_character/idle_up.png"], left:["assets/juan_character/idle_left.png"], right:["assets/juan_character/idle_right.png"] },
  walk: { down:["assets/juan_character/walk_down_0.png","assets/juan_character/walk_down_1.png"], up:["assets/juan_character/walk_up_0.png","assets/juan_character/walk_up_1.png"], left:["assets/juan_character/walk_left_0.png","assets/juan_character/walk_left_1.png"], right:["assets/juan_character/walk_right_0.png","assets/juan_character/walk_right_1.png"] }
};
const SPRITES_SHOES = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: { down:["assets/juan_character/idle_down_shoes.png"], up:["assets/juan_character/idle_up_shoes.png"], left:["assets/juan_character/idle_left_shoes.png"], right:["assets/juan_character/idle_right_shoes.png"] },
  walk: { down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"], up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"], left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"], right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"] }
};

/* ===== AUDIO ===== */
let bgMusic = new Audio("assets/sounds/ambient1.mp3"); bgMusic.loop = true; bgMusic.volume = 0.4;
const pickupSnd = new Audio("assets/sounds/pickup.mp3"); pickupSnd.volume = 0.7;

/* ===== IMÁGENES ===== */
const BACKGROUND = "assets/locations/room.PNG";
const PLANT1_IMG = "assets/objects/plant1.PNG";
const SOFA_IMG   = "assets/objects/sofa.png";
const TVON_IMG   = "assets/objects/tv_on.png";
const TVOFF_IMG  = "assets/objects/tv_off.png";
const BED_IMG    = "assets/objects/bed.PNG";
const SANDALS_IMG= "assets/objects/shoes.PNG";
const LAMP_IMG= "assets/objects/lamp.PNG";

let bgImg=null, plant1Img=null, lampImg=null, sofaImg=null, tvOnImg=null, tvOffImg=null, bedImg=null, sandalsImg=null;
let tvOn = true;
let lampOn = false; 

/* ===== CANVAS/ESCALADO ===== */
const roomOriginal = { w: 512, h: 350 };
let bgRect = { dx:0, dy:0, dw:0, dh:0 }, scaleFactor = 1;

/* ===== BOUNDS/OBJETOS (BASE) ===== */
const boundsBase   = { x: 20, y: 85, w: 465, h: 235 };
const obstaclesBase= [
  { x: 230, y: 25,  w: 70,  h: 50 }, // TV
  { x: 0,   y: 190, w: 95,  h: 38 }, // Cama
  { x: 0,   y: 260, w: 40,  h: 21 }, // Planta
  { x: 450, y: 250, w: 15,  h: 0.5}, // Pelota
  { x: 5,   y: 25,  w: 110, h: 50 }, // Estanteria
  { x: 195, y: 170, w: 170, h: 0.5}  // Sofa
];
const sofaBase    = { x:170, y:75,  w:220, h:180 };
const tvOnBase    = { x:205, y:35,  w:125, h:90  };
const bedBase     = { x:3,   y:155, w:120, h:130 };
const plant1Base  = { x:3,   y:230, w:60,  h:90  };
const sandalsBase = { x:55,  y:270, w:50,  h:50  };
const lampBase = { x: 110, y: 8, w: 60, h: 95 };

/* ===== ZONA INVISIBLE DELANTE DE LA TV ===== */
const TV_INTERACT_MARGIN = 0;   // ancho extra a cada lado
const TV_INTERACT_DEPTH  = 2;   // profundidad hacia abajo
const tvInteractBase = {
  x: tvOnBase.x - TV_INTERACT_MARGIN,
  y: tvOnBase.y + tvOnBase.h - 40,
  w: tvOnBase.w + TV_INTERACT_MARGIN*2,
  h: TV_INTERACT_DEPTH
};

const playerStartBase = { x: 260, y: 150 };

/* ===== POS ESCALADAS ===== */
let bounds={}, obstacles=[], bedPos={}, sofaPos={}, lampPos={}, plant1Pos={}, tvPos={}, sandalsPos={}, tvInteractPos={};

function updateScaledBounds(){
  bounds = {
    x: bgRect.dx + Math.round(boundsBase.x * scaleFactor),
    y: bgRect.dy + Math.round(boundsBase.y * scaleFactor),
    w: Math.round(boundsBase.w * scaleFactor),
    h: Math.round(boundsBase.h * scaleFactor),
  };
  obstacles = obstaclesBase.map(o=>({
    x: bgRect.dx + Math.round(o.x * scaleFactor),
    y: bgRect.dy + Math.round(o.y * scaleFactor),
    w: Math.round(o.w * scaleFactor),
    h: Math.round(o.h * scaleFactor),
  }));
  sofaPos = { x:bgRect.dx+Math.round(sofaBase.x*scaleFactor), y:bgRect.dy+Math.round(sofaBase.y*scaleFactor), w:Math.round(sofaBase.w*scaleFactor), h:Math.round(sofaBase.h*scaleFactor) };
  tvPos   = { x:bgRect.dx+Math.round(tvOnBase.x*scaleFactor), y:bgRect.dy+Math.round(tvOnBase.y*scaleFactor), w:Math.round(tvOnBase.w*scaleFactor), h:Math.round(tvOnBase.h*scaleFactor) };
  tvInteractPos = { x:bgRect.dx+Math.round(tvInteractBase.x*scaleFactor), y:bgRect.dy+Math.round(tvInteractBase.y*scaleFactor), w:Math.round(tvInteractBase.w*scaleFactor), h:Math.round(tvInteractBase.h*scaleFactor) };
  bedPos  = { x:bgRect.dx+Math.round(bedBase.x*scaleFactor), y:bgRect.dy+Math.round(bedBase.y*scaleFactor), w:Math.round(bedBase.w*scaleFactor), h:Math.round(bedBase.h*scaleFactor) };
  plant1Pos = { x:bgRect.dx+Math.round(plant1Base.x*scaleFactor), y:bgRect.dy+Math.round(plant1Base.y*scaleFactor), w:Math.round(plant1Base.w*scaleFactor), h:Math.round(plant1Base.h*scaleFactor) };
  lampPos = { x:bgRect.dx+Math.round(lampBase.x*scaleFactor), y:bgRect.dy+Math.round(lampBase.y*scaleFactor), w:Math.round(lampBase.w*scaleFactor), h:Math.round(lampBase.h*scaleFactor) };
  sandalsPos = { x:bgRect.dx+Math.round(sandalsBase.x*scaleFactor), y:bgRect.dy+Math.round(sandalsBase.y*scaleFactor), w:Math.round(sandalsBase.w*scaleFactor), h:Math.round(sandalsBase.h*scaleFactor) };
}

const loadImage = (src) => new Promise(res=>{
  const img = new Image();
  img.onload = ()=>res(img);
  img.onerror = ()=>{
    console.warn('No se pudo cargar:', src);
    const ph = document.createElement('canvas'); ph.width=ph.height=1; res(ph);
  };
  img.src = src;
});

async function preloadSprites(map){
  const result = { idle:{}, walk:{}, size: map.size, scale: map.scale };
  for (const state of ["idle","walk"]){
    for (const dir of Object.keys(map[state])){
      result[state][dir] = await Promise.all(map[state][dir].map(loadImage));
    }
  }
  return result;
}

/* ===== CANVAS ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

function resizeCanvas(){
  const screen = document.querySelector('.screen');
  canvas.width = screen.clientWidth;
  canvas.height = screen.clientHeight;
  if (bgImg){
    scaleFactor = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
    bgRect.dw = roomOriginal.w * scaleFactor;
    bgRect.dh = roomOriginal.h * scaleFactor;
    bgRect.dx = (canvas.width - bgRect.dw) / 2;
    bgRect.dy = (canvas.height - bgRect.dh) / 2;
    updateScaledBounds();
    // Coloca al jugador tras recalcular posiciones
    player.x = bgRect.dx + Math.round(playerStartBase.x * scaleFactor);
    player.y = bgRect.dy + Math.round(playerStartBase.y * scaleFactor);
  }
}
window.addEventListener('resize', resizeCanvas);

/* ===== INPUT ===== */
const player = { x:0, y:0, speed:200, dir:'up', moving:false, frame:0, frameTime:0 };
const keys = { up:false, down:false, left:false, right:false };

function bindHold(btn, on, off){
  const start = e => { e.preventDefault(); on(); };
  const end   = e => { e.preventDefault(); off(); };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  window.addEventListener('mouseup', end);
}
bindHold(document.getElementById('btn-up'),    ()=>keys.up=true,    ()=>keys.up=false);
bindHold(document.getElementById('btn-down'),  ()=>keys.down=true,  ()=>keys.down=false);
bindHold(document.getElementById('btn-left'),  ()=>keys.left=true,  ()=>keys.left=false);
bindHold(document.getElementById('btn-right'), ()=>keys.right=true, ()=>keys.right=false);

function bindPressVisual(el){
  const on = ()=>el.classList.add('pressed');
  const off= ()=>el.classList.remove('pressed');
  el.addEventListener('mousedown', on); el.addEventListener('mouseup', off); el.addEventListener('mouseleave', off);
  el.addEventListener('touchstart', (e)=>{ e.preventDefault(); on(); }, {passive:false});
  el.addEventListener('touchend', off, {passive:false}); el.addEventListener('touchcancel', off, {passive:false});
}
['btn-up','btn-down','btn-left','btn-right','btn-act'].forEach(id=>{ const el=document.getElementById(id); if(el) bindPressVisual(el); });

const mapKey = { ArrowUp:'up', KeyW:'up', ArrowDown:'down', KeyS:'down', ArrowLeft:'left', KeyA:'left', ArrowRight:'right', KeyD:'right' };
window.addEventListener('keydown', e => { const d=mapKey[e.code]; if(d){ keys[d]=true; e.preventDefault(); }});
window.addEventListener('keyup',   e => { const d=mapKey[e.code]; if(d){ keys[d]=false; e.preventDefault(); }});

/* ===== META/ASSETS ===== */
let assets=null, assetsNormal=null, assetsShoes=null;
function currentMeta(){ return { size: assets.size, scale: assets.scale ?? SPRITES_NORMAL.scale, ...assets }; }

/* ===== COLISIONES ===== */
function collides(x, y){
  const halfW = currentMeta().size.w * currentMeta().scale / 2;
  const halfH = currentMeta().size.h * currentMeta().scale / 2;
  const px = x - halfW, py = y - halfH, pw = halfW*2, ph = halfH*2;
  if (x < bounds.x || x > bounds.x + bounds.w || y < bounds.y || y > bounds.y + bounds.h) return true;
  for (const o of obstacles){ if (px < o.x + o.w && px + pw > o.x && py < o.y + o.h && py + ph > o.y) return true; }
  return false;
}
function getPlayerRect(x=player.x,y=player.y){
  const halfW = currentMeta().size.w * currentMeta().scale / 2;
  const halfH = currentMeta().size.h * currentMeta().scale / 2;
  return { x:x-halfW, y:y-halfH, w:halfW*2, h:halfH*2 };
}
function aabb(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

/* ===== TOASTS ===== */
function showToast(msg, ms=2000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(showToast._to);
  showToast._to = setTimeout(()=>t.classList.remove('show'), ms);
}

/* ===== ACCIÓN TV (una sola vez apagar) ===== */
let tvAlreadyOff = false;
function handleAction() {
  const insideTV = aabb(getPlayerRect(), tvInteractPos);
  if (insideTV) {
    if (tvOn && !tvAlreadyOff) {
      tvOn = false; tvAlreadyOff = true;
    } else if (!tvOn) {
      showToast('No más Tekken por hoy.');
    }
    return; // <- para que no siga comprobando planta en el mismo click
  }


  // LÁMPARA
const lampInteractPos = {
    x: lampPos.x,
    y: lampPos.y,
    w: lampPos.w,
    h: lampPos.h
  };

  const insideLamp = aabb(getPlayerRect(), lampInteractPos);
  if (insideLamp) {
    lampOn = !lampOn;
    showToast(lampOn ? 'Lámpara encendida' : 'Lámpara apagada');
    return;
  }


  // --- NUEVO: zona de interacción con planta ---
  const plantInteractPos = {
    x: plant1Pos.x,
    y: plant1Pos.y,
    w: plant1Pos.w,
    h: plant1Pos.h
  };
  const insidePlant = aabb(getPlayerRect(), plantInteractPos);
  if (insidePlant) {
    showToast('10 años regándola y ni un solo aguacate...');
    return;
  }

  const bedInteractPos = {
    x: bedPos.x,
    y: bedPos.y,
    w: bedPos.w,
    h: bedPos.h
  };
  const insideBed = aabb(getPlayerRect(), bedInteractPos);
  if (insideBed) {
    showToast('Todavía no es hora de dormir.');
    return;
  }
}
const actBtn = document.getElementById('btn-act');
actBtn.addEventListener('click', (e)=>{ e.preventDefault(); handleAction(); });
actBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); handleAction(); }, {passive:false});
window.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'Enter'){ e.preventDefault(); handleAction(); }
}, { passive:false });

/* ===== EQUIP ===== */
let hasShoes = false;
function equipShoes(){
  if (hasShoes) return;
  hasShoes = true;
  try { pickupSnd.currentTime = 0; pickupSnd.play(); } catch(e){}
  assets = assetsShoes || assets;
  player.speed = 230;
  sandalsImg = null;
}

/* ===== PRIMER AVANCE (arriba) ===== */
let forwardToastShown = false;

/* ===== LOOP ===== */
function update(dt){
  const vx = (keys.left?-1:0) + (keys.right?1:0);
  const vy = (keys.up?-1:0) + (keys.down?1:0);
  player.moving = (vx!==0 || vy!==0);

  // cálculo de movimiento propuesto
  let movedUpThisFrame = false;
  if (player.moving){
    player.dir = Math.abs(vx) > Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len = Math.hypot(vx,vy) || 1;
    const nx = (vx/len) * player.speed * dt;
    const ny = (vy/len) * player.speed * dt;
    const newX = player.x + nx, newY = player.y + ny;
    const canMove = !collides(newX,newY);
    if (canMove){
      // detecta si realmente avanzó hacia arriba este frame
      if (vy < 0) movedUpThisFrame = true;
      player.x=newX; player.y=newY;
    }
    player.frameTime += dt; if(player.frameTime >= 0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else {
    player.frame = 0;
  }

  // toast de “primer avance” solo 1 vez y solo si se movió arriba de verdad
  if (movedUpThisFrame && !forwardToastShown){
    forwardToastShown = true;
    showToast('Ya he jugado bastante por hoy.');
  }

  // pickup chanclas
  if (!hasShoes && sandalsImg){
    const reduce=0.5, p=getPlayerRect();
    const r={ x:p.x+p.w*(1-reduce)/2, y:p.y+p.h*(1-reduce)/2, w:p.w*reduce, h:p.h*reduce };
    const s=sandalsPos;
    if (r.x < s.x + s.w && r.x + r.w > s.x && r.y < s.y + s.h && r.y + r.h > s.y) equipShoes();
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (bgImg){
    const s = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
    bgRect.dw = roomOriginal.w*s; bgRect.dh = roomOriginal.h*s;
    bgRect.dx = (canvas.width-bgRect.dw)/2; bgRect.dy = (canvas.height-bgRect.dh)/2;
    ctx.drawImage(bgImg, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);
  }
  if (!assets) return;

  const sw=currentMeta().size.w, sh=currentMeta().size.h;
  const dw=Math.round(sw*SPRITES_NORMAL.scale), dh=Math.round(sh*SPRITES_NORMAL.scale);
  const img = player.moving ? assets.walk[player.dir][player.frame] : assets.idle[player.dir][0];

  let stretchPx=0;
  if (!player.moving){ const Hz=0.6, t=performance.now()/1000; stretchPx=Math.round((Math.sin(t*Math.PI*2*Hz)*0.5+0.5)*1); }

  const list=[];
  // TV
  list.push({ y: tvPos.y, draw: ()=>{ const timg = tvOn ? tvOnImg : tvOffImg; if (timg && timg.width) ctx.drawImage(timg, tvPos.x, tvPos.y, tvPos.w, tvPos.h);} });
  if (lampImg && lampImg.width) {
    list.push({ y: lampPos.y + lampPos.h/2, draw: ()=>ctx.drawImage(lampImg, lampPos.x, lampPos.y, lampPos.w, lampPos.h) });
  }
  if (plant1Img && plant1Img.width) list.push({ y: plant1Pos.y, draw: ()=>ctx.drawImage(plant1Img, plant1Pos.x, plant1Pos.y, plant1Pos.w, plant1Pos.h) });
  if (sofaImg && sofaImg.width)     list.push({ y: sofaPos.y + sofaPos.h/2, draw: ()=>ctx.drawImage(sofaImg, sofaPos.x, sofaPos.y, sofaPos.w, sofaPos.h) });
  if (bedImg && bedImg.width)       list.push({ y: bedPos.y + bedPos.h/2, draw: ()=>ctx.drawImage(bedImg, bedPos.x, bedPos.y, bedPos.w, bedPos.h) });

  if (!hasShoes && sandalsImg && sandalsImg.width){
    list.push({ y: sandalsPos.y + sandalsPos.h/2, draw: ()=>ctx.drawImage(sandalsImg, sandalsPos.x, sandalsPos.y, sandalsPos.w, sandalsPos.h) });
  }

  // player
  list.push({ y: player.y, draw: ()=>{
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(img, 0,0, sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2)-stretchPx, dw, dh+stretchPx);
  }});
  list.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());

  // oscurecido
  ctx.fillStyle='rgba(0,0,0,0.40)';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // luz TV solo si está ON
  if (tvOn){
    const flicker = 0.35 + Math.random()*0.05;
    drawLightClipped(tvPos.x + tvPos.w/2, tvPos.y + tvPos.h/2, 100, flicker);
  }
  
  if (lampOn){
    const flicker = 0.30 + Math.random()*0.04;
    drawLightClipped(lampPos.x + lampPos.w/2, lampPos.y + lampPos.h/3, 90, flicker);
  }


  // DEBUG: zona de interacción
  if (DEBUG){
    ctx.save();
    ctx.fillStyle='rgba(0,200,255,0.12)';
    ctx.fillRect(tvInteractPos.x, tvInteractPos.y, tvInteractPos.w, tvInteractPos.h);
    ctx.strokeStyle='rgba(0,200,255,0.35)';
    ctx.strokeRect(tvInteractPos.x, tvInteractPos.y, tvInteractPos.w, tvInteractPos.h);
    ctx.restore();
  }
}

function drawLightClipped(x,y,radius,intensity){
  if (!bgRect || !bgRect.dw || !bgRect.dh) return;
  const radiusScaled = radius * (bgRect.dw / roomOriginal.w);
  ctx.save();
  ctx.beginPath(); ctx.rect(bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh); ctx.clip();
  const g = ctx.createRadialGradient(x,y,0,x,y,radiusScaled);
  g.addColorStop(0, `rgba(255,255,200,${intensity})`);
  g.addColorStop(1, 'rgba(255,255,200,0)');
  ctx.globalCompositeOperation="lighter";
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,radiusScaled,0,Math.PI*2); ctx.fill();
  ctx.restore(); ctx.globalCompositeOperation="source-over";
}

function loop(now){
  if(!loop.last) loop.last=now;
  const dt = Math.min(1/30,(now-loop.last)/1000);
  loop.last=now; update(dt); draw(); requestAnimationFrame(loop);
}

/* ===== INIT ===== */
async function init(){
  const [bg, sofa, tvOnI, tvOffI, bed, plant, sandals, lamp, normalSet, shoesSet] = await Promise.all([
    loadImage(BACKGROUND), loadImage(SOFA_IMG), loadImage(TVON_IMG), loadImage(TVOFF_IMG),
    loadImage(BED_IMG), loadImage(PLANT1_IMG), loadImage(SANDALS_IMG), loadImage(LAMP_IMG),
    preloadSprites(SPRITES_NORMAL), preloadSprites(SPRITES_SHOES)
  ]);
  bgImg=bg; sofaImg=sofa; tvOnImg=tvOnI; lampImg=lamp; tvOffImg=tvOffI; bedImg=bed; plant1Img=plant; sandalsImg=sandals;
  assetsNormal=normalSet; assetsShoes=shoesSet; assets=assetsNormal;
  try{ bgMusic.play(); }catch(e){}
  resizeCanvas();
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>