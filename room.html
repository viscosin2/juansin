<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin 30th birthday - room</title>

<!-- Pixel font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
  html, body { height: 100%; margin: 0; background: #111; display: flex; justify-content: center; align-items: center; }
  .gameboy { width: 100%; max-width: 500px; height: 100%; background: #000; display: flex; flex-direction: column;
    padding: 12px; box-sizing: border-box; border-radius: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
  .screen-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #0B0A21; border-radius: 12px; padding: 10px; }
  .screen { aspect-ratio: 1/1; width: 100%; background: #0B0A21; display: flex; justify-content: center; align-items: center;
    border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.6); }
  canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; background: black; }

  .controls { height: 40%; background: #0B0A21; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 14px; box-sizing: border-box; }
  .dpad { display: grid; grid-template-columns: repeat(3, 64px); grid-template-rows: repeat(3, 64px); gap: 0; justify-content: center; margin-left: 12px; align-content: center; overflow: visible; }
  .img-btn, .img-act { border: none; outline: none; padding: 0; background: transparent; cursor: pointer; transition: transform 0.06s ease, filter 0.06s ease; -webkit-tap-highlight-color: transparent; }
  .img-btn { width: 64px; height: 64px; filter: drop-shadow(0 3px 4px rgba(0,0,0,0.85)); }
  .img-btn.arrow::before { content: ""; display: block; width: 100%; height: 100%; background: url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering: pixelated; transform: rotate(var(--rot, 0deg)) scale(1.28); transform-origin: center center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width: 120px; height: 120px; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.85)); margin-top: 45px; justify-self: center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering: pixelated; transform: scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform: scale(0.95); filter: drop-shadow(0 2px 3px rgba(0,0,0,0.7)) brightness(0.9); }

  .toast{ position:absolute; top:19px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space: nowrap; pointer-events:none; z-index:5; }
  .toast.show{ opacity:1; }

/* ===== Estilo "pixel" con nombre ===== */

/* ===== Layout base del cuadro de diálogo ===== */
.dialog {
  position: absolute;
  left: 50%;
  bottom: 10px;
  transform: translateX(-50%) scaleX(0);
  transform-origin: center bottom;
  width: calc(100% - 24px);
  max-width: 460px;
  min-height: 20px;
  box-sizing: border-box;
  padding: 12px 16px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-radius: 10px;
  image-rendering: pixelated;
  z-index: 6;
  transition: transform .22s ease;
}

/* Animación de entrada/salida */
.dialog.show { transform: translateX(-50%) scaleX(1); }
.dialog {
  background: rgba(12,12,24,0.9);
  border: none;
  border-top: 2px solid #3cf;
  display: flex;
  align-items: flex-start;
  flex-direction: column;
  padding: 10px;
  text-align: left;
}

.dialog-name {
  font-family: 'Press Start 2P', system-ui;
  font-size: 10px;
  color:#8df;
  margin-bottom: 4px;   /* separa el nombre del texto */
  text-shadow: 0 1px 0 #000;
}

.dialog-text {
  font-family: 'VT323', monospace;
  font-size: 18px;
  letter-spacing: 1px;
  line-height: 1.15;
  color: #E6F6FF;
  min-height: 2.2em;
}
.dialog-hint{
  margin-left: auto;
  border: none !important;
  color:#B8D7FF;
  font: 600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  opacity: .0; transition: opacity .18s ease;
}
.dialog.ready .dialog-hint { opacity: .9; }
  .scene-fade{ position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:999; transition: opacity .45s ease; }
  .scene-fade.show{ opacity:1; }

  /* ===== PRESS TO START (pixel) ===== */
  .banner{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-family: "Press Start 2P", monospace; font-size: 12px; letter-spacing:1px;
    background: rgba(0,0,0,.0); color:#E6D0A3; user-select:none; z-index: 998;
    text-shadow: 2px 2px 0 #0b2346;
    opacity: 0; pointer-events: none; /* se mostrará al estar listo */
    animation: blink 1.1s steps(2, jump-none) infinite;
  }
  .banner.show{ opacity: 1; pointer-events: auto; }
  .banner.hide{ display:none; }
  @keyframes blink { 0%{opacity:0} 50%{opacity:1} 100%{opacity:0} }

  /* ===== BOOT MASK: pantalla negra hasta que cargue todo ===== */
  .boot-mask{
    position:absolute; inset:0; background:#000; z-index: 1000;
    opacity: 1; transition: opacity .25s ease;
  }
  .boot-mask.hidden{ opacity:0; pointer-events:none; }



</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <!-- Pantalla negra que tapa todo hasta que assets listo -->
      <div id="bootMask" class="boot-mask"></div>

      <canvas id="game"></canvas>

      <!-- PRESS TO START (pixel) -->
      <div id="pressStart" class="banner">PRESS&nbsp;TO&nbsp;START</div>

      <div id="toast" class="toast"></div>
      <div id="sceneFade" class="scene-fade"></div>

<div id="dialog" class="dialog">
  <div id="dialogName" class="dialog-name"></div>   <!-- nombre SIEMPRE arriba -->
  <div id="dialogText" class="dialog-text"></div>   <!-- debajo va el texto -->
  <div id="dialogHint" class="dialog-hint">→</div>
</div>
    </div>
  </div>

  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== DEBUG Y GUARDIAS ===== */
const DEBUG = false;
window.onerror = (msg, src, line, col) => {
  const t = document.getElementById('toast');
  t.textContent = 'Error: ' + msg;
  t.classList.add('show');
  console.error(msg, src, line+':'+col);
  return false;
};

/* ===== CONFIG VELOCIDAD / LUZ ===== */
const BASE_SPEED = 200;
const SHOES_BONUS = 30;
const DARK_MULTIPLIER = 0.2;
const DARK_OFF = 0.60;
const DARK_NONE = 0.00;

/* ===== ESTADO DEL JUEGO / AUDIO ===== */
let gameState = 'intro';         // 'intro' | 'playing' | 'transition'
let hasStarted = false;
let bgmHasEverPlayed = false;

/* ===== SPRITES PERSONAJE ===== */
const SPRITES_NORMAL = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: { down:["assets/juan_character/idle_down.png"], up:["assets/juan_character/idle_up.png"], left:["assets/juan_character/idle_left.png"], right:["assets/juan_character/idle_right.png"] },
  walk: { down:["assets/juan_character/walk_down_0.png","assets/juan_character/walk_down_1.png"], up:["assets/juan_character/walk_up_0.png","assets/juan_character/walk_up_1.png"], left:["assets/juan_character/walk_left_0.png","assets/juan_character/walk_left_1.png"], right:["assets/juan_character/walk_right_0.png","assets/juan_character/walk_right_1.png"] }
};
const SPRITES_SHOES = {
  size: { w: 36, h: 40 }, scale: 0.9,
  idle: {
    down:["assets/juan_character/idle_down_shoes.png"],
    up:["assets/juan_character/idle_up_shoes.png"],
    left:["assets/juan_character/idle_left_shoes.png"],
    right:["assets/juan_character/idle_right_shoes.png"]
  },
  walk: {
    down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"],
    up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"],
    left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"],   // <-- añade este segundo frame
    right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"] // <-- y este
  }
};

/* ===== AUDIO ===== */
let bgMusic = new Audio("assets/sounds/ambient1.mp3"); bgMusic.loop = true; bgMusic.volume = 0.4;
const pickupSnd = new Audio("assets/sounds/pickup.mp3"); pickupSnd.volume = 0.7;
const doorSnd   = new Audio("assets/sounds/door_clack.wav"); doorSnd.volume = 0.9;

/* ===== IMÁGENES (¡OJO A MAYÚS/MINÚS!) ===== */
const BACKGROUND = "assets/locations/room.PNG";
const PLANT1_IMG = "assets/objects/plant1.png";
const SOFA_IMG   = "assets/objects/sofa.png";
const TVON_IMG   = "assets/objects/tv_on.png";
const TVOFF_IMG  = "assets/objects/tv_off.png";
const BED_IMG    = "assets/objects/bed.png";
const SANDALS_IMG= "assets/objects/shoes.png";
const LAMP_IMG   = "assets/objects/lamp.png";

/* ===== ESTADO GLOBAL ===== */
let bgImg=null, plant1Img=null, sofaImg=null, tvOnImg=null, tvOffImg=null, bedImg=null, sandalsImg=null, lampImg=null;
let tvOn = true, tvAlreadyOff = false, lampOn = false;
let darkness = 0.60, targetDarkness = 0.60, darkWarnShown = false;
let preDialogLock = true;  // bloqueo movimiento/acción hasta que acabe primer diálogo

/* ===== CANVAS & ESCALA ===== */
const roomOriginal = { w: 512, h: 350 };
let bgRect = { dx:0, dy:0, dw:0, dh:0 }, scaleFactor = 1;

/* ===== BOUNDS/OBJETOS BASE ===== */
const boundsBase   = { x: 20, y: 85, w: 465, h: 235 };
const obstaclesBase= [
  { x: 230, y: 25,  w: 70,  h: 50 },
  { x: 0,   y: 190, w: 95,  h: 38 },
  { x: 0,   y: 260, w: 40,  h: 21 },
  { x: 450, y: 250, w: 15,  h: 0.5},
  { x: 5,   y: 25,  w: 140, h: 50 },
  { x: 195, y: 170, w: 170, h: 0.5}
];
const sofaBase    = { x:170, y:75,  w:220, h:180 };
const tvOnBase    = { x:205, y:35,  w:125, h:90  };
const bedBase     = { x:3,   y:155, w:120, h:130 };
const plant1Base  = { x:3,   y:230, w:60,  h:90  };
const sandalsBase = { x:55,  y:270, w:50,  h:50  };
const lampBase    = { x:100, y:18,  w:90,  h:100 };

/* ===== PUERTA ===== */
const doorBase = { x: 392, y: 31, w: 48, h: 63 };
const doorInteractDepth = 14;
const doorInteractBase = { x: doorBase.x - 8, y: doorBase.y + doorBase.h - doorInteractDepth, w: doorBase.w + 16, h: doorInteractDepth };

/* ===== POS ESCALADAS ===== */
let bounds={}, obstacles=[], bedPos={}, sofaPos={}, plant1Pos={}, lampPos={}, tvPos={}, sandalsPos={}, tvInteractPos={}, lampInteractPos={}, doorPos={}, doorInteractPos={};

/* ===== HELPERS ===== */
const loadImage = (src) => new Promise(res=>{
  const img = new Image();
  img.onload = ()=>res(img);
  img.onerror = ()=>{ console.warn('No se pudo cargar:', src); const ph = document.createElement('canvas'); ph.width=ph.height=1; res(ph); };
  img.src = src;
});
async function preloadSprites(map){
  const result = { idle:{}, walk:{}, size: map.size, scale: map.scale };
  for (const state of ["idle","walk"]){
    for (const dir of Object.keys(map[state])){
      result[state][dir] = await Promise.all(map[state][dir].map(loadImage));
    }
  }
  return result;
}

/* ===== playerStartBase ARRIBA ===== */
const playerStartBase = { x: 260, y: 150 };

/* ===== ESCALA ===== */
function updateScaledBounds(){
  bounds = { x: bgRect.dx + Math.round(boundsBase.x * scaleFactor), y: bgRect.dy + Math.round(boundsBase.y * scaleFactor),
             w: Math.round(boundsBase.w * scaleFactor), h: Math.round(boundsBase.h * scaleFactor) };
  obstacles = obstaclesBase.map(o=>({ x: bgRect.dx + Math.round(o.x * scaleFactor), y: bgRect.dy + Math.round(o.y * scaleFactor),
                                      w: Math.round(o.w * scaleFactor), h: Math.round(o.h * scaleFactor) }));
  sofaPos = { x:bgRect.dx+Math.round(sofaBase.x*scaleFactor), y:bgRect.dy+Math.round(sofaBase.y*scaleFactor), w:Math.round(sofaBase.w*scaleFactor), h:Math.round(sofaBase.h*scaleFactor) };
  tvPos   = { x:bgRect.dx+Math.round(tvOnBase.x*scaleFactor), y:bgRect.dy+Math.round(tvOnBase.y*scaleFactor), w:Math.round(tvOnBase.w*scaleFactor), h:Math.round(tvOnBase.h*scaleFactor) };
  tvInteractPos = { x:bgRect.dx+Math.round(tvOnBase.x*scaleFactor), y:bgRect.dy+Math.round((tvOnBase.y + tvOnBase.h - 40)*scaleFactor), w:Math.round(tvOnBase.w*scaleFactor), h:Math.round(2*scaleFactor) };
  bedPos  = { x:bgRect.dx+Math.round(bedBase.x*scaleFactor), y:bgRect.dy+Math.round(bedBase.y*scaleFactor), w:Math.round(bedBase.w*scaleFactor), h:Math.round(bedBase.h*scaleFactor) };
  plant1Pos = { x:bgRect.dx+Math.round(plant1Base.x*scaleFactor), y:bgRect.dy+Math.round(plant1Base.y*scaleFactor), w:Math.round(plant1Base.w*scaleFactor), h:Math.round(plant1Base.h*scaleFactor) };
  lampPos = { x:bgRect.dx+Math.round(lampBase.x*scaleFactor), y:bgRect.dy+Math.round(lampBase.y*scaleFactor), w:Math.round(lampBase.w*scaleFactor), h:Math.round(lampBase.h*scaleFactor) };
  lampInteractPos = { x:bgRect.dx+Math.round(lampBase.x*scaleFactor), y:bgRect.dy+Math.round((lampBase.y + lampBase.h - 18)*scaleFactor), w:Math.round(lampBase.w*scaleFactor), h:Math.round(16*scaleFactor) };
  sandalsPos = { x:bgRect.dx+Math.round(sandalsBase.x*scaleFactor), y:bgRect.dy+Math.round(sandalsBase.y*scaleFactor), w:Math.round(sandalsBase.w*scaleFactor), h:Math.round(sandalsBase.h*scaleFactor) };
  doorPos = { x: bgRect.dx + Math.round(doorBase.x * scaleFactor), y: bgRect.dy + Math.round(doorBase.y * scaleFactor),
              w: Math.round(doorBase.w * scaleFactor), h: Math.round(doorBase.h * scaleFactor) };
  doorInteractPos = { x: bgRect.dx + Math.round(doorInteractBase.x * scaleFactor), y: bgRect.dy + Math.round(doorInteractBase.y * scaleFactor),
                      w: Math.round(doorInteractBase.w * scaleFactor), h: Math.round(doorInteractBase.h * scaleFactor) };
}

/* ===== CANVAS ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;

function drawLoading(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
}

function resizeCanvas(){
  const screen = document.querySelector('.screen');
  canvas.width = screen.clientWidth;
  canvas.height = screen.clientHeight;

  if (bgImg){
    scaleFactor = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
    bgRect.dw = roomOriginal.w * scaleFactor;
    bgRect.dh = roomOriginal.h * scaleFactor;
    bgRect.dx = (canvas.width - bgRect.dw) / 2;
    bgRect.dy = (canvas.height - bgRect.dh) / 2;
    updateScaledBounds();
    player.x = bgRect.dx + Math.round(playerStartBase.x * scaleFactor);
    player.y = bgRect.dy + Math.round(playerStartBase.y * scaleFactor);
  } else {
    drawLoading();
  }
}
window.addEventListener('resize', resizeCanvas);

/* ===== INPUT ===== */
const player = { x:0, y:0, speed:BASE_SPEED, dir:'up', moving:false, frame:0, frameTime:0 };
const keys = { up:false, down:false, left:false, right:false };

function bindHold(btn, on, off){
  const start = e => { e.preventDefault(); on(); };
  const end   = e => { e.preventDefault(); off(); };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  window.addEventListener('mouseup', end);
}
bindHold(document.getElementById('btn-up'),    ()=>keys.up=true,    ()=>keys.up=false);
bindHold(document.getElementById('btn-down'),  ()=>keys.down=true,  ()=>keys.down=false);
bindHold(document.getElementById('btn-left'),  ()=>keys.left=true,  ()=>keys.left=false);
bindHold(document.getElementById('btn-right'), ()=>keys.right=true, ()=>keys.right=false);

function bindPressVisual(el){
  const on = ()=>el.classList.add('pressed');
  const off= ()=>el.classList.remove('pressed');
  el.addEventListener('mousedown', on);
  el.addEventListener('mouseup', off);
  el.addEventListener('mouseleave', off);
  el.addEventListener('touchstart', (e)=>{ e.preventDefault(); on(); }, {passive:false});
  el.addEventListener('touchend', off, {passive:false});
  el.addEventListener('touchcancel', off, {passive:false});
}
['btn-up','btn-down','btn-left','btn-right','btn-act'].forEach(id=>{
  const el=document.getElementById(id); if(el) bindPressVisual(el);
});

const mapKey = { ArrowUp:'up', KeyW:'up', ArrowDown:'down', KeyS:'down', ArrowLeft:'left', KeyA:'left', ArrowRight:'right', KeyD:'right' };
window.addEventListener('keydown', e => { const d=mapKey[e.code]; if(d){ keys[d]=true; e.preventDefault(); }});
window.addEventListener('keyup',   e => { const d=mapKey[e.code]; if(d){ keys[d]=false; e.preventDefault(); }});

/* ===== META SPRITES ===== */
let assets=null, assetsNormal=null, assetsShoes=null;
function currentMeta(){ const base = assets ?? SPRITES_NORMAL; return { size: base.size, scale: base.scale ?? SPRITES_NORMAL.scale, ...base }; }

/* ===== COLISIONES ===== */
function collides(x, y){
  const halfW = currentMeta().size.w * currentMeta().scale / 2;
  const halfH = currentMeta().size.h * currentMeta().scale / 2;
  const px = x - halfW, py = y - halfH, pw = halfW*2, ph = halfH*2;
  if (x < bounds.x || x > bounds.x + bounds.w || y < bounds.y || y > bounds.y + bounds.h) return true;
  for (const o of obstacles){ if (px < o.x + o.w && px + pw > o.x && py < o.y + o.h && py + ph > o.y) return true; }
  return false;
}
function getPlayerRect(x=player.x,y=player.y){
  const halfW = currentMeta().size.w * currentMeta().scale / 2;
  const halfH = currentMeta().size.h * currentMeta().scale / 2;
  return { x:x-halfW, y:y-halfH, w:halfW*2, h:halfH*2 };
}
function aabb(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

/* ===== TOAST ===== */
function showToast(msg, ms=2000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(showToast._to);
  showToast._to = setTimeout(()=>t.classList.remove('show'), ms);
}


/* ===== DIÁLOGO ===== */
const dialogEl    = document.getElementById('dialog');
const dialogName  = document.getElementById('dialogName');
const dialogText  = document.getElementById('dialogText');
const dialogHint  = document.getElementById('dialogHint');

let isTyping = false, typingTimer = null, typingSpeed = 22;
let dialogOpen = false;
let dialogIndex = 0;

/* Guion con nombre + texto (edítalo a tu gusto) */
const dialogScript = [
  { speaker: 'Juan',  text: '...' },
  { speaker: 'Juan',  text: '¡Toma combo!' },
  { speaker: 'Juan',  text: '...' },
  { speaker: 'Juan',  text: '...' },
  { speaker: 'Juan',  text: 'Qué hambre tengo...' },
  { speaker: 'Juan',  text: 'Me apetecen unos Tresor.' },
  { speaker: 'Juan',  text: 'Voy al super.' }
];

/* ====== BEEP RETRO (Web Audio API) ====== */
function playBip() {
  try{
    if (!window.__ctx) window.__ctx = new (window.AudioContext||window.webkitAudioContext)();
    const ctx = window.__ctx;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    // Timbre y pitch con un pelín de variación
    osc.type = 'square';
    osc.frequency.value = 760 + Math.random()*120;

    // Envolvente corta para evitar clics
    const now = ctx.currentTime;
    const dur = 0.075;          // 75 ms
    const v0  = 0.05;           // volumen base
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(v0, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0005, now + dur);

    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now + dur);
  }catch(e){}
}

/* Beep por carácter, con filtro para que no suene en cada espacio/puntuación */
function playBipForChar(ch, i){
  // bips en letras/dígitos y a inicio de palabra; menos ruido en espacios/puntos
  const isAlphaNum = /[A-Za-zÁÉÍÓÚÜÑáéíóúüñ0-9]/.test(ch);
  if (isAlphaNum || (ch === ' ' && (i % 6 === 0))) playBip();
}

function openDialog(){
  dialogEl.classList.add('show');
  dialogEl.classList.remove('ready');
  dialogOpen = true;
  dialogIndex = 0;
  renderCurrentLine(true);
}

function closeDialog(){
  dialogEl.classList.remove('show','ready');
  dialogOpen = false;
  preDialogLock = false; // tu flag original
}

function renderCurrentLine(startTyping = false){
  const line = dialogScript[dialogIndex] || { speaker:'', text:'' };
  dialogName.textContent = line.speaker || '';
  dialogText.textContent = '';
  dialogHint.style.opacity = 0;

  if (startTyping){
    startTypingEffect(line.text);
  } else {
    dialogText.textContent = line.text;
    dialogEl.classList.add('ready');
  }
}

function startTypingEffect(text){
  clearInterval(typingTimer);
  isTyping = true;
  let i = 0;

  typingTimer = setInterval(()=>{
    if (i < text.length){
      const ch = text[i++];
      dialogText.textContent += ch;
      playBipForChar(ch, i);   // <<< bip aquí
    } else {
      clearInterval(typingTimer);
      isTyping = false;
      dialogEl.classList.add('ready');
      dialogHint.style.opacity = 1;
    }
  }, typingSpeed);
}

function advanceDialog(){
  if (!dialogOpen) return;

  const full = dialogScript[dialogIndex]?.text ?? '';
  if (isTyping){
    clearInterval(typingTimer);
    isTyping = false;
    dialogText.textContent = full;     // completar instantáneo sin bips extra
    dialogEl.classList.add('ready');
    dialogHint.style.opacity = 1;
    return;
  }

  dialogIndex++;
  if (dialogIndex < dialogScript.length){
    dialogEl.classList.remove('ready');
    dialogHint.style.opacity = 0;
    renderCurrentLine(true);
  } else {
    closeDialog();
  }
}

/* ===== FADE AUDIO ===== */
function fadeOutAudio(audio, ms=300){
  return new Promise(res=>{
    const startVol = audio.volume;
    const steps = Math.max(1, Math.floor(ms/16));
    let i = 0;
    const int = setInterval(()=>{
      i++;
      audio.volume = Math.max(0, startVol*(1 - i/steps));
      if (i>=steps){
        clearInterval(int);
        audio.volume = 0;
        res();
      }
    },16);
  });
}

/* ===== SALIDA/PUERTA + FADE ===== */
let exiting = false, showDoorRect = false;
const DOOR_HOLD_MS = 250, EXIT_FADE_MS = 450, NEXT_SCENE_URL = "outside.html";
async function startExitSequence(){
  if (exiting) return;
  exiting = true; showDoorRect = true;
  try { doorSnd.currentTime = 0; doorSnd.play(); } catch(e) {}

  try { await fadeOutAudio(bgMusic, 250); bgMusic.pause(); bgMusic.currentTime = 0; } catch(e){}

  const sf = document.getElementById('sceneFade');
  sf?.classList.add('show');
  setTimeout(()=>{ window.location.href = NEXT_SCENE_URL; }, EXIT_FADE_MS);
}

/* ===== ARRANQUE CONTROLADO POR BANNER ===== */
const bootMask     = document.getElementById('bootMask');
const pressStartEl = document.getElementById('pressStart');
let audioCtx;

function ensureAudioCtxUnlocked(){
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  } catch(e){}
}
function startBGM(){
  if (bgmHasEverPlayed) return;
  bgMusic.volume = 0.4;
  bgMusic.currentTime = 0;
  bgMusic.play().then(()=>{ bgmHasEverPlayed = true; }).catch(()=>{});
}

function startGameFromBanner(){
  if (hasStarted) return;
  hasStarted = true;
  gameState = 'playing';
  pressStartEl.classList.add('hide');   // ocultar banner
  ensureAudioCtxUnlocked();
  startBGM();
  setTimeout(()=>{ openDialog(); }, 400); // << sin dialogQueue, ni startTyping manual
}

/* ===== ACCIÓN ===== */
function handleAction() {
  // Si estamos en la intro, la primera acción arranca y no sigue procesando
  if (gameState === 'intro'){
    startGameFromBanner();
    return;
  }

  if (dialogOpen) { advanceDialog(); return; }
  if (preDialogLock) return;

  const atDoor = aabb(getPlayerRect(), doorInteractPos);
  if (atDoor) {
    if (!hasShoes) { showToast('Ponte las chanclas.'); return; }
    if (tvOn)      { showToast('Apaga la tele.'); return; }
    if (lampOn)    { showToast('Apaga la luz.'); return; }
    startExitSequence();
    return;
  }

  const insideTV = aabb(getPlayerRect(), tvInteractPos);
  if (insideTV) {
    if (tvOn && !tvAlreadyOff) {
      tvOn = false; tvAlreadyOff = true;
      bgMusic.pause(); bgMusic.currentTime = 0;
    } else if (!tvOn) {
      showToast('No más Tekken por hoy.');
    }
    return;
  }

  const reducedLamp= { x: lampPos.x, y: lampPos.y + lampPos.h - 20, w: lampPos.w - 5, h: 3 };
  const insideLamp = aabb(getPlayerRect(), reducedLamp);
  if (insideLamp) { lampOn = !lampOn; return; }

  const reducedPlant= { x: plant1Pos.x - 5, y: plant1Pos.y + 40, w: plant1Pos.w - 5, h: 0.2 };
  const insidePlant = aabb(getPlayerRect(), reducedPlant);
  if (insidePlant) { showToast('10 años regándola y ni un solo aguacate...'); return; }

  const reducedBed = { x: bedPos.x, y: bedPos.y + 20, w: bedPos.w - 15, h: 35 };
  const insideBed = aabb(getPlayerRect(), reducedBed);
  if (insideBed) { showToast('No es hora de cerrar el kiosko.'); return; }
}

/* ===== EQUIPO ===== */
let hasShoes = false;
function equipShoes(){
  if (hasShoes) return;
  hasShoes = true; try { pickupSnd.currentTime = 0; pickupSnd.play(); } catch(e){}
  assets = assetsShoes || assets; sandalsImg = null;
}

/* ===== UPDATE & DRAW ===== */
function update(dt){
  const DARK_TARGET = lampOn ? DARK_NONE : DARK_OFF;
  const fadeSpeed = 8;
  darkness += (DARK_TARGET - darkness) * Math.min(1, dt * fadeSpeed);

  const lightOk = tvOn || lampOn;
  const base = BASE_SPEED + (hasShoes ? SHOES_BONUS : 0);
  player.speed = lightOk ? base : base * DARK_MULTIPLIER;

  if (dialogOpen || exiting || preDialogLock || gameState==='intro'){ player.moving = false; player.frame = 0; return; }

  if (!lightOk){ if (!darkWarnShown){ showToast('Despacio, está oscuro.'); darkWarnShown = true; } }
  else { darkWarnShown = false; }

  const vx = (keys.left?-1:0) + (keys.right?1:0);
  const vy = (keys.up?-1:0) + (keys.down?1:0);
  player.moving = (vx!==0 || vy!==0);

  if (player.moving){
    player.dir = Math.abs(vx) > Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len = Math.hypot(vx,vy) || 1;
    const nx = (vx/len) * player.speed * dt;
    const ny = (vy/len) * player.speed * dt;
    const newX = player.x + nx, newY = player.y + ny;
    if (!collides(newX,newY)){ player.x=newX; player.y=newY; }
    player.frameTime += dt;
    if(player.frameTime >= 0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else { player.frame = 0; }

  if (!hasShoes && sandalsImg){
    const reduce=0.5, p=getPlayerRect();
    const r={ x:p.x+p.w*(1-reduce)/2, y:p.y+p.h*(1-reduce)/2, w:p.w*reduce, h:p.h*reduce };
    const s=sandalsPos;
    if (r.x < s.x + s.w && r.x + r.w > s.x && r.y < s.y + s.h && r.y + r.h > s.y) equipShoes();
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (bgImg){
    const s = Math.min(canvas.width / roomOriginal.w, canvas.height / roomOriginal.h);
    bgRect.dw = roomOriginal.w*s; bgRect.dh = roomOriginal.h*s;
    bgRect.dx = (canvas.width-bgRect.dw)/2; bgRect.dy = (canvas.height-bgRect.dh)/2;
    ctx.drawImage(bgImg, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);
  } else {
    drawLoading(); return;
  }

  if (!assets) return;

  const sw=currentMeta().size.w, sh=currentMeta().size.h;
  const dw=Math.round(sw*SPRITES_NORMAL.scale), dh=Math.round(sh*SPRITES_NORMAL.scale);
  const img = player.moving ? assets.walk[player.dir][player.frame] : assets.idle[player.dir][0];

  let stretchPx=0;
  if (!player.moving){
    const Hz=0.6, t=performance.now()/1000;
    stretchPx=Math.round((Math.sin(t*Math.PI*2*Hz)*0.5+0.5)*1);
  }

  const list=[];
  list.push({ y: tvPos.y, draw: ()=>{ const timg = tvOn ? tvOnImg : tvOffImg; if (timg && timg.width) ctx.drawImage(timg, tvPos.x, tvPos.y, tvPos.w, tvPos.h);} });

  if (showDoorRect) {
    list.push({ y: doorPos.y + doorPos.h/2, draw: () => { ctx.fillStyle = '#000'; ctx.fillRect(doorPos.x, doorPos.y, doorPos.w, doorPos.h); } });
  }
  if (lampImg && lampImg.width) list.push({ y: lampPos.y + lampPos.h/2, draw: ()=>ctx.drawImage(lampImg, lampPos.x, lampPos.y, lampPos.w, lampPos.h) });
  if (plant1Img && plant1Img.width) list.push({ y: plant1Pos.y, draw: ()=>ctx.drawImage(plant1Img, plant1Pos.x, plant1Pos.y, plant1Pos.w, plant1Pos.h) });
  if (sofaImg && sofaImg.width)     list.push({ y: sofaPos.y + sofaPos.h/2, draw: ()=>ctx.drawImage(sofaImg, sofaPos.x, sofaPos.y, sofaPos.w, sofaPos.h) });
  if (bedImg && bedImg.width)       list.push({ y: bedPos.y + bedPos.h/2, draw: ()=>ctx.drawImage(bedImg, bedPos.x, bedPos.y, bedPos.w, bedPos.h) });
  if (!hasShoes && sandalsImg && sandalsImg.width){
    list.push({ y: sandalsPos.y + sandalsPos.h/2, draw: ()=>ctx.drawImage(sandalsImg, sandalsPos.x, sandalsPos.y, sandalsPos.w, sandalsPos.h) });
  }
  list.push({ y: player.y, draw: ()=>{
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(img, 0,0, sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2)-stretchPx, dw, dh+stretchPx);
  }});
  list.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());

  if (darkness > 0) { ctx.fillStyle = `rgba(0,0,0,${darkness.toFixed(3)})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
  if (tvOn){ const flicker = 0.35 + Math.random()*0.05; drawLightClipped(tvPos.x + tvPos.w/2, tvPos.y + tvPos.h/2, 100, flicker); }
  if (lampOn){ const flicker = 0.30 + Math.random()*0.04; drawLightClipped(lampPos.x + lampPos.w/2, lampPos.y + lampPos.h/3, 110, flicker); }

  if (DEBUG){
    ctx.save();
    ctx.fillStyle='rgba(0,200,255,0.12)'; ctx.fillRect(tvInteractPos.x, tvInteractPos.y, tvInteractPos.w, tvInteractPos.h);
    ctx.strokeStyle='rgba(0,200,255,0.35)'; ctx.strokeRect(tvInteractPos.x, tvInteractPos.y, tvInteractPos.w, tvInteractPos.h);
    ctx.fillStyle='rgba(255,200,0,0.12)'; ctx.fillRect(lampInteractPos.x, lampInteractPos.y, lampInteractPos.w, lampInteractPos.h);
    ctx.strokeRect(lampInteractPos.x, lampInteractPos.y, lampInteractPos.w, lampInteractPos.h);
    ctx.strokeStyle='rgba(0,255,100,.7)'; ctx.strokeRect(doorPos.x, doorPos.y, doorPos.w, doorPos.h);
    ctx.strokeStyle='rgba(255,200,0,.7)'; ctx.strokeRect(doorInteractPos.x, doorInteractPos.y, doorInteractPos.w, doorInteractPos.h);
    ctx.restore();
  }
}

/* Luz radial recortada al área del fondo */
function drawLightClipped(x,y,radius,intensity){
  if (!bgRect || !bgRect.dw || !bgRect.dh) return;
  const radiusScaled = radius * (bgRect.dw / roomOriginal.w);
  ctx.save();
  ctx.beginPath(); ctx.rect(bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh); ctx.clip();
  const g = ctx.createRadialGradient(x,y,0,x,y,radiusScaled);
  g.addColorStop(0, `rgba(255,255,200,${intensity})`);
  g.addColorStop(1, 'rgba(255,255,200,0)');
  ctx.globalCompositeOperation="lighter";
  ctx.fillStyle=g;
  ctx.beginPath(); ctx.arc(x,y,radiusScaled,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.globalCompositeOperation="source-over";
}

/* ===== LOOP ===== */
function loop(now){
  if(!loop.last) loop.last=now;
  const dt = Math.min(1/30,(now-loop.last)/1000);
  loop.last=now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

/* ===== INIT ===== */
async function init(){
  const [bg, sofa, tvOnI, tvOffI, bed, plant, sandals, lamp, normalSet, shoesSet] = await Promise.all([
    loadImage(BACKGROUND), loadImage(SOFA_IMG), loadImage(TVON_IMG), loadImage(TVOFF_IMG),
    loadImage(BED_IMG), loadImage(PLANT1_IMG), loadImage(SANDALS_IMG), loadImage(LAMP_IMG),
    preloadSprites(SPRITES_NORMAL), preloadSprites(SPRITES_SHOES)
  ]);
  bgImg=bg; sofaImg=sofa; tvOnImg=tvOnI; tvOffImg=tvOffI; bedImg=bed; plant1Img=plant; sandalsImg=sandals; lampImg=lamp;
  assetsNormal=normalSet; assetsShoes=shoesSet; assets=assetsNormal;

  try{ setupAudioUnlock(); }catch(e){}
  resizeCanvas();
  requestAnimationFrame(loop);

  // >>> Aquí quitamos la pantalla negra y mostramos el PRESS TO START
  bootMask.classList.add('hidden');
  setTimeout(()=> pressStartEl.classList.add('show'), 80);
}
init();

function setupAudioUnlock() {
  try { bgMusic.setAttribute?.('playsinline', ''); } catch (e) {}
  bgMusic.preload = 'auto';
  const unlock = () => {
    try {
      if (typeof AudioContext !== 'undefined') {
        if (!window.__ctx) window.__ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (window.__ctx.state === 'suspended') window.__ctx.resume();
      }
    } catch(e){}
    window.removeEventListener('pointerdown', unlock);
    window.removeEventListener('keydown', unlock);
    window.removeEventListener('touchstart', unlock);
  };
  window.addEventListener('pointerdown', unlock, { once: true });
  window.addEventListener('keydown',     unlock, { once: true });
  window.addEventListener('touchstart',  unlock, { once: true, passive: false });
}

/* ===== BIND ACCIÓN ===== */
document.getElementById('btn-act').addEventListener('click', (e)=>{ e.preventDefault(); handleAction(); });
document.getElementById('btn-act').addEventListener('touchstart', (e)=>{ e.preventDefault(); handleAction(); }, {passive:false});
window.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'Enter'){
    e.preventDefault();
    handleAction();
  }
}, { passive:false });
</script>
</body>
</html>