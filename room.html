<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin – habitación (restaurado)</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html,body{height:100%;margin:0;background:#111;display:flex;justify-content:center;align-items:center}
  .gameboy{width:100%;max-width:500px;height:100%;background:#000;display:flex;flex-direction:column;padding:12px;box-sizing:border-box;border-radius:20px;box-shadow:0 0 40px rgba(0,0,0,.6)}
  .screen-container{flex:1;display:flex;justify-content:center;align-items:center;background:#0B0A21;border-radius:12px;padding:10px}
  .screen{aspect-ratio:1/1;width:100%;background:#0B0A21;display:flex;justify-content:center;align-items:center;border-radius:8px;overflow:hidden;position:relative;box-shadow:inset 0 0 20px rgba(0,0,0,.6)}
  canvas{width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges;background:#000}

  .controls{height:40%;background:#0B0A21;display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px;box-sizing:border-box}
  .dpad{display:grid;grid-template-columns:repeat(3,64px);grid-template-rows:repeat(3,64px);gap:0;justify-content:center;margin-left:12px;align-content:center}
  .img-btn,.img-act{border:none;outline:none;padding:0;background:transparent;cursor:pointer;transition:transform .06s ease,filter .06s ease;-webkit-tap-highlight-color:transparent}
  .img-btn{width:64px;height:64px;filter:drop-shadow(0 3px 4px rgba(0,0,0,.85))}
  .img-btn.arrow::before{content:"";display:block;width:100%;height:100%;background:url("assets/ui/arrow.PNG") center/contain no-repeat;image-rendering:pixelated;transform:rotate(var(--rot,0deg)) scale(1.28);transform-origin:center}
  .btn-up{--rot:180deg}.btn-left{--rot:90deg}.btn-right{--rot:-90deg}.btn-down{--rot:0deg}
  .img-act{width:120px;height:120px;filter:drop-shadow(0 5px 6px rgba(0,0,0,.85));margin-top:45px;justify-self:center}
  .img-act::before{content:"";display:block;width:100%;height:100%;background:url("assets/ui/action_btn.PNG") center/contain no-repeat;image-rendering:pixelated;transform:scale(1.02)}
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{transform:scale(.95);filter:drop-shadow(0 2px 3px rgba(0,0,0,.7)) brightness(.9)}

  .toast{position:absolute;top:19px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:6px 10px;border-radius:8px;opacity:0;transition:opacity .2s ease;white-space:nowrap;pointer-events:none;z-index:5}
  .toast.show{opacity:1}

  .dialog{position:absolute;left:50%;bottom:10px;transform:translateX(-50%) scaleX(0);transform-origin:center bottom;width:calc(100% - 24px);max-width:460px;min-height:20px;box-sizing:border-box;padding:12px 16px 16px;display:flex;gap:10px;border-radius:10px;image-rendering:pixelated;z-index:6;transition:transform .22s ease;background:rgba(12,12,24,.9);border-top:2px solid #3cf;flex-direction:column;text-align:left}
  .dialog.show{transform:translateX(-50%) scaleX(1)}
  .dialog-name{font-family:'Press Start 2P',system-ui;font-size:10px;color:#8df;margin-bottom:4px;text-shadow:0 1px 0 #000}
  .dialog-text{font-family:'VT323',monospace;font-size:18px;letter-spacing:1px;line-height:1.15;color:#E6F6FF;min-height:2.2em}
  .dialog-hint{margin-left:auto;color:#B8D7FF;font:600 12px/1 system-ui;opacity:0;transition:opacity .18s ease}
  .dialog.ready .dialog-hint{opacity:.9}

  .banner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:"Press Start 2P",monospace;font-size:12px;letter-spacing:1px;color:#E6D0A3;text-shadow:2px 2px 0 #0b2346;user-select:none;z-index:998;opacity:0;pointer-events:none;animation:blink 1.1s steps(2,end) infinite}
  .banner.show{opacity:1;pointer-events:auto}.banner.hide{display:none}
  @keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

  .boot-mask{position:absolute;inset:0;background:#000;z-index:1000;opacity:1;transition:opacity .25s ease}
  .boot-mask.hidden{opacity:0;pointer-events:none}
  .scene-fade{position:absolute;inset:0;background:#000;opacity:0;pointer-events:none;z-index:999;transition:opacity .45s ease}
  .scene-fade.show{opacity:1}
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>
      <div id="pressStart" class="banner">PRESS&nbsp;TO&nbsp;START</div>
      <div id="toast" class="toast"></div>
      <div id="sceneFade" class="scene-fade"></div>

      <div id="dialog" class="dialog">
        <div id="dialogName" class="dialog-name"></div>
        <div id="dialogText" class="dialog-text"></div>
        <div id="dialogHint" class="dialog-hint">→</div>
      </div>
    </div>
  </div>

  <!-- D-Pad táctil + Acción -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== Config base ===== */
const roomOriginal={w:512,h:350};
const BASE_SPEED=200, SHOES_BONUS=30, DARK_MULT=0.2, DARK_OFF=0.60, DARK_NONE=0.00;

/* Assets */
const BACKGROUND="assets/locations/room.png";
const SPRITES={ size:{w:36,h:40}, scale:0.9,
  idle:{down:["assets/juan_character/idle_down_shoes.png"],up:["assets/juan_character/idle_up_shoes.png"],left:["assets/juan_character/idle_left_shoes.png"],right:["assets/juan_character/idle_right_shoes.png"]},
  walk:{down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"],
        up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"],
        left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"],
        right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"]}
};
const PLANT1_IMG="assets/objects/plant1.png", SOFA_IMG="assets/objects/sofa.png",
      TVON_IMG="assets/objects/tv_on.png", TVOFF_IMG="assets/objects/tv_off.png",
      BED_IMG="assets/objects/bed.png", SANDALS_IMG="assets/objects/shoes.png",
      LAMP_IMG="assets/objects/lamp.png";

/* Audio */
const bgm=new Audio("assets/sounds/ambient1.mp3"); bgm.loop=true; bgm.volume=.4;
const pickup=new Audio("assets/sounds/pickup.mp3"); pickup.volume=.7;
const doorSnd=new Audio("assets/sounds/door_clack.wav"); doorSnd.volume=.9;

/* Estado */
let bgImg, plant1Img, sofaImg, tvOnImg, tvOffImg, bedImg, sandalsImg, lampImg, sprites=null;
let tvOn=true, tvAlreadyOff=false, lampOn=false, hasShoes=false;
let darkness=DARK_OFF, darkWarn=false, exiting=false, hasStarted=false;

/* Canvas & layout */
const canvas=document.getElementById('game'), ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
let bgRect={dx:0,dy:0,dw:0,dh:0}, scaleFactor=1;

/* Bounds & obstáculos EXACTOS (coords 512×350) */
const boundsBase={x:20,y:85,w:465,h:235};
const obstaclesBase=[
  {x:230,y:25,w:70,h:50},
  {x:0,y:190,w:95,h:38},
  {x:0,y:260,w:40,h:21},
  {x:450,y:250,w:15,h:.5},
  {x:5,y:25,w:140,h:50},
  {x:195,y:170,w:170,h:.5}
];
const sofaBase={x:170,y:75,w:220,h:180},
      tvBase={x:205,y:35,w:125,h:90},
      bedBase={x:3,y:155,w:120,h:130},
      plantBase={x:3,y:230,w:60,h:90},
      sandalsBase={x:55,y:270,w:50,h:50},
      lampBase={x:100,y:18,w:90,h:100};
const doorBase={x:392,y:31,w:48,h:63},
      doorInteractDepth=14,
      doorInteractBase={x:doorBase.x-8,y:doorBase.y+doorBase.h-doorInteractDepth,w:doorBase.w+16,h:doorInteractDepth};
const playerStartBase={x:260,y:150};

let bounds={}, obstacles=[], bedPos={}, sofaPos={}, plantPos={}, lampPos={}, tvPos={}, sandalsPos={}, tvInteractPos={}, lampInteractPos={}, doorPos={}, doorInteractPos={};

/* Player */
const player={x:0,y:0,speed:BASE_SPEED,dir:'down',moving:false,frame:0,frameTime:0};

/* Helpers */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const aabb=(a,b)=>a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
const loadImage=(src)=>new Promise(res=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>{console.warn('No carga',src);const c=document.createElement('canvas');c.width=c.height=1;res(c)};i.src=src;});
async function preloadSprites(map){const r={idle:{},walk:{},size:map.size,scale:map.scale};for(const s of['idle','walk'])for(const d of Object.keys(map[s]))r[s][d]=await Promise.all(map[s][d].map(loadImage));return r;}
const getPlayerRect=(x=player.x,y=player.y)=>{const hw=SPRITES.size.w*SPRITES.scale/2,hh=SPRITES.size.h*SPRITES.scale/2;return{x:x-hw,y:y-hh,w:hw*2,h:hh*2}};

/* UI */
const bootMask=document.getElementById('bootMask'), pressStart=document.getElementById('pressStart'), sceneFade=document.getElementById('sceneFade');
const dialogEl=document.getElementById('dialog'), dialogName=document.getElementById('dialogName'), dialogText=document.getElementById('dialogText'), dialogHint=document.getElementById('dialogHint');
const toast=document.getElementById('toast');
function showToast(msg,ms=1800){toast.textContent=msg;toast.classList.add('show');clearTimeout(showToast._t);showToast._t=setTimeout(()=>toast.classList.remove('show'),ms);}

/* Diálogo */
let dialogOpen=false, typingTimer=null, typingSpeed=22, dialogIdx=0;
const script=[{speaker:'Juan',text:'...'},{speaker:'Juan',text:'Qué hambre tengo…'},{speaker:'Juan',text:'Voy al súper.'}];
function openDialog(){dialogEl.classList.add('show');dialogEl.classList.remove('ready');dialogOpen=true;dialogIdx=0;renderLine(true);}
function closeDialog(){dialogEl.classList.remove('show','ready');dialogOpen=false;}
function renderLine(type){const L=script[dialogIdx]||{speaker:'',text:''};dialogName.textContent=L.speaker||'';dialogText.textContent='';dialogHint.style.opacity=0;type?typeText(L.text):(dialogText.textContent=L.text,dialogEl.classList.add('ready'))}
function typeText(t){clearInterval(typingTimer);let i=0;typingTimer=setInterval(()=>{if(i<t.length){dialogText.textContent+=t[i++];}else{clearInterval(typingTimer);dialogEl.classList.add('ready');dialogHint.style.opacity=1;}},typingSpeed)}
function advanceDialog(){if(!dialogOpen)return;const full=script[dialogIdx]?.text||'';if(typingTimer){clearInterval(typingTimer);typingTimer=null;dialogText.textContent=full;dialogEl.classList.add('ready');dialogHint.style.opacity=1;return}dialogIdx++;if(dialogIdx<script.length){dialogEl.classList.remove('ready');dialogHint.style.opacity=0;renderLine(true);}else closeDialog()}

/* Escalado exacto */
function updateScaled(){const sc=scaleFactor,bx=bgRect.dx,by=bgRect.dy;
  bounds={x:bx+Math.round(boundsBase.x*sc),y:by+Math.round(boundsBase.y*sc),w:Math.round(boundsBase.w*sc),h:Math.round(boundsBase.h*sc)};
  obstacles=obstaclesBase.map(o=>({x:bx+Math.round(o.x*sc),y:by+Math.round(o.y*sc),w:Math.round(o.w*sc),h:Math.round(o.h*sc)}));
  sofaPos={x:bx+Math.round(sofaBase.x*sc),y:by+Math.round(sofaBase.y*sc),w:Math.round(sofaBase.w*sc),h:Math.round(sofaBase.h*sc)};
  tvPos  ={x:bx+Math.round(tvBase.x*sc),y:by+Math.round(tvBase.y*sc),w:Math.round(tvBase.w*sc),h:Math.round(tvBase.h*sc)};
  tvInteractPos={x:tvPos.x,y:tvPos.y+tvPos.h-Math.round(40*sc),w:tvPos.w,h:Math.round(2*sc)};
  bedPos ={x:bx+Math.round(bedBase.x*sc),y:by+Math.round(bedBase.y*sc),w:Math.round(bedBase.w*sc),h:Math.round(bedBase.h*sc)};
  plantPos={x:bx+Math.round(plantBase.x*sc),y:by+Math.round(plantBase.y*sc),w:Math.round(plantBase.w*sc),h:Math.round(plantBase.h*sc)};
  lampPos={x:bx+Math.round(lampBase.x*sc),y:by+Math.round(lampBase.y*sc),w:Math.round(lampBase.w*sc),h:Math.round(lampBase.h*sc)};
  lampInteractPos={x:lampPos.x,y:lampPos.y+lampPos.h-Math.round(18*sc),w:lampPos.w,h:Math.round(16*sc)};
  sandalsPos={x:bx+Math.round(sandalsBase.x*sc),y:by+Math.round(sandalsBase.y*sc),w:Math.round(sandalsBase.w*sc),h:Math.round(sandalsBase.h*sc)};
  doorPos={x:bx+Math.round(doorBase.x*sc),y:by+Math.round(doorBase.y*sc),w:Math.round(doorBase.w*sc),h:Math.round(doorBase.h*sc)};
  doorInteractPos={x:bx+Math.round(doorInteractBase.x*sc),y:by+Math.round(doorInteractBase.y*sc),w:Math.round(doorInteractBase.w*sc),h:Math.round(doorInteractBase.h*sc)};
}
function resizeCanvas(){const s=document.querySelector('.screen');canvas.width=s.clientWidth;canvas.height=s.clientHeight;
  if(!bgImg){ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);return}
  scaleFactor=Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
  bgRect.dw=roomOriginal.w*scaleFactor; bgRect.dh=roomOriginal.h*scaleFactor;
  bgRect.dx=(canvas.width-bgRect.dw)/2; bgRect.dy=(canvas.height-bgRect.dh)/2;
  updateScaled();
  if(!hasStarted){player.x=bgRect.dx+Math.round(playerStartBase.x*scaleFactor);player.y=bgRect.dy+Math.round(playerStartBase.y*scaleFactor);}
}
addEventListener('resize',resizeCanvas);

/* Colisiones (AABB) */
function collides(nx,ny){
  const hw=SPRITES.size.w*SPRITES.scale/2, hh=SPRITES.size.h*SPRITES.scale/2;
  const r={x:nx-hw,y:ny-hh,w:hw*2,h:hh*2};
  if(r.x<bounds.x||r.x+r.w>bounds.x+bounds.w||r.y<bounds.y||r.y+r.h>bounds.y+bounds.h) return true;
  for(const o of obstacles){ if(aabb(r,o)) return true; }
  return false;
}

/* Entrada: SOLO D-pad */
const keys={up:false,down:false,left:false,right:false};
function bindHold(btn,on,off){const start=e=>{e.preventDefault();on()};const end=e=>{e.preventDefault();off()};
  btn.addEventListener('touchstart',start,{passive:false});btn.addEventListener('touchend',end,{passive:false});btn.addEventListener('touchcancel',end,{passive:false});
  btn.addEventListener('mousedown',start);window.addEventListener('mouseup',end);
}
['up','down','left','right'].forEach(d=>bindHold(document.getElementById('btn-'+d),()=>keys[d]=true,()=>keys[d]=false));
function pressVisual(el){const on=()=>el.classList.add('pressed'),off=()=>el.classList.remove('pressed');
  el.addEventListener('mousedown',on);el.addEventListener('mouseup',off);el.addEventListener('mouseleave',off);
  el.addEventListener('touchstart',e=>{e.preventDefault();on()},{passive:false});el.addEventListener('touchend',off,{passive:false});el.addEventListener('touchcancel',off,{passive:false});
}
['btn-up','btn-down','btn-left','btn-right','btn-act'].forEach(id=>pressVisual(document.getElementById(id)));

/* Acción */
function handleAction(){
  if(!hasStarted){startGame();return}
  if(dialogOpen){advanceDialog();return}

  // Puerta: requiere chanclas y todo apagado
  if(aabb(getPlayerRect(),doorInteractPos)){
    if(!hasShoes) return showToast('Ponte las chanclas.');
    if(tvOn) return showToast('Apaga la tele.');
    if(lampOn) return showToast('Apaga la luz.');
    return startExit();
  }

  // Tele
  if(aabb(getPlayerRect(),tvInteractPos)){
    if(tvOn && !tvAlreadyOff){ tvOn=false; tvAlreadyOff=true; try{bgm.pause();bgm.currentTime=0;}catch(e){} }
    else if(!tvOn){ showToast('No más Tekken por hoy.'); }
    return;
  }

  // Lámpara (borde inferior)
  const nearLamp={x:lampPos.x,y:lampPos.y+lampPos.h-20,w:lampPos.w,h:20};
  if(aabb(getPlayerRect(),nearLamp)){ lampOn=!lampOn; return; }

  // Cama/planta mensajes opcionales
  const nearBed={x:bedPos.x,y:bedPos.y+20,w:bedPos.w-15,h:35};
  if(aabb(getPlayerRect(),nearBed)) return showToast('No es hora de cerrar el kiosko.');
}
document.getElementById('btn-act').addEventListener('click',e=>{e.preventDefault();handleAction()});
document.getElementById('btn-act').addEventListener('touchstart',e=>{e.preventDefault();handleAction()},{passive:false});

/* Salida */
async function startExit(){ if(exiting) return; exiting=true; try{doorSnd.currentTime=0;doorSnd.play();}catch(e){}
  try{await fadeOut(bgm,250)}catch(e){} sceneFade.classList.add('show'); setTimeout(()=>location.href="outside.html",450);
}
function fadeOut(a,ms){return new Promise(r=>{const v0=a.volume,n=Math.max(1,Math.floor(ms/16));let i=0;const it=setInterval(()=>{i++;a.volume=Math.max(0,v0*(1-i/n));if(i>=n){clearInterval(it);a.volume=0;r()}},16)})}

/* Update / Draw */
function update(dt){
  // Luz ambiente
  const target= lampOn ? DARK_NONE : DARK_OFF;
  darkness += (target - darkness) * Math.min(1, dt*8);

  // Velocidad por luz y chanclas
  const base=BASE_SPEED+(hasShoes?SHOES_BONUS:0);
  player.speed=(tvOn||lampOn)?base:base*DARK_MULT;
  if(!(tvOn||lampOn)){ if(!darkWarn){ showToast('Despacio, está oscuro.'); darkWarn=true; } } else darkWarn=false;

  if(dialogOpen||exiting||!hasStarted){ player.moving=false; player.frame=0; return; }

  const vx=(keys.left?-1:0)+(keys.right?1:0), vy=(keys.up?-1:0)+(keys.down?1:0);
  player.moving=!!(vx||vy);
  if(player.moving){
    player.dir=Math.abs(vx)>Math.abs(vy)?(vx<0?'left':'right'):(vy<0?'up':'down');
    const len=Math.hypot(vx,vy)||1, nx=(vx/len)*player.speed*dt, ny=(vy/len)*player.speed*dt;
    const nxp=player.x+nx, nyp=player.y+ny;
    if(!collides(nxp,nyp)){ player.x=nxp; player.y=nyp; }
    player.frameTime+=dt; if(player.frameTime>=0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else player.frame=0;

  // Recoger chanclas
  if(!hasShoes && sandalsImg){
    const p=getPlayerRect(), r={x:p.x+p.w*.25,y:p.y+p.h*.25,w:p.w*.5,h:p.h*.5};
    if(aabb(r,sandalsPos)){ hasShoes=true; try{pickup.currentTime=0;pickup.play()}catch(e){} }
  }
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // fondo
  ctx.drawImage(bgImg,bgRect.dx,bgRect.dy,bgRect.dw,bgRect.dh);

  // z-order por y (pies)
  const list=[];
  const timg=tvOn?tvOnImg:tvOffImg; list.push({y:tvPos.y+tvPos.h/2,draw:()=>ctx.drawImage(timg,tvPos.x,tvPos.y,tvPos.w,tvPos.h)});
  if(lampImg)   list.push({y:lampPos.y+lampPos.h/2,  draw:()=>ctx.drawImage(lampImg,  lampPos.x,  lampPos.y,  lampPos.w,  lampPos.h)});
  if(plant1Img) list.push({y:plantPos.y+plantPos.h/2,draw:()=>ctx.drawImage(plant1Img,plantPos.x,plantPos.y,plantPos.w,plantPos.h)});
  if(sofaImg)   list.push({y:sofaPos.y+sofaPos.h/2,  draw:()=>ctx.drawImage(sofaImg,  sofaPos.x,  sofaPos.y,  sofaPos.w,  sofaPos.h)});
  if(bedImg)    list.push({y:bedPos.y+bedPos.h/2,    draw:()=>ctx.drawImage(bedImg,   bedPos.x,   bedPos.y,   bedPos.w,   bedPos.h)});
  if(!hasShoes && sandalsImg) list.push({y:sandalsPos.y+sandalsPos.h/2, draw:()=>ctx.drawImage(sandalsImg,sandalsPos.x,sandalsPos.y,sandalsPos.w,sandalsPos.h)});

  // player
  const sw=SPRITES.size.w, sh=SPRITES.size.h, sc=SPRITES.scale, dw=Math.round(sw*sc), dh=Math.round(sh*sc);
  const img = sprites ? (player.moving?sprites.walk[player.dir][player.frame]:sprites.idle[player.dir][0]) : null;
  list.push({y:player.y,draw:()=>{ctx.fillStyle='rgba(0,0,0,.3)';ctx.beginPath();ctx.ellipse(Math.round(player.x),Math.round(player.y+dh/2-4),dw/2.5,dh/6,0,0,Math.PI*2);ctx.fill(); if(img) ctx.drawImage(img,0,0,sw,sh,Math.round(player.x-dw/2),Math.round(player.y-dh/2),dw,dh); }});

  list.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());

  // oscuridad + luces
  if(darkness>0){ ctx.fillStyle=`rgba(0,0,0,${darkness.toFixed(3)})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
  if(tvOn)   drawLight(tvPos.x+tvPos.w/2, tvPos.y+tvPos.h/2, 100, 0.35+Math.random()*0.05);
  if(lampOn) drawLight(lampPos.x+lampPos.w/2, lampPos.y+lampPos.h/3, 110, 0.30+Math.random()*0.04);
}
function drawLight(x,y,r,int){ const radius=r*(bgRect.dw/roomOriginal.w); ctx.save(); ctx.beginPath(); ctx.rect(bgRect.dx,bgRect.dy,bgRect.dw,bgRect.dh); ctx.clip();
  const g=ctx.createRadialGradient(x,y,0,x,y,radius); g.addColorStop(0,`rgba(255,255,200,${int})`); g.addColorStop(1,'rgba(255,255,200,0)');
  ctx.globalCompositeOperation='lighter'; ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,radius,0,Math.PI*2); ctx.fill(); ctx.restore(); ctx.globalCompositeOperation='source-over';
}

/* Loop */
function loop(t){ if(!loop.last) loop.last=t; const dt=Math.min(1/30,(t-loop.last)/1000); loop.last=t; update(dt); draw(); requestAnimationFrame(loop); }

/* Init */
async function init(){
  const [bg,plant,sofa,tvOnI,tvOffI,bed,shoes,lamp,spr] = await Promise.all([
    loadImage(BACKGROUND), loadImage(PLANT1_IMG), loadImage(SOFA_IMG), loadImage(TVON_IMG), loadImage(TVOFF_IMG),
    loadImage(BED_IMG), loadImage(SANDALS_IMG), loadImage(LAMP_IMG), preloadSprites(SPRITES)
  ]);
  bgImg=bg; plant1Img=plant; sofaImg=sofa; tvOnImg=tvOnI; tvOffImg=tvOffI; bedImg=bed; sandalsImg=shoes; lampImg=lamp; sprites=spr;
  resizeCanvas();
  requestAnimationFrame(loop);
  bootMask.classList.add('hidden');
  setTimeout(()=>pressStart.classList.add('show'),80);
}
init();

/* START (banner) + Acción */
pressStart.addEventListener('click', startGame);
function startGame(){ if(hasStarted) return; hasStarted=true; pressStart.classList.add('hide'); try{bgm.currentTime=0; bgm.play().catch(()=>{})}catch(e){} setTimeout(()=>openDialog(),350); }
</script>
</body>
</html>