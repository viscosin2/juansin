<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Juansin 30th birthday - room</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  html, body { height:100%; margin:0; background:#111; display:flex; justify-content:center; align-items:center; }
  .gameboy { width:100%; max-width:500px; height:100%; background:#000; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.6); }
  .screen-container { flex:1; display:flex; justify-content:center; align-items:center; background:#0B0A21; border-radius:12px; padding:10px; }
  .screen { aspect-ratio:1/1; width:100%; background:#0B0A21; display:flex; justify-content:center; align-items:center; border-radius:8px; overflow:hidden; position:relative; box-shadow:inset 0 0 20px rgba(0,0,0,.6); }
  canvas { width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges; background:black; }

  .controls { height:40%; background:#0B0A21; display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:14px; box-sizing:border-box; }
  .dpad { display:grid; grid-template-columns:repeat(3,64px); grid-template-rows:repeat(3,64px); gap:0; justify-content:center; margin-left:12px; align-content:center; overflow:visible; }
  .img-btn,.img-act{ border:none; outline:none; padding:0; background:transparent; cursor:pointer; transition:transform .06s ease, filter .06s ease; -webkit-tap-highlight-color:transparent; }
  .img-btn{ width:64px; height:64px; filter:drop-shadow(0 3px 4px rgba(0,0,0,.85)); }
  .img-btn.arrow::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/arrow.PNG") center/contain no-repeat; image-rendering:pixelated; transform:rotate(var(--rot,0deg)) scale(1.28); transform-origin:center; }
  .btn-up{--rot:180deg} .btn-left{--rot:90deg} .btn-right{--rot:-90deg} .btn-down{--rot:0deg}
  .img-act{ width:120px; height:120px; filter:drop-shadow(0 5px 6px rgba(0,0,0,.85)); margin-top:45px; justify-self:center; }
  .img-act::before{ content:""; display:block; width:100%; height:100%; background:url("assets/ui/action_btn.PNG") center/contain no-repeat; image-rendering:pixelated; transform:scale(1.02); }
  .img-btn:active,.img-btn.pressed,.img-act:active,.img-act.pressed{ transform:scale(.95); filter:drop-shadow(0 2px 3px rgba(0,0,0,.7)) brightness(.9); }

  .toast{ position:absolute; top:19px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; font:600 12px/1 system-ui; padding:6px 10px; border-radius:8px; opacity:0; transition:opacity .2s ease; white-space:nowrap; pointer-events:none; z-index:5; }
  .toast.show{ opacity:1; }

  /* Diálogo */
  .dialog{ position:absolute; left:50%; bottom:10px; transform:translateX(-50%) scaleX(0); transform-origin:center bottom;
    width:calc(100% - 24px); max-width:460px; min-height:20px; box-sizing:border-box; padding:12px 16px 16px; display:flex; gap:10px; border-radius:10px;
    image-rendering:pixelated; z-index:6; transition:transform .22s ease; background:rgba(12,12,24,.9); border-top:2px solid #3cf; flex-direction:column; text-align:left; }
  .dialog.show{ transform:translateX(-50%) scaleX(1); }
  .dialog-name{ font-family:'Press Start 2P',system-ui; font-size:10px; color:#8df; margin-bottom:4px; text-shadow:0 1px 0 #000; }
  .dialog-text{ font-family:'VT323',monospace; font-size:18px; letter-spacing:1px; line-height:1.15; color:#E6F6FF; min-height:2.2em; }
  .dialog-hint{ margin-left:auto; color:#B8D7FF; font:600 12px/1 system-ui; opacity:0; transition:opacity .18s ease; }
  .dialog.ready .dialog-hint{ opacity:.9; }

  .banner{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:"Press Start 2P",monospace; font-size:12px; letter-spacing:1px; background:rgba(0,0,0,0); color:#E6D0A3; user-select:none; z-index:998; text-shadow:2px 2px 0 #0b2346; opacity:0; pointer-events:none; animation:blink 1.1s steps(2,end) infinite; }
  .banner.show{ opacity:1; pointer-events:auto; } .banner.hide{ display:none; }
  @keyframes blink{ 0%{opacity:0} 50%{opacity:1} 100%{opacity:0} }

  .boot-mask{ position:absolute; inset:0; background:#000; z-index:1000; opacity:1; transition:opacity .25s ease; }
  .boot-mask.hidden{ opacity:0; pointer-events:none; }
  .scene-fade{ position:absolute; inset:0; background:#000; opacity:0; pointer-events:none; z-index:999; transition:opacity .45s ease; }
  .scene-fade.show{ opacity:1; }
</style>
</head>
<body>

<div class="gameboy">
  <div class="screen-container">
    <div class="screen">
      <div id="bootMask" class="boot-mask"></div>
      <canvas id="game"></canvas>
      <div id="pressStart" class="banner">PRESS&nbsp;TO&nbsp;START</div>
      <div id="toast" class="toast"></div>
      <div id="sceneFade" class="scene-fade"></div>

      <div id="dialog" class="dialog">
        <div id="dialogName" class="dialog-name"></div>
        <div id="dialogText" class="dialog-text"></div>
        <div id="dialogHint" class="dialog-hint">→</div>
      </div>
    </div>
  </div>

  <!-- ✅ D-Pad y Acción DENTRO de .controls -->
  <div class="controls">
    <div class="dpad">
      <div></div>
      <button id="btn-up" class="img-btn arrow btn-up" aria-label="Arriba"></button>
      <div></div>
      <button id="btn-left" class="img-btn arrow btn-left" aria-label="Izquierda"></button>
      <div></div>
      <button id="btn-right" class="img-btn arrow btn-right" aria-label="Derecha"></button>
      <div></div>
      <button id="btn-down" class="img-btn arrow btn-down" aria-label="Abajo"></button>
      <div></div>
    </div>
    <button id="btn-act" class="img-act" aria-label="Acción"></button>
  </div>
</div>

<script>
/* ===== Guardas / Toast ===== */
const DEBUG=false;
window.onerror=(msg)=>{ const t=document.getElementById('toast'); t.textContent='Error: '+msg; t.classList.add('show'); };

/* ===== Config ===== */
const BASE_SPEED=200, SHOES_BONUS=30, DARK_MULTIPLIER=0.2, DARK_OFF=0.60, DARK_NONE=0.00;
const roomOriginal={w:512,h:350};
const BACKGROUND="assets/locations/room.png";

/* ===== Sprites ===== */
const SPRITES_NORMAL={ size:{w:36,h:40}, scale:0.9,
  idle:{down:["assets/juan_character/idle_down.png"], up:["assets/juan_character/idle_up.png"], left:["assets/juan_character/idle_left.png"], right:["assets/juan_character/idle_right.png"]},
  walk:{down:["assets/juan_character/walk_down_0.png","assets/juan_character/walk_down_1.png"],
        up:["assets/juan_character/walk_up_0.png","assets/juan_character/walk_up_1.png"],
        left:["assets/juan_character/walk_left_0.png","assets/juan_character/walk_left_1.png"],
        right:["assets/juan_character/walk_right_0.png","assets/juan_character/walk_right_1.png"]}
};
const SPRITES_SHOES={ size:{w:36,h:40}, scale:0.9,
  idle:{down:["assets/juan_character/idle_down_shoes.png"], up:["assets/juan_character/idle_up_shoes.png"], left:["assets/juan_character/idle_left_shoes.png"], right:["assets/juan_character/idle_right_shoes.png"]},
  walk:{down:["assets/juan_character/walk_down_0_shoes.png","assets/juan_character/walk_down_1_shoes.png"],
        up:["assets/juan_character/walk_up_0_shoes.png","assets/juan_character/walk_up_1_shoes.png"],
        left:["assets/juan_character/walk_left_0_shoes.png","assets/juan_character/walk_left_1_shoes.png"],
        right:["assets/juan_character/walk_right_0_shoes.png","assets/juan_character/walk_right_1_shoes.png"]}
};

/* ===== Audio ===== */
let bgMusic=new Audio("assets/sounds/ambient1.mp3"); bgMusic.loop=true; bgMusic.volume=.4;
const pickupSnd=new Audio("assets/sounds/pickup.mp3"); pickupSnd.volume=.7;
const doorSnd=new Audio("assets/sounds/door_clack.wav"); doorSnd.volume=.9;

/* ===== Imágenes objetos ===== */
const PLANT1_IMG="assets/objects/plant1.png", SOFA_IMG="assets/objects/sofa.png",
      TVON_IMG="assets/objects/tv_on.png", TVOFF_IMG="assets/objects/tv_off.png",
      BED_IMG="assets/objects/bed.png", SANDALS_IMG="assets/objects/shoes.png", LAMP_IMG="assets/objects/lamp.png";

/* ===== Estado global ===== */
let bgImg, plant1Img, sofaImg, tvOnImg, tvOffImg, bedImg, sandalsImg, lampImg;
let tvOn=true, tvAlreadyOff=false, lampOn=false;
let darkness=.60, darkWarnShown=false, hasShoes=false, exiting=false, showDoorRect=false;
let gameState='intro', hasStarted=false, bgmHasEverPlayed=false;

/* ===== Canvas (una sola vez) ===== */
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
let bgRect={dx:0,dy:0,dw:0,dh:0}, scaleFactor=1;

/* ===== Bounds / objetos (base) ===== */
const boundsBase={x:20,y:85,w:465,h:235};
const obstaclesBase=[{x:230,y:25,w:70,h:50},{x:0,y:190,w:95,h:38},{x:0,y:260,w:40,h:21},{x:450,y:250,w:15,h:.5},{x:5,y:25,w:140,h:50},{x:195,y:170,w:170,h:.5}];
const sofaBase={x:170,y:75,w:220,h:180}, tvOnBase={x:205,y:35,w:125,h:90}, bedBase={x:3,y:155,w:120,h:130},
      plant1Base={x:3,y:230,w:60,h:90}, sandalsBase={x:55,y:270,w:50,h:50}, lampBase={x:100,y:18,w:90,h:100};
const doorBase={x:392,y:31,w:48,h:63}, doorInteractDepth=14, doorInteractBase={x:doorBase.x-8,y:doorBase.y+doorBase.h-doorInteractDepth,w:doorBase.w+16,h:doorInteractDepth};
const playerStartBase={x:260,y:150};

let bounds={}, obstacles=[], bedPos={}, sofaPos={}, plant1Pos={}, lampPos={}, tvPos={}, sandalsPos={}, tvInteractPos={}, lampInteractPos={}, doorPos={}, doorInteractPos={};

/* ===== Helpers ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const loadImage=(src)=>new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=()=>{console.warn('No carga',src); const ph=document.createElement('canvas'); ph.width=ph.height=1; res(ph);}; img.src=src; });
async function preloadSprites(map){ const r={idle:{},walk:{},size:map.size,scale:map.scale};
  for(const s of ['idle','walk']) for(const d of Object.keys(map[s])) r[s][d]=await Promise.all(map[s][d].map(loadImage)); return r; }
function aabb(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

/* ===== Escala posiciones ===== */
function updateScaledBounds(){
  const sc=scaleFactor, bx=bgRect.dx, by=bgRect.dy;
  bounds={x:bx+Math.round(boundsBase.x*sc), y:by+Math.round(boundsBase.y*sc), w:Math.round(boundsBase.w*sc), h:Math.round(boundsBase.h*sc)};
  obstacles=obstaclesBase.map(o=>({x:bx+Math.round(o.x*sc),y:by+Math.round(o.y*sc),w:Math.round(o.w*sc),h:Math.round(o.h*sc)}));
  sofaPos={x:bx+Math.round(sofaBase.x*sc),y:by+Math.round(sofaBase.y*sc),w:Math.round(sofaBase.w*sc),h:Math.round(sofaBase.h*sc)};
  tvPos  ={x:bx+Math.round(tvOnBase.x*sc), y:by+Math.round(tvOnBase.y*sc), w:Math.round(tvOnBase.w*sc), h:Math.round(tvOnBase.h*sc)};
  tvInteractPos={x:tvPos.x, y:tvPos.y+tvPos.h- Math.round(40*sc), w:tvPos.w, h:Math.round(2*sc)};
  bedPos ={x:bx+Math.round(bedBase.x*sc), y:by+Math.round(bedBase.y*sc), w:Math.round(bedBase.w*sc), h:Math.round(bedBase.h*sc)};
  plant1Pos={x:bx+Math.round(plant1Base.x*sc), y:by+Math.round(plant1Base.y*sc), w:Math.round(plant1Base.w*sc), h:Math.round(plant1Base.h*sc)};
  lampPos={x:bx+Math.round(lampBase.x*sc), y:by+Math.round(lampBase.y*sc), w:Math.round(lampBase.w*sc), h:Math.round(lampBase.h*sc)};
  lampInteractPos={x:lampPos.x, y:lampPos.y+lampPos.h- Math.round(18*sc), w:lampPos.w, h:Math.round(16*sc)};
  sandalsPos={x:bx+Math.round(sandalsBase.x*sc), y:by+Math.round(sandalsBase.y*sc), w:Math.round(sandalsBase.w*sc), h:Math.round(sandalsBase.h*sc)};
  doorPos={x:bx+Math.round(doorBase.x*sc), y:by+Math.round(doorBase.y*sc), w:Math.round(doorBase.w*sc), h:Math.round(doorBase.h*sc)};
  doorInteractPos={x:bx+Math.round(doorInteractBase.x*sc), y:by+Math.round(doorInteractBase.y*sc), w:Math.round(doorInteractBase.w*sc), h:Math.round(doorInteractBase.h*sc)};
}

/* ===== Resize ===== */
function resizeCanvas(){
  const screen=document.querySelector('.screen');
  canvas.width=screen.clientWidth; canvas.height=screen.clientHeight;
  if(bgImg){
    scaleFactor=Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
    bgRect.dw=roomOriginal.w*scaleFactor; bgRect.dh=roomOriginal.h*scaleFactor;
    bgRect.dx=(canvas.width-bgRect.dw)/2; bgRect.dy=(canvas.height-bgRect.dh)/2;
    updateScaledBounds();
    // Reposiciona player al punto base escalado solo si no ha arrancado
    if(!hasStarted){ player.x=bgRect.dx+Math.round(playerStartBase.x*scaleFactor); player.y=bgRect.dy+Math.round(playerStartBase.y*scaleFactor); }
  } else {
    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
  }
}
addEventListener('resize',resizeCanvas);

/* ===== Input: SOLO D-Pad ===== */
const keys={up:false,down:false,left:false,right:false};
function bindHold(btn,on,off){ const start=e=>{e.preventDefault();on();}; const end=e=>{e.preventDefault();off();};
  btn.addEventListener('touchstart',start,{passive:false}); btn.addEventListener('touchend',end,{passive:false}); btn.addEventListener('touchcancel',end,{passive:false});
  btn.addEventListener('mousedown',start); window.addEventListener('mouseup',end);
}
['up','down','left','right'].forEach(d=>{
  bindHold(document.getElementById('btn-'+d), ()=>keys[d]=true, ()=>keys[d]=false);
});
function pressVisual(el){ const on=()=>el.classList.add('pressed'), off=()=>el.classList.remove('pressed');
  el.addEventListener('mousedown',on); el.addEventListener('mouseup',off); el.addEventListener('mouseleave',off);
  el.addEventListener('touchstart',e=>{e.preventDefault();on();},{passive:false}); el.addEventListener('touchend',off,{passive:false}); el.addEventListener('touchcancel',off,{passive:false});
}
['btn-up','btn-down','btn-left','btn-right','btn-act'].forEach(id=>pressVisual(document.getElementById(id)));

/* ===== Player ===== */
const player={ x:0, y:0, speed:BASE_SPEED, dir:'up', moving:false, frame:0, frameTime:0 };

/* ===== Colisiones ===== */
function collides(x,y){
  const halfW=SPRITES_NORMAL.size.w*SPRITES_NORMAL.scale/2, halfH=SPRITES_NORMAL.size.h*SPRITES_NORMAL.scale/2;
  const px=x-halfW, py=y-halfH, pw=halfW*2, ph=halfH*2;
  if(x<bounds.x || x>bounds.x+bounds.w || y<bounds.y || y>bounds.y+bounds.h) return true;
  for(const o of obstacles){ if(px<o.x+o.w && px+pw>o.x && py<o.y+o.h && py+ph>o.y) return true; }
  return false;
}
function getPlayerRect(x=player.x,y=player.y){ const halfW=SPRITES_NORMAL.size.w*SPRITES_NORMAL.scale/2, halfH=SPRITES_NORMAL.size.h*SPRITES_NORMAL.scale/2; return {x:x-halfW,y:y-halfH,w:halfW*2,h:halfH*2}; }

/* ===== Toast ===== */
function showToast(msg,ms=2000){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(showToast._to); showToast._to=setTimeout(()=>t.classList.remove('show'),ms); }

/* ===== Diálogo muy simple ===== */
const dialogEl=document.getElementById('dialog'), dialogName=document.getElementById('dialogName'), dialogText=document.getElementById('dialogText'), dialogHint=document.getElementById('dialogHint');
let dialogOpen=false, isTyping=false, typingTimer=null, typingSpeed=22, dialogIndex=0;
const dialogScript=[{speaker:'Juan',text:'...'},{speaker:'Juan',text:'¡Toma combo!'},{speaker:'Juan',text:'Qué hambre tengo...'},{speaker:'Juan',text:'Me apetecen unos Tresor.'},{speaker:'Juan',text:'Voy al super.'}];
function openDialog(){ dialogEl.classList.add('show'); dialogEl.classList.remove('ready'); dialogOpen=true; dialogIndex=0; renderLine(true); }
function closeDialog(){ dialogEl.classList.remove('show','ready'); dialogOpen=false; }
function renderLine(type){ const L=dialogScript[dialogIndex]||{speaker:'',text:''}; dialogName.textContent=L.speaker||''; dialogText.textContent=''; dialogHint.style.opacity=0; type?typeText(L.text): (dialogText.textContent=L.text, dialogEl.classList.add('ready')); }
function typeText(text){ clearInterval(typingTimer); isTyping=true; let i=0; typingTimer=setInterval(()=>{ if(i<text.length){ dialogText.textContent+=text[i++]; } else { clearInterval(typingTimer); isTyping=false; dialogEl.classList.add('ready'); dialogHint.style.opacity=1; } }, typingSpeed); }
function advanceDialog(){ if(!dialogOpen) return; const full=dialogScript[dialogIndex]?.text||''; if(isTyping){ clearInterval(typingTimer); isTyping=false; dialogText.textContent=full; dialogEl.classList.add('ready'); dialogHint.style.opacity=1; return; } dialogIndex++; if(dialogIndex<dialogScript.length){ dialogEl.classList.remove('ready'); dialogHint.style.opacity=0; renderLine(true); } else closeDialog(); }

/* ===== Acción ===== */
function handleAction(){
  if(gameState==='intro'){ startGameFromBanner(); return; }
  if(dialogOpen){ advanceDialog(); return; }
  // Ejemplos de interacciones:
  const atDoor=aabb(getPlayerRect(),doorInteractPos);
  if(atDoor){ if(!hasShoes) return showToast('Ponte las chanclas.'); if(tvOn) return showToast('Apaga la tele.'); if(lampOn) return showToast('Apaga la luz.'); startExitSequence(); return; }
  const insideTV=aabb(getPlayerRect(), tvInteractPos);
  if(insideTV){ if(tvOn && !tvAlreadyOff){ tvOn=false; tvAlreadyOff=true; bgMusic.pause(); bgMusic.currentTime=0; } else if(!tvOn){ showToast('No más Tekken por hoy.'); } return; }
}

/* ===== Fade / salida ===== */
const sceneFade=document.getElementById('sceneFade'), NEXT_SCENE_URL="outside.html";
function fadeOutAudio(audio,ms=300){ return new Promise(res=>{ const start=audio.volume, steps=Math.max(1,Math.floor(ms/16)); let i=0; const it=setInterval(()=>{ i++; audio.volume=Math.max(0,start*(1-i/steps)); if(i>=steps){ clearInterval(it); audio.volume=0; res(); } },16); }); }
async function startExitSequence(){ if(exiting) return; exiting=true; showDoorRect=true; try{ doorSnd.currentTime=0; doorSnd.play(); }catch(e){} try{ await fadeOutAudio(bgMusic,250); bgMusic.pause(); bgMusic.currentTime=0; }catch(e){} sceneFade.classList.add('show'); setTimeout(()=>{ window.location.href=NEXT_SCENE_URL; },450); }

/* ===== Update & Draw ===== */
function update(dt){
  const DARK_TARGET = lampOn ? DARK_NONE : DARK_OFF;
  const fadeSpeed = 8; darkness += (DARK_TARGET - darkness) * Math.min(1, dt * fadeSpeed);

  const base = BASE_SPEED + (hasShoes ? SHOES_BONUS : 0);
  player.speed = (tvOn || lampOn) ? base : base * DARK_MULTIPLIER;

  if(dialogOpen || exiting || gameState==='intro'){ player.moving=false; player.frame=0; return; }

  if(!(tvOn||lampOn)){ if(!darkWarnShown){ showToast('Despacio, está oscuro.'); darkWarnShown=true; } } else darkWarnShown=false;

  const vx=(keys.left?-1:0)+(keys.right?1:0), vy=(keys.up?-1:0)+(keys.down?1:0);
  player.moving=!!(vx||vy);
  if(player.moving){
    player.dir = Math.abs(vx)>Math.abs(vy) ? (vx<0?'left':'right') : (vy<0?'up':'down');
    const len=Math.hypot(vx,vy)||1, nx=(vx/len)*player.speed*dt, ny=(vy/len)*player.speed*dt;
    const newX=player.x+nx, newY=player.y+ny;
    if(!collides(newX,newY)){ player.x=newX; player.y=newY; }
    player.frameTime+=dt; if(player.frameTime>=0.14){ player.frame=(player.frame+1)%2; player.frameTime=0; }
  } else player.frame=0;
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(bgImg){
    const s=Math.min(canvas.width/roomOriginal.w, canvas.height/roomOriginal.h);
    bgRect.dw=roomOriginal.w*s; bgRect.dh=roomOriginal.h*s; bgRect.dx=(canvas.width-bgRect.dw)/2; bgRect.dy=(canvas.height-bgRect.dh)/2;
    ctx.drawImage(bgImg, bgRect.dx, bgRect.dy, bgRect.dw, bgRect.dh);
  } else return;

  // objetos (orden por y) + player
  const list=[];
  // (pinta aquí tus imágenes si quieres; simplificado para el ejemplo)
  const sw=SPRITES_NORMAL.size.w, sh=SPRITES_NORMAL.size.h, sc=SPRITES_NORMAL.scale;
  const dw=Math.round(sw*sc), dh=Math.round(sh*sc);
  const img = (assets?.walk ? assets : sprites).walk?.[player.dir]?.[player.frame] || (assets?.idle ? assets : sprites).idle?.[player.dir]?.[0];

  list.push({ y: player.y, draw: ()=>{
    ctx.fillStyle='rgba(0,0,0,.3)'; ctx.beginPath(); ctx.ellipse(Math.round(player.x), Math.round(player.y+dh/2-4), dw/2.5, dh/6, 0,0,Math.PI*2); ctx.fill();
    ctx.drawImage(img, 0,0, sw,sh, Math.round(player.x-dw/2), Math.round(player.y-dh/2), dw, dh);
  }});

  list.sort((a,b)=>a.y-b.y).forEach(o=>o.draw());

  if(darkness>0){ ctx.fillStyle=`rgba(0,0,0,${darkness.toFixed(3)})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
}

/* ===== Loop ===== */
function loop(t){ if(!loop.last) loop.last=t; const dt=Math.min(1/30,(t-loop.last)/1000); loop.last=t; update(dt); draw(); requestAnimationFrame(loop); }

/* ===== Banner / inicio ===== */
const bootMask=document.getElementById('bootMask'), pressStartEl=document.getElementById('pressStart');
function ensureAudioCtxUnlocked(){ try{ if(!window.__ctx) window.__ctx=new (window.AudioContext||window.webkitAudioContext)(); if(window.__ctx.state==='suspended') window.__ctx.resume(); }catch(e){} }
function startBGM(){ if(bgmHasEverPlayed) return; bgMusic.volume=.4; bgMusic.currentTime=0; bgMusic.play().then(()=>bgmHasEverPlayed=true).catch(()=>{}); }
function startGameFromBanner(){ if(hasStarted) return; hasStarted=true; gameState='playing'; pressStartEl.classList.add('hide'); ensureAudioCtxUnlocked(); startBGM(); setTimeout(()=>openDialog(),400); }

/* ===== Acción (botón) ===== */
document.getElementById('btn-act').addEventListener('click', e=>{ e.preventDefault(); handleAction(); });
document.getElementById('btn-act').addEventListener('touchstart', e=>{ e.preventDefault(); handleAction(); }, {passive:false});

/* ===== Carga ===== */
let sprites, assets, assetsNormal, assetsShoes;
async function init(){
  const [bg, normalSet, shoesSet] = await Promise.all([ loadImage(BACKGROUND), preloadSprites(SPRITES_NORMAL), preloadSprites(SPRITES_SHOES) ]);
  bgImg=bg; assetsNormal=normalSet; assetsShoes=shoesSet; assets=assetsNormal;
  // posición inicial antes del primer resize
  resizeCanvas();
  requestAnimationFrame(loop);
  bootMask.classList.add('hidden');
  setTimeout(()=> pressStartEl.classList.add('show'), 80);
}
init();
</script>
</body>
</html>